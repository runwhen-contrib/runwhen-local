{"version":3,"file":"AzureVmDetector.js","sourceRoot":"","sources":["../../../src/detectors/AzureVmDetector.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Copyright The OpenTelemetry Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as http from 'http';\n\nimport { context, diag } from '@opentelemetry/api';\nimport { suppressTracing } from '@opentelemetry/core';\nimport {\n  ResourceDetector,\n  DetectedResource,\n  DetectedResourceAttributes,\n} from '@opentelemetry/resources';\nimport {\n  CLOUDPLATFORMVALUES_AZURE_VM,\n  CLOUDPROVIDERVALUES_AZURE,\n  SEMRESATTRS_CLOUD_PLATFORM,\n  SEMRESATTRS_CLOUD_PROVIDER,\n  SEMRESATTRS_CLOUD_REGION,\n  SEMRESATTRS_HOST_ID,\n  SEMRESATTRS_HOST_NAME,\n  SEMRESATTRS_HOST_TYPE,\n  SEMRESATTRS_OS_VERSION,\n} from '@opentelemetry/semantic-conventions';\nimport {\n  CLOUD_RESOURCE_ID_RESOURCE_ATTRIBUTE,\n  AZURE_VM_METADATA_HOST,\n  AZURE_VM_METADATA_PATH,\n  AZURE_VM_SCALE_SET_NAME_ATTRIBUTE,\n  AZURE_VM_SKU_ATTRIBUTE,\n  AzureVmMetadata,\n} from '../types';\n\n/**\n * The AzureVmDetector can be used to detect if a process is running in an Azure VM.\n * @returns a {@link Resource} populated with data about the environment or an empty Resource if detection fails.\n */\nclass AzureVmResourceDetector implements ResourceDetector {\n  detect(): DetectedResource {\n    const dataPromise = context.with(suppressTracing(context.active()), () =>\n      this.getAzureVmMetadata()\n    );\n\n    const attrNames = [\n      AZURE_VM_SCALE_SET_NAME_ATTRIBUTE,\n      AZURE_VM_SKU_ATTRIBUTE,\n      SEMRESATTRS_CLOUD_PLATFORM,\n      SEMRESATTRS_CLOUD_PROVIDER,\n      SEMRESATTRS_CLOUD_REGION,\n      CLOUD_RESOURCE_ID_RESOURCE_ATTRIBUTE,\n      SEMRESATTRS_HOST_ID,\n      SEMRESATTRS_HOST_NAME,\n      SEMRESATTRS_HOST_TYPE,\n      SEMRESATTRS_OS_VERSION,\n    ];\n\n    const attributes = {} as DetectedResourceAttributes;\n    attrNames.forEach(name => {\n      // Each resource attribute is determined asynchronously in _gatherData().\n      attributes[name] = dataPromise.then(data => data[name]);\n    });\n\n    return { attributes };\n  }\n\n  async getAzureVmMetadata(): Promise<DetectedResourceAttributes> {\n    try {\n      const options = {\n        host: AZURE_VM_METADATA_HOST,\n        path: AZURE_VM_METADATA_PATH,\n        method: 'GET',\n        timeout: 5000,\n        headers: {\n          Metadata: 'True',\n        },\n      };\n      const metadata: AzureVmMetadata = await new Promise((resolve, reject) => {\n        const timeoutId = setTimeout(() => {\n          req.destroy();\n          reject(new Error('Azure metadata service request timed out.'));\n        }, 1000);\n\n        const req = http.request(options, res => {\n          clearTimeout(timeoutId);\n          const { statusCode } = res;\n          res.setEncoding('utf8');\n          let rawData = '';\n          res.on('data', chunk => (rawData += chunk));\n          res.on('end', () => {\n            if (statusCode && statusCode >= 200 && statusCode < 300) {\n              try {\n                resolve(JSON.parse(rawData));\n              } catch (error) {\n                reject(error);\n              }\n            } else {\n              reject(\n                new Error('Failed to load page, status code: ' + statusCode)\n              );\n            }\n          });\n        });\n        req.on('error', err => {\n          clearTimeout(timeoutId);\n          reject(err);\n        });\n        req.end();\n      });\n\n      const attributes = {\n        [AZURE_VM_SCALE_SET_NAME_ATTRIBUTE]: metadata['vmScaleSetName'],\n        [AZURE_VM_SKU_ATTRIBUTE]: metadata['sku'],\n        [SEMRESATTRS_CLOUD_PLATFORM]: CLOUDPLATFORMVALUES_AZURE_VM,\n        [SEMRESATTRS_CLOUD_PROVIDER]: CLOUDPROVIDERVALUES_AZURE,\n        [SEMRESATTRS_CLOUD_REGION]: metadata['location'],\n        [CLOUD_RESOURCE_ID_RESOURCE_ATTRIBUTE]: metadata['resourceId'],\n        [SEMRESATTRS_HOST_ID]: metadata['vmId'],\n        [SEMRESATTRS_HOST_NAME]: metadata['name'],\n        [SEMRESATTRS_HOST_TYPE]: metadata['vmSize'],\n        [SEMRESATTRS_OS_VERSION]: metadata['version'],\n      };\n      return attributes;\n    } catch (err: any) {\n      diag.debug(\n        'AzureVmResourceDetector: not running in an Azure VM:',\n        err.message\n      );\n      return {};\n    }\n  }\n}\n\nexport const azureVmDetector = new AzureVmResourceDetector();\n"]}