{"version":3,"file":"AzureFunctionsDetector.js","sourceRoot":"","sources":["../../../src/detectors/AzureFunctionsDetector.ts"],"names":[],"mappings":";AAAA;;;;;;;;;;;;;;GAcG;;;AAGH,8EAU6C;AAC7C,oCAMkB;AAClB,oCAAgE;AAEhE,MAAM,kCAAkC,GAAG;IACzC,CAAC,+CAAwB,CAAC,EAAE,yBAAiB;IAC7C,CAAC,gDAAyB,CAAC,EAAE,2BAAmB;IAChD,CAAC,kDAA2B,CAAC,EAAE,2BAAmB;CACnD,CAAC;AAEF;;;GAGG;AACH,MAAM,sBAAsB;IAC1B,MAAM;QACJ,IAAI,UAAU,GAAG,EAAE,CAAC;QACpB,MAAM,WAAW,GAAG,OAAO,CAAC,GAAG,CAAC,yBAAiB,CAAC,CAAC;QAEnD;;;;WAIG;QACH,IAAI,WAAW,IAAI,IAAA,uBAAe,GAAE,EAAE;YACpC,MAAM,gBAAgB,GAAG,OAAO,CAAC,GAAG,CAAC,2BAAmB,CAAC,CAAC;YAC1D,MAAM,gBAAgB,GAAG,OAAO,CAAC,GAAG,CAAC,2BAAmB,CAAC,CAAC;YAE1D,UAAU,GAAG;gBACX,CAAC,iDAA0B,CAAC,EAAE,gDAAyB;gBACvD,CAAC,iDAA0B,CAAC,EAAE,0DAAmC;gBACjE,CAAC,+CAAwB,CAAC,EAAE,OAAO,CAAC,GAAG,CAAC,mBAAW,CAAC;gBACpD,CAAC,8CAAuB,CAAC,EAAE,OAAO,CAAC,GAAG;aACvC,CAAC;YAEF,IAAI,WAAW,EAAE;gBACf,UAAU,GAAG;oBACX,GAAG,UAAU;oBACb,CAAC,+CAAwB,CAAC,EAAE,WAAW;iBACxC,CAAC;aACH;YACD,IAAI,gBAAgB,EAAE;gBACpB,UAAU,GAAG;oBACX,GAAG,UAAU;oBACb,CAAC,gDAAyB,CAAC,EAAE,gBAAgB;iBAC9C,CAAC;aACH;YACD,IAAI,gBAAgB,EAAE;gBACpB,UAAU,GAAG;oBACX,GAAG,UAAU;oBACb,CAAC,kDAA2B,CAAC,EAAE,gBAAgB;iBAChD,CAAC;aACH;YACD,MAAM,gBAAgB,GAAG,IAAA,2BAAmB,EAAC,WAAW,CAAC,CAAC;YAC1D,IAAI,gBAAgB,EAAE;gBACpB,UAAU,GAAG;oBACX,GAAG,UAAU;oBACb,GAAG,EAAE,CAAC,4CAAoC,CAAC,EAAE,gBAAgB,EAAE;iBAChE,CAAC;aACH;YAED,KAAK,MAAM,CAAC,GAAG,EAAE,KAAK,CAAC,IAAI,MAAM,CAAC,OAAO,CACvC,kCAAkC,CACnC,EAAE;gBACD,MAAM,MAAM,GAAG,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;gBAClC,IAAI,MAAM,EAAE;oBACV,UAAU,GAAG,EAAE,GAAG,UAAU,EAAE,GAAG,EAAE,CAAC,GAAG,CAAC,EAAE,MAAM,EAAE,EAAE,CAAC;iBACtD;aACF;SACF;QACD,OAAO,EAAE,UAAU,EAAE,CAAC;IACxB,CAAC;CACF;AAEY,QAAA,sBAAsB,GAAG,IAAI,sBAAsB,EAAE,CAAC","sourcesContent":["/*\n * Copyright The OpenTelemetry Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ResourceDetector, DetectedResource } from '@opentelemetry/resources';\nimport {\n  SEMRESATTRS_FAAS_MAX_MEMORY,\n  SEMRESATTRS_FAAS_INSTANCE,\n  SEMRESATTRS_CLOUD_PROVIDER,\n  SEMRESATTRS_CLOUD_PLATFORM,\n  SEMRESATTRS_CLOUD_REGION,\n  CLOUDPROVIDERVALUES_AZURE,\n  CLOUDPLATFORMVALUES_AZURE_FUNCTIONS,\n  SEMRESATTRS_SERVICE_NAME,\n  SEMRESATTRS_PROCESS_PID,\n} from '@opentelemetry/semantic-conventions';\nimport {\n  WEBSITE_SITE_NAME,\n  WEBSITE_INSTANCE_ID,\n  FUNCTIONS_MEM_LIMIT,\n  REGION_NAME,\n  CLOUD_RESOURCE_ID_RESOURCE_ATTRIBUTE,\n} from '../types';\nimport { getAzureResourceUri, isAzureFunction } from '../utils';\n\nconst AZURE_FUNCTIONS_ATTRIBUTE_ENV_VARS = {\n  [SEMRESATTRS_SERVICE_NAME]: WEBSITE_SITE_NAME,\n  [SEMRESATTRS_FAAS_INSTANCE]: WEBSITE_INSTANCE_ID,\n  [SEMRESATTRS_FAAS_MAX_MEMORY]: FUNCTIONS_MEM_LIMIT,\n};\n\n/**\n * The AzureFunctionsDetector can be used to detect if a process is running in Azure Functions\n * @returns a {@link Resource} populated with data about the environment or an empty Resource if detection fails.\n */\nclass AzureFunctionsDetector implements ResourceDetector {\n  detect(): DetectedResource {\n    let attributes = {};\n    const serviceName = process.env[WEBSITE_SITE_NAME];\n\n    /**\n     * Checks that we are operating within an Azure Function using the function version since WEBSITE_SITE_NAME\n     * will exist in Azure App Service as well and detectors should be mutually exclusive.\n     * If the function version is not present, we check for the website sku to determine if it is a function.\n     */\n    if (serviceName && isAzureFunction()) {\n      const functionInstance = process.env[WEBSITE_INSTANCE_ID];\n      const functionMemLimit = process.env[FUNCTIONS_MEM_LIMIT];\n\n      attributes = {\n        [SEMRESATTRS_CLOUD_PROVIDER]: CLOUDPROVIDERVALUES_AZURE,\n        [SEMRESATTRS_CLOUD_PLATFORM]: CLOUDPLATFORMVALUES_AZURE_FUNCTIONS,\n        [SEMRESATTRS_CLOUD_REGION]: process.env[REGION_NAME],\n        [SEMRESATTRS_PROCESS_PID]: process.pid,\n      };\n\n      if (serviceName) {\n        attributes = {\n          ...attributes,\n          [SEMRESATTRS_SERVICE_NAME]: serviceName,\n        };\n      }\n      if (functionInstance) {\n        attributes = {\n          ...attributes,\n          [SEMRESATTRS_FAAS_INSTANCE]: functionInstance,\n        };\n      }\n      if (functionMemLimit) {\n        attributes = {\n          ...attributes,\n          [SEMRESATTRS_FAAS_MAX_MEMORY]: functionMemLimit,\n        };\n      }\n      const azureResourceUri = getAzureResourceUri(serviceName);\n      if (azureResourceUri) {\n        attributes = {\n          ...attributes,\n          ...{ [CLOUD_RESOURCE_ID_RESOURCE_ATTRIBUTE]: azureResourceUri },\n        };\n      }\n\n      for (const [key, value] of Object.entries(\n        AZURE_FUNCTIONS_ATTRIBUTE_ENV_VARS\n      )) {\n        const envVar = process.env[value];\n        if (envVar) {\n          attributes = { ...attributes, ...{ [key]: envVar } };\n        }\n      }\n    }\n    return { attributes };\n  }\n}\n\nexport const azureFunctionsDetector = new AzureFunctionsDetector();\n"]}