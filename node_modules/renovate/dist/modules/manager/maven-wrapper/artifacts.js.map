{"version":3,"file":"artifacts.js","sourceRoot":"","sources":["../../../../lib/modules/manager/maven-wrapper/artifacts.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Stats } from 'node:fs';\nimport os from 'node:os';\nimport is from '@sindresorhus/is';\nimport { dirname, join } from 'upath';\nimport { GlobalConfig } from '../../../config/global';\nimport { logger } from '../../../logger';\nimport { exec } from '../../../util/exec';\nimport type { ExecOptions, ExtraEnv } from '../../../util/exec/types';\nimport { chmodLocalFile, readLocalFile, statLocalFile } from '../../../util/fs';\nimport { getRepoStatus } from '../../../util/git';\nimport type { StatusResult } from '../../../util/git/types';\nimport { regEx } from '../../../util/regex';\nimport mavenVersioning from '../../versioning/maven';\nimport type {\n  PackageDependency,\n  UpdateArtifact,\n  UpdateArtifactsConfig,\n  UpdateArtifactsResult,\n} from '../types';\n\nconst DEFAULT_MAVEN_REPO_URL = 'https://repo.maven.apache.org/maven2';\ninterface MavenWrapperPaths {\n  wrapperExecutableFileName: string;\n  localProjectDir: string;\n  wrapperFullyQualifiedPath: string;\n}\n\nasync function addIfUpdated(\n  status: StatusResult,\n  fileProjectPath: string,\n): Promise<UpdateArtifactsResult | null> {\n  if (status.modified.includes(fileProjectPath)) {\n    return {\n      file: {\n        type: 'addition',\n        path: fileProjectPath,\n        contents: await readLocalFile(fileProjectPath),\n      },\n    };\n  }\n  return null;\n}\n\nexport async function updateArtifacts({\n  packageFileName,\n  newPackageFileContent,\n  updatedDeps,\n  config,\n}: UpdateArtifact): Promise<UpdateArtifactsResult[] | null> {\n  try {\n    logger.debug({ updatedDeps }, 'maven-wrapper.updateArtifacts()');\n\n    if (!updatedDeps.some((dep) => dep.depName === 'maven-wrapper')) {\n      logger.info(\n        'Maven wrapper version not updated - skipping Artifacts update',\n      );\n      return null;\n    }\n\n    const cmd = await createWrapperCommand(packageFileName);\n\n    if (!cmd) {\n      logger.info('No mvnw found - skipping Artifacts update');\n      return null;\n    }\n\n    const extraEnv = getExtraEnvOptions(updatedDeps);\n    await executeWrapperCommand(cmd, config, packageFileName, extraEnv);\n\n    const status = await getRepoStatus();\n    const artifactFileNames = [\n      '.mvn/wrapper/maven-wrapper.properties',\n      '.mvn/wrapper/maven-wrapper.jar',\n      '.mvn/wrapper/MavenWrapperDownloader.java',\n      'mvnw',\n      'mvnw.cmd',\n    ].map(\n      (filename) =>\n        packageFileName.replace('.mvn/wrapper/maven-wrapper.properties', '') +\n        filename,\n    );\n    const updateArtifactsResult = (\n      await getUpdatedArtifacts(status, artifactFileNames)\n    ).filter(is.truthy);\n\n    logger.debug(\n      { files: updateArtifactsResult.map((r) => r.file?.path) },\n      `Returning updated maven-wrapper files`,\n    );\n    return updateArtifactsResult;\n  } catch (err) {\n    logger.debug({ err }, 'Error setting new Maven Wrapper release value');\n    return [\n      {\n        artifactError: {\n          lockFile: packageFileName,\n          stderr: err.message,\n        },\n      },\n    ];\n  }\n}\n\nasync function getUpdatedArtifacts(\n  status: StatusResult,\n  artifactFileNames: string[],\n): Promise<UpdateArtifactsResult[]> {\n  const updatedResults: UpdateArtifactsResult[] = [];\n  for (const artifactFileName of artifactFileNames) {\n    const updatedResult = await addIfUpdated(status, artifactFileName);\n    if (updatedResult !== null) {\n      updatedResults.push(updatedResult);\n    }\n  }\n  return updatedResults;\n}\n\n/**\n * Find compatible java version for maven.\n * see https://maven.apache.org/developers/compatibility-plan.html\n * @param mavenWrapperVersion current maven version\n * @returns A Java semver range\n */\nexport function getJavaConstraint(\n  mavenWrapperVersion: string | null | undefined,\n): string | null {\n  const major = mavenWrapperVersion\n    ? mavenVersioning.getMajor(mavenWrapperVersion)\n    : null;\n\n  if (major && major >= 3) {\n    return '^17.0.0';\n  }\n\n  return '^8.0.0';\n}\n\nasync function executeWrapperCommand(\n  cmd: string,\n  config: UpdateArtifactsConfig,\n  packageFileName: string,\n  extraEnv: ExtraEnv,\n): Promise<void> {\n  logger.debug(`Updating maven wrapper: \"${cmd}\"`);\n  const { wrapperFullyQualifiedPath } = getMavenPaths(packageFileName);\n\n  const execOptions: ExecOptions = {\n    cwdFile: wrapperFullyQualifiedPath,\n    docker: {},\n    extraEnv,\n    toolConstraints: [\n      {\n        toolName: 'java',\n        constraint:\n          config.constraints?.java ?? getJavaConstraint(config.currentValue),\n      },\n    ],\n  };\n\n  try {\n    await exec(cmd, execOptions);\n  } catch (err) {\n    logger.error({ err }, 'Error executing maven wrapper update command.');\n    throw err;\n  }\n}\n\nfunction getExtraEnvOptions(deps: PackageDependency[]): ExtraEnv {\n  const customMavenWrapperUrl = getCustomMavenWrapperRepoUrl(deps);\n  if (customMavenWrapperUrl) {\n    return { MVNW_REPOURL: customMavenWrapperUrl };\n  }\n  return {};\n}\n\nfunction getCustomMavenWrapperRepoUrl(\n  deps: PackageDependency[],\n): string | null {\n  const replaceString = deps.find(\n    (dep) => dep.depName === 'maven-wrapper',\n  )?.replaceString;\n\n  if (!replaceString) {\n    return null;\n  }\n\n  const match = regEx(/^(.*?)\\/org\\/apache\\/maven\\/wrapper\\//).exec(\n    replaceString,\n  );\n\n  if (!match) {\n    return null;\n  }\n\n  return match[1] === DEFAULT_MAVEN_REPO_URL ? null : match[1];\n}\n\nasync function createWrapperCommand(\n  packageFileName: string,\n): Promise<string | null> {\n  const {\n    wrapperExecutableFileName,\n    localProjectDir,\n    wrapperFullyQualifiedPath,\n  } = getMavenPaths(packageFileName);\n\n  return await prepareCommand(\n    wrapperExecutableFileName,\n    localProjectDir,\n    await statLocalFile(wrapperFullyQualifiedPath),\n    'wrapper:wrapper',\n  );\n}\n\nfunction mavenWrapperFileName(): string {\n  if (\n    os.platform() === 'win32' &&\n    GlobalConfig.get('binarySource') !== 'docker'\n  ) {\n    return 'mvnw.cmd';\n  }\n  return './mvnw';\n}\n\nfunction getMavenPaths(packageFileName: string): MavenWrapperPaths {\n  const wrapperExecutableFileName = mavenWrapperFileName();\n  const localProjectDir = join(dirname(packageFileName), '../../');\n  const wrapperFullyQualifiedPath = join(\n    localProjectDir,\n    wrapperExecutableFileName,\n  );\n  return {\n    wrapperExecutableFileName,\n    localProjectDir,\n    wrapperFullyQualifiedPath,\n  };\n}\n\nasync function prepareCommand(\n  fileName: string,\n  cwd: string | undefined,\n  pathFileStats: Stats | null,\n  args: string | null,\n): Promise<string | null> {\n  // istanbul ignore if\n  if (pathFileStats?.isFile() === true) {\n    // if the file is not executable by others\n    if (os.platform() !== 'win32' && (pathFileStats.mode & 0o1) === 0) {\n      // add the execution permission to the owner, group and others\n      logger.warn('Maven wrapper is missing the executable bit');\n      await chmodLocalFile(join(cwd, fileName), pathFileStats.mode | 0o111);\n    }\n    if (args === null) {\n      return fileName;\n    }\n    return `${fileName} ${args}`;\n  }\n  return null;\n}\n"]}