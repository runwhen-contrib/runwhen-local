{"version":3,"file":"extract.js","sourceRoot":"","sources":["../../../../lib/modules/manager/buildkite/extract.ts"],"names":[],"mappings":"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","sourcesContent":["import { logger } from '../../../logger';\nimport type { SkipReason } from '../../../types';\nimport { newlineRegex, regEx } from '../../../util/regex';\nimport { BitbucketTagsDatasource } from '../../datasource/bitbucket-tags';\nimport { GithubTagsDatasource } from '../../datasource/github-tags';\nimport { isVersion } from '../../versioning/semver';\nimport type { PackageDependency, PackageFileContent } from '../types';\n\nexport function extractPackageFile(\n  content: string,\n  packageFile?: string,\n): PackageFileContent | null {\n  const deps: PackageDependency[] = [];\n  try {\n    const lines = content.split(newlineRegex);\n\n    for (const line of lines) {\n      // Search each line for plugin names\n      const depLineMatch = regEx(\n        /^\\s*(?:-\\s+(?:\\?\\s+)?)?['\"]?(?<depName>[^#\\s'\"]+)#(?<currentValue>[^:'\"]+)['\"]?/,\n      ).exec(line);\n\n      if (depLineMatch?.groups) {\n        const { depName, currentValue } = depLineMatch.groups;\n        logger.trace('depLineMatch');\n        let skipReason: SkipReason | undefined;\n        let repo: string | undefined;\n        logger.trace(`Found Buildkite plugin ${depName}`);\n        // Plugins may simply be git repos. If so, we need to parse out the registry.\n        const gitPluginMatch = regEx(\n          /(ssh:\\/\\/git@|https:\\/\\/)(?<registry>[^/]+)\\/(?<gitPluginName>.*)/,\n        ).exec(depName);\n        if (gitPluginMatch?.groups) {\n          logger.debug('Examining git plugin');\n          const { registry, gitPluginName } = gitPluginMatch.groups;\n          const gitDepName = gitPluginName.replace(regEx('\\\\.git$'), '');\n\n          let datasource: string = GithubTagsDatasource.id;\n          if (registry === 'bitbucket.org') {\n            datasource = BitbucketTagsDatasource.id;\n          }\n          const dep: PackageDependency = {\n            depName: gitDepName,\n            currentValue,\n            registryUrls: ['https://' + registry],\n            datasource,\n          };\n          deps.push(dep);\n          continue;\n        } else if (isVersion(currentValue)) {\n          const splitName = depName.split('/');\n          if (splitName.length === 1) {\n            repo = `buildkite-plugins/${depName}-buildkite-plugin`;\n          } else if (splitName.length === 2) {\n            repo = `${depName}-buildkite-plugin`;\n          } else {\n            logger.warn(\n              { dependency: depName },\n              'Something is wrong with Buildkite plugin name',\n            );\n            skipReason = 'invalid-dependency-specification';\n          }\n        } else {\n          logger.debug(\n            `Skipping non-pinned Buildkite current version ${currentValue}`,\n          );\n          skipReason = 'invalid-version';\n        }\n        const dep: PackageDependency = {\n          depName,\n          currentValue,\n          skipReason,\n        };\n        if (repo) {\n          dep.datasource = GithubTagsDatasource.id;\n          dep.packageName = repo;\n        }\n        deps.push(dep);\n      }\n    }\n  } catch (err) /* istanbul ignore next */ {\n    logger.debug({ err, packageFile }, 'Error extracting Buildkite plugins');\n  }\n\n  if (!deps.length) {\n    return null;\n  }\n\n  return { deps };\n}\n"]}