{"version":3,"file":"artifacts-extra.js","sourceRoot":"","sources":["../../../../lib/modules/manager/gomod/artifacts-extra.ts"],"names":[],"mappings":"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","sourcesContent":["import { diffLines } from 'diff';\nimport markdownTable from 'markdown-table';\nimport { parseLine } from './line-parser';\nimport type { ExtraDep } from './types';\n\nexport function getExtraDeps(\n  goModBefore: string,\n  goModAfter: string,\n  excludeDeps: string[],\n): ExtraDep[] {\n  const result: ExtraDep[] = [];\n\n  const diff = diffLines(goModBefore, goModAfter, {\n    newlineIsToken: true,\n  });\n\n  const addDeps: Record<string, string> = {};\n  const rmDeps: Record<string, string> = {};\n  for (const { added, removed, value } of diff) {\n    if (!added && !removed) {\n      continue;\n    }\n\n    const res = parseLine(value);\n    if (!res) {\n      continue;\n    }\n\n    const { depName, depType, currentValue } = res;\n    if (!depName || !currentValue) {\n      continue;\n    }\n\n    let expandedDepName = depName;\n    // NOTE: Right now the only special depType we care about is 'toolchain' because the table\n    // rendering prior to this change was ambiguous with regards to go version vs toolchain\n    // version updates.\n    if (depType === 'toolchain') {\n      expandedDepName = `${depName} (${depType})`;\n    }\n\n    if (added) {\n      addDeps[expandedDepName] = currentValue;\n    } else {\n      rmDeps[expandedDepName] = currentValue;\n    }\n  }\n\n  for (const [depName, currentValue] of Object.entries(rmDeps)) {\n    if (excludeDeps.includes(depName)) {\n      continue;\n    }\n\n    const newValue = addDeps[depName];\n    if (newValue) {\n      result.push({\n        depName,\n        currentValue,\n        newValue,\n      });\n    }\n  }\n\n  return result;\n}\n\nexport function extraDepsTable(extraDeps: ExtraDep[]): string {\n  const tableLines: string[][] = [];\n\n  tableLines.push(['**Package**', '**Change**']);\n\n  for (const { depName, currentValue, newValue } of extraDeps) {\n    const depNameQuoted = `\\`${depName}\\``;\n    const versionChangeQuoted = `\\`${currentValue}\\` -> \\`${newValue}\\``;\n    tableLines.push([depNameQuoted, versionChangeQuoted]);\n  }\n\n  return markdownTable(tableLines, {\n    align: ['l', 'l'],\n  });\n}\n\nexport function getExtraDepsNotice(\n  goModBefore: string | null,\n  goModAfter: string | null,\n  excludeDeps: string[],\n): string | null {\n  if (!goModBefore || !goModAfter) {\n    return null;\n  }\n\n  const extraDeps = getExtraDeps(goModBefore, goModAfter, excludeDeps);\n  if (extraDeps.length === 0) {\n    return null;\n  }\n\n  const noticeLines: string[] = [\n    'In order to perform the update(s) described in the table above, Renovate ran the `go get` command, which resulted in the following additional change(s):',\n    '\\n',\n  ];\n\n  const goUpdated = extraDeps.some(({ depName }) => depName === 'go');\n  const toolchainUpdated = extraDeps.some(\n    ({ depName }) => depName === 'go (toolchain)',\n  );\n  const otherDepsCount =\n    extraDeps.length - (goUpdated ? 1 : 0) - (toolchainUpdated ? 1 : 0);\n\n  if (otherDepsCount === 1) {\n    noticeLines.push(`- ${otherDepsCount} additional dependency was updated`);\n  } else if (otherDepsCount > 1) {\n    noticeLines.push(\n      `- ${otherDepsCount} additional dependencies were updated`,\n    );\n  }\n\n  if (goUpdated) {\n    noticeLines.push(\n      '- The `go` directive was updated for compatibility reasons',\n    );\n  }\n\n  noticeLines.push('\\n');\n  noticeLines.push('Details:');\n  noticeLines.push('\\n');\n  noticeLines.push(extraDepsTable(extraDeps));\n\n  return noticeLines.join('\\n');\n}\n"]}