{"version":3,"file":"artifacts.js","sourceRoot":"","sources":["../../../../lib/modules/manager/vendir/artifacts.ts"],"names":[],"mappings":"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","sourcesContent":["import { TEMPORARY_ERROR } from '../../../constants/error-messages';\nimport { logger } from '../../../logger';\nimport { exec } from '../../../util/exec';\nimport type { ExecOptions } from '../../../util/exec/types';\nimport {\n  getParentDir,\n  getSiblingFileName,\n  readLocalFile,\n  writeLocalFile,\n} from '../../../util/fs';\nimport { getRepoStatus } from '../../../util/git';\nimport type { UpdateArtifact, UpdateArtifactsResult } from '../types';\n\nexport async function updateArtifacts({\n  packageFileName,\n  updatedDeps,\n  newPackageFileContent,\n  config,\n}: UpdateArtifact): Promise<UpdateArtifactsResult[] | null> {\n  logger.debug(`vendir.updateArtifacts(${packageFileName})`);\n\n  const lockFileName = getSiblingFileName(packageFileName, 'vendir.lock.yml');\n  if (!lockFileName) {\n    logger.warn('No vendir.lock.yml found');\n    return null;\n  }\n  const existingLockFileContent = await readLocalFile(lockFileName, 'utf8');\n  if (!existingLockFileContent) {\n    logger.warn('Empty vendir.lock.yml found');\n    return null;\n  }\n\n  try {\n    await writeLocalFile(packageFileName, newPackageFileContent);\n    logger.debug('Updating Vendir artifacts');\n    const execOptions: ExecOptions = {\n      cwdFile: packageFileName,\n      docker: {},\n      toolConstraints: [\n        { toolName: 'vendir', constraint: config.constraints?.vendir },\n        { toolName: 'helm', constraint: config.constraints?.helm },\n      ],\n    };\n\n    await exec(`vendir sync`, execOptions);\n\n    logger.debug('Returning updated Vendir artifacts');\n\n    const fileChanges: UpdateArtifactsResult[] = [];\n\n    const newVendirLockContent = await readLocalFile(lockFileName, 'utf8');\n    const isLockFileChanged = existingLockFileContent !== newVendirLockContent;\n    if (isLockFileChanged) {\n      fileChanges.push({\n        file: {\n          type: 'addition',\n          path: lockFileName,\n          contents: newVendirLockContent,\n        },\n      });\n    }\n\n    // add modified vendir archives to artifacts\n    logger.debug(\"Adding Sync'd files to git\");\n    // Files must be in the vendor path to get added\n    const vendorDir = getParentDir(packageFileName);\n    const status = await getRepoStatus();\n    if (status) {\n      const modifiedFiles = status.modified ?? [];\n      const notAddedFiles = status.not_added;\n      const deletedFiles = status.deleted ?? [];\n\n      for (const f of modifiedFiles.concat(notAddedFiles)) {\n        const isFileInVendorDir = f.startsWith(vendorDir);\n        if (vendorDir || isFileInVendorDir) {\n          fileChanges.push({\n            file: {\n              type: 'addition',\n              path: f,\n              contents: await readLocalFile(f),\n            },\n          });\n        }\n      }\n\n      for (const f of deletedFiles) {\n        fileChanges.push({\n          file: {\n            type: 'deletion',\n            path: f,\n          },\n        });\n      }\n    } else {\n      logger.error('Failed to get git status');\n    }\n\n    return fileChanges.length ? fileChanges : null;\n  } catch (err) {\n    if (err.message === TEMPORARY_ERROR) {\n      throw err;\n    }\n    logger.debug({ err }, 'Failed to update Vendir lock file');\n    return [\n      {\n        artifactError: {\n          lockFile: lockFileName,\n          stderr: err.message,\n        },\n      },\n    ];\n  }\n}\n"]}