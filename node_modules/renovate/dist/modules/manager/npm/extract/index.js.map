{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../../lib/modules/manager/npm/extract/index.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { GlobalConfig } from '../../../../config/global';\nimport { logger } from '../../../../logger';\nimport {\n  findLocalSiblingOrParent,\n  getSiblingFileName,\n  readLocalFile,\n} from '../../../../util/fs';\nimport { newlineRegex, regEx } from '../../../../util/regex';\nimport { NpmDatasource } from '../../../datasource/npm';\n\nimport type {\n  ExtractConfig,\n  PackageFile,\n  PackageFileContent,\n} from '../../types';\nimport type { NpmLockFiles, NpmManagerData } from '../types';\nimport { getExtractedConstraints } from './common/dependency';\nimport { extractPackageJson } from './common/package-file';\nimport { extractPnpmWorkspaceFile, tryParsePnpmWorkspaceYaml } from './pnpm';\nimport { postExtract } from './post';\nimport type { NpmPackage } from './types';\nimport { isZeroInstall } from './yarn';\nimport type { YarnConfig } from './yarnrc';\nimport {\n  loadConfigFromLegacyYarnrc,\n  loadConfigFromYarnrcYml,\n  resolveRegistryUrl,\n} from './yarnrc';\n\nfunction hasMultipleLockFiles(lockFiles: NpmLockFiles): boolean {\n  return Object.values(lockFiles).filter(is.string).length > 1;\n}\n\nexport async function extractPackageFile(\n  content: string,\n  packageFile: string,\n  config: ExtractConfig,\n): Promise<PackageFileContent<NpmManagerData> | null> {\n  logger.trace(`npm.extractPackageFile(${packageFile})`);\n  logger.trace({ content });\n  let packageJson: NpmPackage;\n  try {\n    packageJson = JSON.parse(content);\n  } catch {\n    logger.debug({ packageFile }, `Invalid JSON`);\n    return null;\n  }\n\n  const res = extractPackageJson(packageJson, packageFile);\n  if (!res) {\n    return null;\n  }\n\n  let workspacesPackages: string[] | undefined;\n  if (is.array(packageJson.workspaces)) {\n    workspacesPackages = packageJson.workspaces;\n  } else {\n    workspacesPackages = packageJson.workspaces?.packages;\n  }\n\n  const lockFiles: NpmLockFiles = {\n    yarnLock: 'yarn.lock',\n    packageLock: 'package-lock.json',\n    shrinkwrapJson: 'npm-shrinkwrap.json',\n    pnpmShrinkwrap: 'pnpm-lock.yaml',\n  };\n\n  for (const [key, val] of Object.entries(lockFiles) as [\n    'yarnLock' | 'packageLock' | 'shrinkwrapJson' | 'pnpmShrinkwrap',\n    string,\n  ][]) {\n    const filePath = getSiblingFileName(packageFile, val);\n    if (await readLocalFile(filePath, 'utf8')) {\n      lockFiles[key] = filePath;\n    } else {\n      lockFiles[key] = undefined;\n    }\n  }\n  lockFiles.npmLock = lockFiles.packageLock ?? lockFiles.shrinkwrapJson;\n  delete lockFiles.packageLock;\n  delete lockFiles.shrinkwrapJson;\n\n  if (hasMultipleLockFiles(lockFiles)) {\n    logger.warn(\n      'Updating multiple npm lock files is deprecated and support will be removed in future versions.',\n    );\n  }\n\n  let npmrc: string | undefined;\n  const npmrcFileName = getSiblingFileName(packageFile, '.npmrc');\n  let repoNpmrc = await readLocalFile(npmrcFileName, 'utf8');\n  if (is.string(repoNpmrc)) {\n    if (is.string(config.npmrc) && !config.npmrcMerge) {\n      logger.debug(\n        { npmrcFileName },\n        'Repo .npmrc file is ignored due to config.npmrc with config.npmrcMerge=false',\n      );\n      npmrc = config.npmrc;\n    } else {\n      npmrc = config.npmrc ?? '';\n      if (npmrc.length) {\n        if (!npmrc.endsWith('\\n')) {\n          npmrc += '\\n';\n        }\n      }\n      if (repoNpmrc?.includes('package-lock')) {\n        logger.debug('Stripping package-lock setting from .npmrc');\n        repoNpmrc = repoNpmrc.replace(\n          regEx(/(^|\\n)package-lock.*?(\\n|$)/g),\n          '\\n',\n        );\n      }\n      if (repoNpmrc.includes('=${') && !GlobalConfig.get('exposeAllEnv')) {\n        logger.debug(\n          { npmrcFileName },\n          'Stripping .npmrc file of lines with variables',\n        );\n        repoNpmrc = repoNpmrc\n          .split(newlineRegex)\n          .filter((line) => !line.includes('=${'))\n          .join('\\n');\n      }\n      npmrc += repoNpmrc;\n    }\n  } else if (is.string(config.npmrc)) {\n    npmrc = config.npmrc;\n  }\n\n  const yarnrcYmlFileName = await findLocalSiblingOrParent(\n    packageFile,\n    '.yarnrc.yml',\n  );\n  const yarnZeroInstall = yarnrcYmlFileName\n    ? await isZeroInstall(yarnrcYmlFileName)\n    : false;\n\n  let yarnConfig: YarnConfig | null = null;\n  const repoYarnrcYml = yarnrcYmlFileName\n    ? await readLocalFile(yarnrcYmlFileName, 'utf8')\n    : null;\n  if (is.string(repoYarnrcYml) && repoYarnrcYml.trim().length > 0) {\n    yarnConfig = loadConfigFromYarnrcYml(repoYarnrcYml);\n  }\n\n  const legacyYarnrcFileName = await findLocalSiblingOrParent(\n    packageFile,\n    '.yarnrc',\n  );\n  const repoLegacyYarnrc = legacyYarnrcFileName\n    ? await readLocalFile(legacyYarnrcFileName, 'utf8')\n    : null;\n  if (is.string(repoLegacyYarnrc) && repoLegacyYarnrc.trim().length > 0) {\n    yarnConfig = loadConfigFromLegacyYarnrc(repoLegacyYarnrc);\n  }\n\n  if (res.deps.length === 0) {\n    logger.debug('Package file has no deps');\n    if (\n      !(\n        !!res.managerData?.packageJsonName ||\n        !!res.packageFileVersion ||\n        !!npmrc ||\n        workspacesPackages\n      )\n    ) {\n      logger.debug('Skipping file');\n      return null;\n    }\n  }\n  let skipInstalls = config.skipInstalls;\n  if (skipInstalls === null) {\n    const hasFancyRefs = !!res.deps.some(\n      (dep) =>\n        !!dep.currentValue?.startsWith('file:') ||\n        !!dep.currentValue?.startsWith('npm:'),\n    );\n    if ((hasFancyRefs && !!lockFiles.npmLock) || yarnZeroInstall) {\n      // https://github.com/npm/cli/issues/1432\n      // Explanation:\n      //  - npm install --package-lock-only is buggy for transitive deps in file: and npm: references\n      //  - So we set skipInstalls to false if file: or npm: refs are found *and* the user hasn't explicitly set the value already\n      //  - Also, do not skip install if Yarn zero-install is used\n      logger.debug('Automatically setting skipInstalls to false');\n      skipInstalls = false;\n    } else {\n      skipInstalls = true;\n    }\n  }\n\n  const extractedConstraints = getExtractedConstraints(res.deps);\n\n  if (yarnConfig) {\n    for (const dep of res.deps) {\n      if (dep.depName) {\n        const registryUrlFromYarnConfig = resolveRegistryUrl(\n          dep.packageName ?? dep.depName,\n          yarnConfig,\n        );\n        if (registryUrlFromYarnConfig && dep.datasource === NpmDatasource.id) {\n          dep.registryUrls = [registryUrlFromYarnConfig];\n        }\n      }\n    }\n  }\n\n  return {\n    ...res,\n    npmrc,\n    managerData: {\n      ...res.managerData,\n      ...lockFiles,\n      yarnZeroInstall,\n      hasPackageManager: is.nonEmptyStringAndNotWhitespace(\n        packageJson.packageManager,\n      ),\n      workspacesPackages,\n    },\n    skipInstalls,\n    extractedConstraints,\n  };\n}\n\nexport async function extractAllPackageFiles(\n  config: ExtractConfig,\n  packageFiles: string[],\n): Promise<PackageFile<NpmManagerData>[]> {\n  const npmFiles: PackageFile<NpmManagerData>[] = [];\n  for (const packageFile of packageFiles) {\n    const content = await readLocalFile(packageFile, 'utf8');\n    // istanbul ignore else\n    if (content) {\n      // pnpm workspace files are their own package file, defined via fileMatch.\n      // We duck-type the content here, to allow users to rename the file itself.\n      const parsedPnpmWorkspaceYaml = tryParsePnpmWorkspaceYaml(content);\n      if (parsedPnpmWorkspaceYaml.success) {\n        logger.trace(\n          { packageFile },\n          `Extracting file as a pnpm workspace YAML file`,\n        );\n        const deps = await extractPnpmWorkspaceFile(\n          parsedPnpmWorkspaceYaml.data,\n          packageFile,\n        );\n        if (deps) {\n          npmFiles.push({\n            ...deps,\n            packageFile,\n          });\n        }\n      } else {\n        logger.trace({ packageFile }, `Extracting as a package.json file`);\n        const deps = await extractPackageFile(content, packageFile, config);\n        if (deps) {\n          npmFiles.push({\n            ...deps,\n            packageFile,\n          });\n        }\n      }\n    } else {\n      logger.debug({ packageFile }, `No content found`);\n    }\n  }\n\n  await postExtract(npmFiles);\n  return npmFiles;\n}\n"]}