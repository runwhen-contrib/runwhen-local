{"version":3,"file":"locked-versions.js","sourceRoot":"","sources":["../../../../../../lib/modules/manager/npm/extract/post/locked-versions.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport semver from 'semver';\nimport { dirname, relative } from 'upath';\nimport { logger } from '../../../../../logger';\nimport type { PackageFile } from '../../../types';\nimport type { NpmManagerData } from '../../types';\nimport { getNpmLock } from '../npm';\nimport { getPnpmLock } from '../pnpm';\nimport type { LockFile } from '../types';\nimport { getYarnLock, getYarnVersionFromLock } from '../yarn';\n\nconst pnpmCatalogDepTypeRe = /pnpm\\.catalog\\.(?<version>.*)/;\n\nexport async function getLockedVersions(\n  packageFiles: PackageFile<NpmManagerData>[],\n): Promise<void> {\n  const lockFileCache: Record<string, LockFile> = {};\n  logger.debug('Finding locked versions');\n  for (const packageFile of packageFiles) {\n    const { managerData = {} } = packageFile;\n    const { yarnLock, npmLock, pnpmShrinkwrap } = managerData;\n    const lockFiles: string[] = [];\n    if (yarnLock) {\n      logger.trace('Found yarnLock');\n      lockFiles.push(yarnLock);\n      if (!lockFileCache[yarnLock]) {\n        logger.trace(`Retrieving/parsing ${yarnLock}`);\n        lockFileCache[yarnLock] = await getYarnLock(yarnLock);\n      }\n      const { isYarn1 } = lockFileCache[yarnLock];\n      let yarn: string | undefined;\n      if (!isYarn1 && !packageFile.extractedConstraints?.yarn) {\n        yarn = getYarnVersionFromLock(lockFileCache[yarnLock]);\n      }\n      if (yarn) {\n        packageFile.extractedConstraints ??= {};\n        packageFile.extractedConstraints.yarn = yarn;\n      }\n      for (const dep of packageFile.deps) {\n        dep.lockedVersion =\n          lockFileCache[yarnLock].lockedVersions?.[\n            // TODO: types (#22198)\n            `${dep.depName}@${dep.currentValue}`\n          ];\n        if (\n          (dep.depType === 'engines' || dep.depType === 'packageManager') &&\n          dep.depName === 'yarn' &&\n          !isYarn1\n        ) {\n          dep.packageName = '@yarnpkg/cli';\n        }\n      }\n    } else if (npmLock) {\n      logger.debug(`Found ${npmLock} for ${packageFile.packageFile}`);\n      lockFiles.push(npmLock);\n      if (!lockFileCache[npmLock]) {\n        logger.trace('Retrieving/parsing ' + npmLock);\n        const cache = await getNpmLock(npmLock);\n        // istanbul ignore if\n        if (!cache) {\n          logger.warn({ npmLock }, 'Npm: unable to get lockfile');\n          return;\n        }\n        lockFileCache[npmLock] = cache;\n      }\n\n      const { lockfileVersion } = lockFileCache[npmLock];\n      let npm: string | undefined;\n      if (lockfileVersion === 1) {\n        if (packageFile.extractedConstraints?.npm) {\n          // Add a <7 constraint if it's not already a fixed version\n          if (\n            semver.satisfies('6.14.18', packageFile.extractedConstraints.npm)\n          ) {\n            npm = packageFile.extractedConstraints.npm + ' <7';\n          }\n        } else {\n          npm = '<7';\n        }\n      } else if (lockfileVersion === 2) {\n        if (packageFile.extractedConstraints?.npm) {\n          // Add a <9 constraint if the latest 8.x is compatible\n          if (\n            semver.satisfies('8.19.3', packageFile.extractedConstraints.npm)\n          ) {\n            npm = packageFile.extractedConstraints.npm + ' <9';\n          }\n        } else {\n          npm = '<9';\n        }\n      } else if (lockfileVersion === 3) {\n        if (!packageFile.extractedConstraints?.npm) {\n          npm = '>=7';\n        }\n      } else {\n        logger.warn(\n          { lockfileVersion, npmLock },\n          'Found unsupported npm lockfile version',\n        );\n        return;\n      }\n      if (npm) {\n        packageFile.extractedConstraints ??= {};\n        packageFile.extractedConstraints.npm = npm;\n      }\n\n      for (const dep of packageFile.deps) {\n        // TODO: types (#22198)\n        dep.lockedVersion = semver.valid(\n          lockFileCache[npmLock].lockedVersions?.[dep.depName!],\n        )!;\n      }\n    } else if (pnpmShrinkwrap) {\n      logger.debug('Found pnpm lock-file');\n      lockFiles.push(pnpmShrinkwrap);\n      if (!lockFileCache[pnpmShrinkwrap]) {\n        logger.trace(`Retrieving/parsing ${pnpmShrinkwrap}`);\n        lockFileCache[pnpmShrinkwrap] = await getPnpmLock(pnpmShrinkwrap);\n      }\n\n      const packageDir = dirname(packageFile.packageFile);\n      const pnpmRootDir = dirname(pnpmShrinkwrap);\n      const relativeDir = relative(pnpmRootDir, packageDir) || '.';\n\n      for (const dep of packageFile.deps) {\n        const { depName, depType } = dep;\n\n        const catalogName = pnpmCatalogDepTypeRe.exec(depType!)?.groups\n          ?.version;\n\n        if (catalogName) {\n          const lockedVersion = semver.valid(\n            lockFileCache[pnpmShrinkwrap].lockedVersionsWithCatalog?.[\n              catalogName\n            ]?.[depName!],\n          );\n\n          if (is.string(lockedVersion)) {\n            dep.lockedVersion = lockedVersion;\n          }\n        } else {\n          // TODO: types (#22198)\n          const lockedVersion = semver.valid(\n            lockFileCache[pnpmShrinkwrap].lockedVersionsWithPath?.[\n              relativeDir\n            ]?.[depType!]?.[depName!],\n          );\n\n          if (is.string(lockedVersion)) {\n            dep.lockedVersion = lockedVersion;\n          }\n        }\n      }\n    }\n    if (lockFiles.length) {\n      packageFile.lockFiles = lockFiles;\n    }\n  }\n}\n"]}