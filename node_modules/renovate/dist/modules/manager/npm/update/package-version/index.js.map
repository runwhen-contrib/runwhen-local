{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../../../lib/modules/manager/npm/update/package-version/index.ts"],"names":[],"mappings":";;AAcA,gDAmDC;;AAhED,4DAA4B;AAC5B,kDAA+C;AAC/C,qDAAkD;AAKlD,SAAS,mBAAmB,CAC1B,WAAmB;IAEnB,OAAO,WAAW,CAAC,UAAU,CAAC,SAAS,CAAC,CAAC;AAC3C,CAAC;AAED,SAAgB,kBAAkB,CAChC,OAAe,EACf,YAAoB,EACpB,WAA6C;IAE7C,eAAM,CAAC,KAAK,CACV,EAAE,WAAW,EAAE,YAAY,EAAE,EAC7B,iDAAiD,CAClD,CAAC;IACF,uBAAuB;IACvB,IAAI,YAA2B,CAAC;IAChC,IAAI,aAAa,GAAG,OAAO,CAAC;IAE5B,IAAI,CAAC;QACH,IAAI,mBAAmB,CAAC,WAAW,CAAC,EAAE,CAAC;YACrC,MAAM,aAAa,GAAG,WAAW,CAAC,OAAO,CAAC,SAAS,EAAE,EAAE,CAAC,CAAC;YACzD,MAAM,aAAa,GAAG,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC;YAC1C,YAAY;gBACV,aAAa,CAAC,YAAY,EAAE,CAAC,aAAa,CAAC;oBAC3C,aAAa,CAAC,eAAe,EAAE,CAAC,aAAa,CAAC;oBAC9C,aAAa,CAAC,oBAAoB,EAAE,CAAC,aAAa,CAAC;oBACnD,aAAa,CAAC,gBAAgB,EAAE,CAAC,aAAa,CAAC,CAAC;YAClD,IAAI,CAAC,YAAY,EAAE,CAAC;gBAClB,eAAM,CAAC,IAAI,CAAC,EAAE,aAAa,EAAE,EAAE,sCAAsC,CAAC,CAAC;gBACvE,OAAO,EAAE,aAAa,EAAE,CAAC;YAC3B,CAAC;QACH,CAAC;aAAM,CAAC;YACN,YAAY,GAAG,gBAAM,CAAC,GAAG,CAAC,YAAY,EAAE,WAAW,CAAC,CAAC;QACvD,CAAC;QACD,2BAA2B;QAC3B,eAAM,CAAC,KAAK,CAAC,iBAAiB,YAAa,EAAE,CAAC,CAAC;QAC/C,aAAa,GAAG,OAAO,CAAC,OAAO,CAC7B,IAAA,aAAK,EAAC,kCAAkC,CAAC,EACzC,aAAa,YAAa,EAAE,CAC7B,CAAC;QACF,IAAI,aAAa,KAAK,OAAO,EAAE,CAAC;YAC9B,eAAM,CAAC,KAAK,CAAC,4BAA4B,CAAC,CAAC;QAC7C,CAAC;aAAM,CAAC;YACN,eAAM,CAAC,KAAK,CAAC,6BAA6B,CAAC,CAAC;QAC9C,CAAC;IACH,CAAC;IAAC,MAAM,CAAC;QACP,eAAM,CAAC,IAAI,CACT;YACE,OAAO;YACP,YAAY;YACZ,WAAW;SACZ,EACD,uBAAuB,CACxB,CAAC;IACJ,CAAC;IACD,OAAO,EAAE,aAAa,EAAE,CAAC;AAC3B,CAAC","sourcesContent":["import type { ReleaseType } from 'semver';\nimport semver from 'semver';\nimport { logger } from '../../../../../logger';\nimport { regEx } from '../../../../../util/regex';\nimport type { BumpPackageVersionResult } from '../../../types';\n\ntype MirrorBumpVersion = `mirror:${string}`;\n\nfunction isMirrorBumpVersion(\n  bumpVersion: string,\n): bumpVersion is MirrorBumpVersion {\n  return bumpVersion.startsWith('mirror:');\n}\n\nexport function bumpPackageVersion(\n  content: string,\n  currentValue: string,\n  bumpVersion: ReleaseType | `mirror:${string}`,\n): BumpPackageVersionResult {\n  logger.debug(\n    { bumpVersion, currentValue },\n    'Checking if we should bump package.json version',\n  );\n  // TODO: types (#22198)\n  let newPjVersion: string | null;\n  let bumpedContent = content;\n\n  try {\n    if (isMirrorBumpVersion(bumpVersion)) {\n      const mirrorPackage = bumpVersion.replace('mirror:', '');\n      const parsedContent = JSON.parse(content);\n      newPjVersion =\n        parsedContent.dependencies?.[mirrorPackage] ??\n        parsedContent.devDependencies?.[mirrorPackage] ??\n        parsedContent.optionalDependencies?.[mirrorPackage] ??\n        parsedContent.peerDependencies?.[mirrorPackage];\n      if (!newPjVersion) {\n        logger.warn({ mirrorPackage }, 'bumpVersion mirror package not found');\n        return { bumpedContent };\n      }\n    } else {\n      newPjVersion = semver.inc(currentValue, bumpVersion);\n    }\n    // TODO: fix types (#22198)\n    logger.debug(`newPjVersion: ${newPjVersion!}`);\n    bumpedContent = content.replace(\n      regEx(`(?<version>\"version\":\\\\s*\")[^\"]*`),\n      `$<version>${newPjVersion!}`,\n    );\n    if (bumpedContent === content) {\n      logger.debug('Version was already bumped');\n    } else {\n      logger.debug('Bumped package.json version');\n    }\n  } catch {\n    logger.warn(\n      {\n        content,\n        currentValue,\n        bumpVersion,\n      },\n      'Failed to bumpVersion',\n    );\n  }\n  return { bumpedContent };\n}\n"]}