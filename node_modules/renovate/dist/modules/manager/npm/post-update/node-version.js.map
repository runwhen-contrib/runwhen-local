{"version":3,"file":"node-version.js","sourceRoot":"","sources":["../../../../../lib/modules/manager/npm/post-update/node-version.ts"],"names":[],"mappings":";;AAqCA,8CAgBC;AAED,sCAEC;AAED,sDAiBC;;AA5ED,4DAA4B;AAC5B,0DAA0B;AAC1B,+CAA4C;AAE5C,4CAAoD;AACpD,kDAA6D;AAI7D,KAAK,UAAU,WAAW,CAAC,QAAgB;IACzC,IAAI,CAAC;QACH,cAAc;QACd,MAAM,UAAU,GAAG,CAAC,MAAM,IAAA,kBAAa,EAAC,QAAQ,EAAE,MAAM,CAAC,CAAE;aACxD,KAAK,CAAC,oBAAY,CAAC,CAAC,CAAC,CAAC;aACtB,OAAO,CAAC,IAAA,aAAK,EAAC,IAAI,CAAC,EAAE,EAAE,CAAC,CAAC;QAC5B,IAAI,gBAAM,CAAC,UAAU,CAAC,UAAU,CAAC,EAAE,CAAC;YAClC,eAAM,CAAC,KAAK,CAAC,0BAA0B,UAAU,UAAU,QAAQ,EAAE,CAAC,CAAC;YACvE,OAAO,UAAU,CAAC;QACpB,CAAC;IACH,CAAC;IAAC,MAAM,CAAC;QACP,aAAa;IACf,CAAC;IACD,OAAO,IAAI,CAAC;AACd,CAAC;AAED,KAAK,UAAU,wBAAwB,CACrC,GAAoB;IAEpB,MAAM,UAAU,GAAG,CAAC,MAAM,GAAG,CAAC,QAAQ,EAAE,CAAC,CAAC,OAAO,EAAE,IAAI,CAAC;IACxD,IAAI,UAAU,IAAI,gBAAM,CAAC,UAAU,CAAC,UAAU,CAAC,EAAE,CAAC;QAChD,eAAM,CAAC,KAAK,CAAC,0BAA0B,UAAU,qBAAqB,CAAC,CAAC;QACxE,OAAO,UAAU,CAAC;IACpB,CAAC;IACD,OAAO,IAAI,CAAC;AACd,CAAC;AAED,0BAA0B;AACnB,KAAK,UAAU,iBAAiB,CACrC,MAAiC,EACjC,QAAmB,EACnB,WAAmB,EACnB,GAAoB;IAEpB,MAAM,UAAU,GACd,aAAa,CAAC,QAAQ,CAAC;QACvB,MAAM,CAAC,WAAW,EAAE,IAAI;QACxB,CAAC,MAAM,WAAW,CAAC,eAAK,CAAC,IAAI,CAAC,WAAW,EAAE,QAAQ,CAAC,CAAC,CAAC;QACtD,CAAC,MAAM,WAAW,CAAC,eAAK,CAAC,IAAI,CAAC,WAAW,EAAE,eAAe,CAAC,CAAC,CAAC;QAC7D,CAAC,MAAM,wBAAwB,CAAC,GAAG,CAAC,CAAC,CAAC;IACxC,IAAI,CAAC,UAAU,EAAE,CAAC;QAChB,eAAM,CAAC,KAAK,CAAC,yCAAyC,CAAC,CAAC;IAC1D,CAAC;IACD,OAAO,UAAU,CAAC;AACpB,CAAC;AAED,SAAgB,aAAa,CAAC,QAAmB;IAC/C,OAAO,QAAQ,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,OAAO,KAAK,MAAM,CAAC,EAAE,QAAQ,CAAC;AAC9D,CAAC;AAEM,KAAK,UAAU,qBAAqB,CACzC,MAAiC,EACjC,QAAmB,EACnB,WAAmB,EACnB,GAAoB;IAEpB,MAAM,UAAU,GAAG,MAAM,iBAAiB,CACxC,MAAM,EACN,QAAQ,EACR,WAAW,EACX,GAAG,CACJ,CAAC;IAEF,OAAO;QACL,QAAQ,EAAE,MAAM;QAChB,UAAU;KACX,CAAC;AACJ,CAAC","sourcesContent":["import semver from 'semver';\nimport upath from 'upath';\nimport { logger } from '../../../../logger';\nimport type { ToolConstraint } from '../../../../util/exec/types';\nimport { readLocalFile } from '../../../../util/fs';\nimport { newlineRegex, regEx } from '../../../../util/regex';\nimport type { PostUpdateConfig, Upgrade } from '../../types';\nimport type { LazyPackageJson } from './utils';\n\nasync function getNodeFile(filename: string): Promise<string | null> {\n  try {\n    // TODO #22198\n    const constraint = (await readLocalFile(filename, 'utf8'))!\n      .split(newlineRegex)[0]\n      .replace(regEx(/^v/), '');\n    if (semver.validRange(constraint)) {\n      logger.debug(`Using node constraint \"${constraint}\" from ${filename}`);\n      return constraint;\n    }\n  } catch {\n    // do nothing\n  }\n  return null;\n}\n\nasync function getPackageJsonConstraint(\n  pkg: LazyPackageJson,\n): Promise<string | null> {\n  const constraint = (await pkg.getValue()).engines?.node;\n  if (constraint && semver.validRange(constraint)) {\n    logger.debug(`Using node constraint \"${constraint}\" from package.json`);\n    return constraint;\n  }\n  return null;\n}\n\n// export only for testing\nexport async function getNodeConstraint(\n  config: Partial<PostUpdateConfig>,\n  upgrades: Upgrade[],\n  lockFileDir: string,\n  pkg: LazyPackageJson,\n): Promise<string | null> {\n  const constraint =\n    getNodeUpdate(upgrades) ??\n    config.constraints?.node ??\n    (await getNodeFile(upath.join(lockFileDir, '.nvmrc'))) ??\n    (await getNodeFile(upath.join(lockFileDir, '.node-version'))) ??\n    (await getPackageJsonConstraint(pkg));\n  if (!constraint) {\n    logger.debug('No node constraint found - using latest');\n  }\n  return constraint;\n}\n\nexport function getNodeUpdate(upgrades: Upgrade[]): string | undefined {\n  return upgrades.find((u) => u.depName === 'node')?.newValue;\n}\n\nexport async function getNodeToolConstraint(\n  config: Partial<PostUpdateConfig>,\n  upgrades: Upgrade[],\n  lockFileDir: string,\n  pkg: LazyPackageJson,\n): Promise<ToolConstraint> {\n  const constraint = await getNodeConstraint(\n    config,\n    upgrades,\n    lockFileDir,\n    pkg,\n  );\n\n  return {\n    toolName: 'node',\n    constraint,\n  };\n}\n"]}