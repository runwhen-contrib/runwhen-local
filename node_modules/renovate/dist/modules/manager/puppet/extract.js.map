{"version":3,"file":"extract.js","sourceRoot":"","sources":["../../../../lib/modules/manager/puppet/extract.ts"],"names":[],"mappings":"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","sourcesContent":["import { logger } from '../../../logger';\nimport { parseUrl } from '../../../util/url';\nimport { GitTagsDatasource } from '../../datasource/git-tags';\nimport { GithubTagsDatasource } from '../../datasource/github-tags';\nimport { PuppetForgeDatasource } from '../../datasource/puppet-forge';\nimport type { PackageDependency, PackageFileContent } from '../types';\nimport { isGithubUrl, parseGitOwnerRepo } from './common';\nimport { parsePuppetfile } from './puppetfile-parser';\nimport type { PuppetfileModule } from './types';\n\nfunction parseForgeDependency(\n  module: PuppetfileModule,\n  forgeUrl: string | null,\n): PackageDependency {\n  const dep: PackageDependency = {\n    depName: module.name,\n    datasource: PuppetForgeDatasource.id,\n    packageName: module.name,\n    currentValue: module.version,\n  };\n\n  if (forgeUrl) {\n    dep.registryUrls = [forgeUrl];\n  }\n\n  return dep;\n}\n\nfunction parseGitDependency(module: PuppetfileModule): PackageDependency {\n  const moduleName = module.name;\n\n  const git = module.tags?.get('git');\n  const tag = module.tags?.get('tag');\n\n  if (!git || !tag) {\n    return {\n      depName: moduleName,\n      sourceUrl: git,\n      skipReason: 'invalid-version',\n    };\n  }\n\n  const parsedUrl = parseUrl(git);\n  const githubUrl = isGithubUrl(git, parsedUrl);\n\n  if (githubUrl && parsedUrl && parsedUrl.protocol !== 'https:') {\n    logger.debug(\n      `Access to github is only allowed for https, your url was: ${git}`,\n    );\n    return {\n      depName: moduleName,\n      sourceUrl: git,\n      skipReason: 'invalid-url',\n    };\n  }\n  const gitOwnerRepo = parseGitOwnerRepo(git, githubUrl);\n\n  if (!gitOwnerRepo) {\n    // failed to parse git url\n    return {\n      depName: moduleName,\n      sourceUrl: git,\n      skipReason: 'invalid-url',\n    };\n  }\n\n  const packageDependency: PackageDependency = {\n    depName: moduleName,\n    packageName: git,\n    sourceUrl: git,\n    gitRef: true,\n    currentValue: tag,\n    datasource: GitTagsDatasource.id,\n  };\n\n  if (githubUrl) {\n    packageDependency.packageName = gitOwnerRepo;\n    packageDependency.datasource = GithubTagsDatasource.id;\n  }\n\n  return packageDependency;\n}\n\nfunction isGitModule(module: PuppetfileModule): boolean {\n  return module.tags?.has('git') ?? false;\n}\n\nexport function extractPackageFile(content: string): PackageFileContent | null {\n  logger.trace('puppet.extractPackageFile()');\n\n  const puppetFile = parsePuppetfile(content);\n  const deps: PackageDependency[] = [];\n\n  for (const forgeUrl of puppetFile.getForges()) {\n    for (const module of puppetFile.getModulesOfForge(forgeUrl)) {\n      let packageDependency: PackageDependency;\n\n      if (isGitModule(module)) {\n        packageDependency = parseGitDependency(module);\n      } else {\n        packageDependency = parseForgeDependency(module, forgeUrl);\n      }\n\n      if (module.skipReason) {\n        // the PuppetfileModule skip reason is dominant over the packageDependency skip reason\n        packageDependency.skipReason = module.skipReason;\n      }\n\n      deps.push(packageDependency);\n    }\n  }\n\n  return deps.length ? { deps } : null;\n}\n"]}