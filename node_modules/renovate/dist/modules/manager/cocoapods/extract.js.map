{"version":3,"file":"extract.js","sourceRoot":"","sources":["../../../../lib/modules/manager/cocoapods/extract.ts"],"names":[],"mappings":"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","sourcesContent":["import { logger } from '../../../logger';\nimport { getSiblingFileName, localPathExists } from '../../../util/fs';\nimport { newlineRegex, regEx } from '../../../util/regex';\nimport { coerceString } from '../../../util/string';\nimport { GitTagsDatasource } from '../../datasource/git-tags';\nimport { GithubTagsDatasource } from '../../datasource/github-tags';\nimport { GitlabTagsDatasource } from '../../datasource/gitlab-tags';\nimport { PodDatasource } from '../../datasource/pod';\nimport type { PackageDependency, PackageFileContent } from '../types';\nimport type { ParsedLine } from './types';\n\nconst regexMappings = [\n  regEx(`^\\\\s*pod\\\\s+(['\"])(?<spec>[^'\"/]+)(/(?<subspec>[^'\"]+))?(['\"])`),\n  regEx(\n    `^\\\\s*pod\\\\s+(['\"])[^'\"]+(['\"])\\\\s*,\\\\s*(['\"])(?<currentValue>[^'\"]+)(['\"])\\\\s*$`,\n  ),\n  regEx(`,\\\\s*:git\\\\s*=>\\\\s*(['\"])(?<git>[^'\"]+)(['\"])`),\n  regEx(`,\\\\s*:tag\\\\s*=>\\\\s*(['\"])(?<tag>[^'\"]+)(['\"])`),\n  regEx(`,\\\\s*:path\\\\s*=>\\\\s*(['\"])(?<path>[^'\"]+)(['\"])`),\n  regEx(`^\\\\s*source\\\\s*(['\"])(?<source>[^'\"]+)(['\"])`),\n];\n\nexport function parseLine(line: string): ParsedLine {\n  let result: ParsedLine = {};\n  if (!line) {\n    return result;\n  }\n  for (const regex of Object.values(regexMappings)) {\n    const match = regex.exec(line.replace(regEx(/#.*$/), ''));\n    if (match?.groups) {\n      result = { ...result, ...match.groups };\n    }\n  }\n\n  if (result.spec) {\n    const depName = result.subspec\n      ? `${result.spec}/${result.subspec}`\n      : result.spec;\n    const specName = result.spec;\n    if (depName) {\n      result.depName = depName;\n    }\n    if (specName) {\n      result.specName = specName;\n    }\n    delete result.spec;\n    delete result.subspec;\n  }\n\n  return result;\n}\n\nexport function gitDep(parsedLine: ParsedLine): PackageDependency | null {\n  const { depName, git, tag } = parsedLine;\n\n  const platformMatch = regEx(\n    /[@/](?<platform>github|gitlab)\\.com[:/](?<account>[^/]+)\\/(?<repo>[^/]+)/,\n  ).exec(coerceString(git));\n\n  if (platformMatch?.groups) {\n    const { account, repo, platform } = platformMatch.groups;\n    if (account && repo) {\n      const datasource =\n        platform === 'github'\n          ? GithubTagsDatasource.id\n          : GitlabTagsDatasource.id;\n      return {\n        datasource,\n        depName,\n        packageName: `${account}/${repo.replace(regEx(/\\.git$/), '')}`,\n        currentValue: tag,\n      };\n    }\n  }\n\n  return {\n    datasource: GitTagsDatasource.id,\n    depName,\n    packageName: git,\n    currentValue: tag,\n  };\n}\n\nexport async function extractPackageFile(\n  content: string,\n  packageFile: string,\n): Promise<PackageFileContent | null> {\n  logger.trace(`cocoapods.extractPackageFile(${packageFile})`);\n  const deps: PackageDependency[] = [];\n  const lines: string[] = content.split(newlineRegex);\n\n  const registryUrls: string[] = [];\n\n  for (let lineNumber = 0; lineNumber < lines.length; lineNumber += 1) {\n    const line = lines[lineNumber];\n    const parsedLine = parseLine(line);\n    const {\n      depName,\n      specName,\n      currentValue,\n      git,\n      tag,\n      path,\n      source,\n    }: ParsedLine = parsedLine;\n\n    if (source) {\n      registryUrls.push(source.replace(regEx(/\\/*$/), ''));\n    }\n\n    if (depName) {\n      const managerData = { lineNumber };\n      let dep: PackageDependency = {\n        depName,\n        sharedVariableName: specName,\n        skipReason: 'unspecified-version',\n      };\n\n      if (currentValue) {\n        dep = {\n          depName,\n          sharedVariableName: specName,\n          datasource: PodDatasource.id,\n          currentValue,\n          managerData,\n          registryUrls,\n        };\n      } else if (git) {\n        if (tag) {\n          dep = { ...gitDep(parsedLine), managerData };\n        } else {\n          dep = {\n            depName,\n            sharedVariableName: specName,\n            skipReason: 'git-dependency',\n          };\n        }\n      } else if (path) {\n        dep = {\n          depName,\n          sharedVariableName: specName,\n          skipReason: 'path-dependency',\n        };\n      }\n\n      deps.push(dep);\n    }\n  }\n  const res: PackageFileContent = { deps };\n  const lockFile = getSiblingFileName(packageFile, 'Podfile.lock');\n  // istanbul ignore if\n  if (await localPathExists(lockFile)) {\n    res.lockFiles = [lockFile];\n  }\n  return res;\n}\n"]}