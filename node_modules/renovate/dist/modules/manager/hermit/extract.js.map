{"version":3,"file":"extract.js","sourceRoot":"","sources":["../../../../lib/modules/manager/hermit/extract.ts"],"names":[],"mappings":";;AAeA,gDA2BC;;AA1CD,0DAA0B;AAC1B,4CAAyC;AACzC,yCAAsD;AACtD,uDAAoD;AACpD,+CAA4C;AAC5C,oDAA2D;AAI3D,MAAM,iBAAiB,GAAG,IAAA,aAAK,EAAC,4CAA4C,CAAC,CAAC;AAE9E;;;GAGG;AACI,KAAK,UAAU,kBAAkB,CACtC,QAAgB,EAChB,WAAmB;IAEnB,eAAM,CAAC,KAAK,CAAC,6BAA6B,WAAW,GAAG,CAAC,CAAC;IAC1D,MAAM,YAAY,GAAG,EAAyB,CAAC;IAC/C,MAAM,QAAQ,GAAG,MAAM,kBAAkB,CAAC,WAAW,CAAC,CAAC;IAEvD,IAAI,CAAC,QAAQ,EAAE,MAAM,EAAE,CAAC;QACtB,OAAO,IAAI,CAAC;IACd,CAAC;IAED,KAAK,MAAM,CAAC,IAAI,QAAQ,EAAE,CAAC;QACzB,+DAA+D;QAC/D,iEAAiE;QACjE,MAAM,OAAO,GAAG,CAAC,CAAC,OAAO,KAAK,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,OAAO,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC;QAE/D,MAAM,GAAG,GAAsB;YAC7B,UAAU,EAAE,yBAAgB,CAAC,EAAE;YAC/B,OAAO,EAAE,CAAC,CAAC,IAAI;YACf,YAAY,EAAE,OAAO;SACtB,CAAC;QAEF,YAAY,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;IACzB,CAAC;IAED,OAAO,EAAE,IAAI,EAAE,YAAY,EAAE,CAAC;AAChC,CAAC;AAED;;GAEG;AACH,KAAK,UAAU,kBAAkB,CAC/B,WAAmB;IAEnB,eAAM,CAAC,KAAK,CAAC,6BAA6B,CAAC,CAAC;IAC5C,MAAM,YAAY,GAAG,eAAK,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC;IAEhD,IAAI,KAAK,GAAa,EAAE,CAAC;IAEzB,IAAI,CAAC;QACH,KAAK,GAAG,MAAM,IAAA,uBAAkB,EAAC,YAAY,CAAC,CAAC;IACjD,CAAC;IAAC,OAAO,GAAG,EAAE,CAAC;QACb,eAAM,CAAC,KAAK,CACV,EAAE,YAAY,EAAE,GAAG,EAAE,WAAW,EAAE,EAClC,yCAAyC,CAC1C,CAAC;QACF,OAAO,IAAI,CAAC;IACd,CAAC;IAED,eAAM,CAAC,KAAK,CAAC,EAAE,KAAK,EAAE,YAAY,EAAE,EAAE,+BAA+B,CAAC,CAAC;IAEvE,MAAM,GAAG,GAAG,EAAsB,CAAC;IAEnC,KAAK,MAAM,CAAC,IAAI,KAAK,EAAE,CAAC;QACtB,IAAI,CAAC,IAAA,qBAAS,EAAC,QAAQ,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,EAAE,CAAC;YAClC,SAAS;QACX,CAAC;QAED,MAAM,QAAQ,GAAG,CAAC;aACf,OAAO,CAAC,GAAG,YAAY,GAAG,EAAE,EAAE,CAAC;aAC/B,SAAS,CAAC,CAAC,CAAC;aACZ,OAAO,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC;QACzB,MAAM,YAAY,GAAG,QAAQ,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;QAEzC,IAAI,YAAY,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;YAC5B,GAAG,CAAC,IAAI,CAAC;gBACP,IAAI,EAAE,YAAY,CAAC,CAAC,CAAC;gBACrB,OAAO,EAAE,YAAY,CAAC,CAAC,CAAC;gBACxB,OAAO,EAAE,EAAE;aACZ,CAAC,CAAC;QACL,CAAC;QAED,MAAM,MAAM,GAAG,iBAAiB,CAAC,IAAI,CAAC,QAAQ,CAAC,EAAE,MAAM,CAAC;QACxD,IAAI,CAAC,MAAM,EAAE,CAAC;YACZ,eAAM,CAAC,KAAK,CACV,EAAE,QAAQ,EAAE,EACZ,kDAAkD,CACnD,CAAC;YACF,SAAS;QACX,CAAC;QAED,GAAG,CAAC,IAAI,CAAC;YACP,IAAI,EAAE,MAAM,CAAC,WAAW;YACxB,OAAO,EAAE,MAAM,CAAC,OAAO;YACvB,OAAO,EAAE,EAAE;SACZ,CAAC,CAAC;IACL,CAAC;IAED,OAAO,GAAG,CAAC;AACb,CAAC","sourcesContent":["import upath from 'upath';\nimport { logger } from '../../../logger';\nimport { readLocalDirectory } from '../../../util/fs';\nimport { minimatch } from '../../../util/minimatch';\nimport { regEx } from '../../../util/regex';\nimport { HermitDatasource } from '../../datasource/hermit';\nimport type { PackageDependency, PackageFileContent } from '../types';\nimport type { HermitListItem } from './types';\n\nconst pkgReferenceRegex = regEx(`(?<packageName>.*?)-(?<version>[0-9]{1}.*)`);\n\n/**\n * extractPackageFile scans the folder of the package files\n * and looking for .{packageName}-{version}.pkg\n */\nexport async function extractPackageFile(\n  _content: string,\n  packageFile: string,\n): Promise<PackageFileContent | null> {\n  logger.trace(`hermit.extractPackageFile(${packageFile})`);\n  const dependencies = [] as PackageDependency[];\n  const packages = await listHermitPackages(packageFile);\n\n  if (!packages?.length) {\n    return null;\n  }\n\n  for (const p of packages) {\n    // version of a hermit package is either a Version or a Channel\n    // Channel will prepend with @ to distinguish from normal version\n    const version = p.Version === '' ? `@${p.Channel}` : p.Version;\n\n    const dep: PackageDependency = {\n      datasource: HermitDatasource.id,\n      depName: p.Name,\n      currentValue: version,\n    };\n\n    dependencies.push(dep);\n  }\n\n  return { deps: dependencies };\n}\n\n/**\n * listHermitPackages will fetch all installed packages from the bin folder\n */\nasync function listHermitPackages(\n  packageFile: string,\n): Promise<HermitListItem[] | null> {\n  logger.trace('hermit.listHermitPackages()');\n  const hermitFolder = upath.dirname(packageFile);\n\n  let files: string[] = [];\n\n  try {\n    files = await readLocalDirectory(hermitFolder);\n  } catch (err) {\n    logger.debug(\n      { hermitFolder, err, packageFile },\n      'error listing hermit package references',\n    );\n    return null;\n  }\n\n  logger.trace({ files, hermitFolder }, 'files for hermit package list');\n\n  const out = [] as HermitListItem[];\n\n  for (const f of files) {\n    if (!minimatch('.*.pkg').match(f)) {\n      continue;\n    }\n\n    const fileName = f\n      .replace(`${hermitFolder}/`, '')\n      .substring(1)\n      .replace(/\\.pkg$/, '');\n    const channelParts = fileName.split('@');\n\n    if (channelParts.length > 1) {\n      out.push({\n        Name: channelParts[0],\n        Channel: channelParts[1],\n        Version: '',\n      });\n    }\n\n    const groups = pkgReferenceRegex.exec(fileName)?.groups;\n    if (!groups) {\n      logger.debug(\n        { fileName },\n        'invalid hermit package reference file name found',\n      );\n      continue;\n    }\n\n    out.push({\n      Name: groups.packageName,\n      Version: groups.version,\n      Channel: '',\n    });\n  }\n\n  return out;\n}\n"]}