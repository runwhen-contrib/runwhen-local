{"version":3,"file":"parser.js","sourceRoot":"","sources":["../../../../lib/modules/manager/gradle/parser.ts"],"names":[],"mappings":"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","sourcesContent":["import { lang, query as q } from 'good-enough-parser';\nimport { newlineRegex, regEx } from '../../../util/regex';\nimport type { PackageDependency } from '../types';\nimport { qApplyFrom } from './parser/apply-from';\nimport { qAssignments } from './parser/assignments';\nimport { qKotlinImport } from './parser/common';\nimport { qDependencies, qLongFormDep } from './parser/dependencies';\nimport { setParseGradleFunc } from './parser/handlers';\nimport { qToolchainVersion } from './parser/language-version';\nimport { qKotlinMultiObjectVarAssignment } from './parser/objects';\nimport { qPlugins } from './parser/plugins';\nimport { qRegistryUrls } from './parser/registry-urls';\nimport { qVersionCatalogs } from './parser/version-catalogs';\nimport type {\n  Ctx,\n  GradleManagerData,\n  PackageRegistry,\n  PackageVariables,\n  ParseGradleResult,\n} from './types';\nimport { parseDependencyString } from './utils';\n\nconst groovy = lang.createLang('groovy');\nconst ctx: Ctx = {\n  packageFile: '',\n  fileContents: {},\n  recursionDepth: 0,\n\n  globalVars: {},\n  deps: [],\n  registryUrls: [],\n\n  varTokens: [],\n  tmpKotlinImportStore: [],\n  tmpNestingDepth: [],\n  tmpRegistryContent: [],\n  tmpTokenStore: {},\n  tokenMap: {},\n};\n\nsetParseGradleFunc(parseGradle);\n\nexport function parseGradle(\n  input: string,\n  initVars: PackageVariables = {},\n  packageFile = '',\n  fileContents: Record<string, string | null> = {},\n  recursionDepth = 0,\n): ParseGradleResult {\n  let vars: PackageVariables = { ...initVars };\n  const deps: PackageDependency<GradleManagerData>[] = [];\n  const urls: PackageRegistry[] = [];\n\n  const query = q.tree<Ctx>({\n    type: 'root-tree',\n    search: q.alt<Ctx>(\n      qKotlinImport,\n      qAssignments,\n      qDependencies,\n      qPlugins,\n      qRegistryUrls,\n      qVersionCatalogs,\n      qLongFormDep,\n      qApplyFrom,\n    ),\n  });\n\n  const parsedResult = groovy.query(input, query, {\n    ...ctx,\n    packageFile,\n    fileContents,\n    recursionDepth,\n    globalVars: vars,\n  });\n\n  if (parsedResult) {\n    deps.push(...parsedResult.deps);\n    vars = { ...vars, ...parsedResult.globalVars };\n    urls.push(...parsedResult.registryUrls);\n  }\n\n  return { deps, urls, vars };\n}\n\nexport function parseKotlinSource(\n  input: string,\n  initVars: PackageVariables = {},\n  packageFile = '',\n): { vars: PackageVariables; deps: PackageDependency<GradleManagerData>[] } {\n  let vars: PackageVariables = { ...initVars };\n  const deps: PackageDependency<GradleManagerData>[] = [];\n\n  const query = q.tree<Ctx>({\n    type: 'root-tree',\n    maxDepth: 1,\n    search: qKotlinMultiObjectVarAssignment,\n  });\n\n  const parsedResult = groovy.query(input, query, {\n    ...ctx,\n    packageFile,\n    globalVars: vars,\n  });\n\n  if (parsedResult) {\n    deps.push(...parsedResult.deps);\n    vars = { ...vars, ...parsedResult.globalVars };\n  }\n\n  return { deps, vars };\n}\n\nexport function parseJavaToolchainVersion(input: string): string | null {\n  const ctx: Partial<Ctx> = {};\n  const parsedResult = groovy.query(input, qToolchainVersion, ctx);\n\n  return parsedResult?.javaLanguageVersion ?? null;\n}\n\nconst propWord = '[a-zA-Z_][a-zA-Z0-9_]*(?:\\\\.[a-zA-Z_][a-zA-Z0-9_]*)*';\nconst propRegex = regEx(\n  `^(?<leftPart>\\\\s*(?<key>${propWord})\\\\s*[= :]\\\\s*['\"]?)(?<value>[^\\\\s'\"]+)['\"]?\\\\s*$`,\n);\n\nexport function parseProps(\n  input: string,\n  packageFile?: string,\n): { vars: PackageVariables; deps: PackageDependency<GradleManagerData>[] } {\n  let offset = 0;\n  const vars: PackageVariables = {};\n  const deps: PackageDependency<GradleManagerData>[] = [];\n\n  for (const line of input.split(newlineRegex)) {\n    const lineMatch = propRegex.exec(line);\n    if (lineMatch?.groups) {\n      const { key, value, leftPart } = lineMatch.groups;\n      const replacePosition = offset + leftPart.length;\n      const dep = parseDependencyString(value);\n      if (dep) {\n        deps.push({\n          ...dep,\n          managerData: {\n            fileReplacePosition: replacePosition + dep.depName!.length + 1,\n            packageFile,\n          },\n        });\n      } else {\n        vars[key] = {\n          key,\n          value,\n          fileReplacePosition: replacePosition,\n          packageFile,\n        };\n      }\n    }\n    offset += line.length + 1;\n  }\n  return { vars, deps };\n}\n"]}