{"version":3,"file":"artifacts.js","sourceRoot":"","sources":["../../../../lib/modules/manager/pipenv/artifacts.ts"],"names":[],"mappings":"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","sourcesContent":["import { pipenv as pipenvDetect } from '@renovatebot/detect-tools';\nimport is from '@sindresorhus/is';\nimport { TEMPORARY_ERROR } from '../../../constants/error-messages';\nimport { logger } from '../../../logger';\nimport type { HostRule } from '../../../types';\nimport { exec } from '../../../util/exec';\nimport type { ExecOptions, ExtraEnv, Opt } from '../../../util/exec/types';\nimport {\n  deleteLocalFile,\n  ensureCacheDir,\n  getParentDir,\n  localPathExists,\n  readLocalFile,\n  writeLocalFile,\n} from '../../../util/fs';\nimport { ensureLocalPath } from '../../../util/fs/util';\nimport { getRepoStatus } from '../../../util/git';\nimport { find } from '../../../util/host-rules';\nimport { regEx } from '../../../util/regex';\nimport { parseUrl } from '../../../util/url';\nimport { PypiDatasource } from '../../datasource/pypi';\nimport type { UpdateArtifact, UpdateArtifactsResult } from '../types';\nimport { extractPackageFile } from './extract';\n\nexport function getMatchingHostRule(url: string): HostRule | null {\n  const parsedUrl = parseUrl(url);\n  if (parsedUrl) {\n    parsedUrl.username = '';\n    parsedUrl.password = '';\n    const urlWithoutCredentials = parsedUrl.toString();\n\n    return find({ hostType: PypiDatasource.id, url: urlWithoutCredentials });\n  }\n  return null;\n}\n\nasync function findPipfileSourceUrlsWithCredentials(\n  pipfileContent: string,\n  pipfileName: string,\n): Promise<URL[]> {\n  const pipfile = await extractPackageFile(pipfileContent, pipfileName);\n\n  return (\n    pipfile?.registryUrls\n      ?.map(parseUrl)\n      .filter(is.urlInstance)\n      .filter((url) => is.nonEmptyStringAndNotWhitespace(url.username)) ?? []\n  );\n}\n\n/**\n * This will extract the actual variable name from an environment-placeholder:\n * ${USERNAME:-defaultvalue} will yield 'USERNAME'\n */\nexport function extractEnvironmentVariableName(\n  credential: string,\n): string | null {\n  const match = regEx('([a-z0-9_]+)', 'i').exec(decodeURI(credential));\n  return match?.length ? match[0] : null;\n}\n\nexport function addExtraEnvVariable(\n  extraEnv: ExtraEnv<unknown>,\n  environmentVariableName: string,\n  environmentValue: string,\n): void {\n  logger.trace(\n    `Adding ${environmentVariableName} environment variable for pipenv`,\n  );\n  if (\n    extraEnv[environmentVariableName] &&\n    extraEnv[environmentVariableName] !== environmentValue\n  ) {\n    logger.warn(\n      { envVar: environmentVariableName },\n      'Possible misconfiguration, environment variable already set to a different value',\n    );\n  }\n  extraEnv[environmentVariableName] = environmentValue;\n}\n\n/**\n * Pipenv allows configuring source-urls for remote repositories with placeholders for credentials, i.e. http://$USER:$PASS@myprivate.repo\n * if a matching host rule exists for that repository, we need to set the corresponding variables.\n * Simply substituting them in the URL is not an option as it would impact the hash for the resulting Pipfile.lock\n *\n */\nasync function addCredentialsForSourceUrls(\n  newPipfileContent: string,\n  pipfileName: string,\n  extraEnv: ExtraEnv<unknown>,\n): Promise<void> {\n  const sourceUrls = await findPipfileSourceUrlsWithCredentials(\n    newPipfileContent,\n    pipfileName,\n  );\n  for (const parsedSourceUrl of sourceUrls) {\n    logger.trace(`Trying to add credentials for ${parsedSourceUrl.toString()}`);\n    const matchingHostRule = getMatchingHostRule(parsedSourceUrl.toString());\n    if (matchingHostRule) {\n      const usernameVariableName = extractEnvironmentVariableName(\n        parsedSourceUrl.username,\n      );\n      if (matchingHostRule.username && usernameVariableName) {\n        addExtraEnvVariable(\n          extraEnv,\n          usernameVariableName,\n          matchingHostRule.username,\n        );\n      }\n      const passwordVariableName = extractEnvironmentVariableName(\n        parsedSourceUrl.password,\n      );\n      if (matchingHostRule.password && passwordVariableName) {\n        addExtraEnvVariable(\n          extraEnv,\n          passwordVariableName,\n          matchingHostRule.password,\n        );\n      }\n    }\n  }\n}\n\nexport async function updateArtifacts({\n  packageFileName: pipfileName,\n  newPackageFileContent: newPipfileContent,\n  config,\n}: UpdateArtifact): Promise<UpdateArtifactsResult[] | null> {\n  logger.debug(`pipenv.updateArtifacts(${pipfileName})`);\n\n  const lockFileName = pipfileName + '.lock';\n  if (!(await localPathExists(lockFileName))) {\n    logger.debug('No Pipfile.lock found');\n    return null;\n  }\n  try {\n    await writeLocalFile(pipfileName, newPipfileContent);\n    if (config.isLockFileMaintenance) {\n      await deleteLocalFile(lockFileName);\n    }\n    const cmd = 'pipenv lock';\n    const pipfileDir = getParentDir(ensureLocalPath(pipfileName));\n    const tagConstraint =\n      config.constraints?.python ??\n      (await pipenvDetect.getPythonConstraint(pipfileDir));\n    const pipenvConstraint =\n      config.constraints?.pipenv ??\n      (await pipenvDetect.getPipenvConstraint(pipfileDir));\n    const extraEnv: Opt<ExtraEnv> = {\n      PIPENV_CACHE_DIR: await ensureCacheDir('pipenv'),\n      PIP_CACHE_DIR: await ensureCacheDir('pip'),\n      WORKON_HOME: await ensureCacheDir('virtualenvs'),\n    };\n    const execOptions: ExecOptions = {\n      cwdFile: pipfileName,\n      docker: {},\n      toolConstraints: [\n        {\n          toolName: 'python',\n          constraint: tagConstraint,\n        },\n        {\n          toolName: 'pipenv',\n          constraint: pipenvConstraint,\n        },\n      ],\n    };\n    await addCredentialsForSourceUrls(newPipfileContent, pipfileName, extraEnv);\n    execOptions.extraEnv = extraEnv;\n\n    logger.trace({ cmd }, 'pipenv lock command');\n    await exec(cmd, execOptions);\n    const status = await getRepoStatus();\n    if (!status?.modified.includes(lockFileName)) {\n      return null;\n    }\n    logger.debug('Returning updated Pipfile.lock');\n    return [\n      {\n        file: {\n          type: 'addition',\n          path: lockFileName,\n          contents: await readLocalFile(lockFileName, 'utf8'),\n        },\n      },\n    ];\n  } catch (err) {\n    // istanbul ignore if\n    if (err.message === TEMPORARY_ERROR) {\n      throw err;\n    }\n    logger.debug({ err }, 'Failed to update Pipfile.lock');\n    return [\n      {\n        artifactError: {\n          lockFile: lockFileName,\n          stderr: err.message,\n        },\n      },\n    ];\n  }\n}\n"]}