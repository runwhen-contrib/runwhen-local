{"version":3,"file":"git.js","sourceRoot":"","sources":["../../../../../lib/modules/manager/bazel/rules/git.ts"],"names":[],"mappings":";;;;AAAA,sFAAiD;AACjD,6BAAwB;AACxB,+CAA4C;AAC5C,kDAA+C;AAC/C,8CAAiD;AACjD,yEAA+E;AAC/E,iEAAuE;AAGvE,MAAM,cAAc,GAAG,IAAA,aAAK,EAC1B,sDAAsD,CACvD,CAAC;AAEF,SAAS,iBAAiB,CAAC,KAAa;IACtC,qBAAqB;IACrB,IAAI,CAAC,IAAA,eAAS,EAAC,KAAK,CAAC,EAAE,CAAC;QACtB,eAAM,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,GAAG,EAAE,KAAK,EAAE,EAAE,qCAAqC,CAAC,CAAC;IAC1E,CAAC;IACD,OAAO,IAAA,6BAAc,EAAC,KAAK,CAAC,EAAE,KAAK,CAAC,cAAc,CAAC,EAAE,MAAM,EAAE,WAAW,CAAC;AAC3E,CAAC;AAEY,QAAA,QAAQ,GAAG,CAAC,gBAAgB,EAAE,iBAAiB,CAAU,CAAC;AAE1D,QAAA,SAAS,GAAG,OAAC;KACvB,MAAM,CAAC;IACN,IAAI,EAAE,OAAC,CAAC,IAAI,CAAC,gBAAQ,CAAC;IACtB,IAAI,EAAE,OAAC,CAAC,MAAM,EAAE;IAChB,GAAG,EAAE,OAAC,CAAC,MAAM,EAAE,CAAC,QAAQ,EAAE;IAC1B,MAAM,EAAE,OAAC,CAAC,MAAM,EAAE,CAAC,QAAQ,EAAE;IAC7B,MAAM,EAAE,OAAC,CAAC,MAAM,EAAE;CACnB,CAAC;KACD,MAAM,CAAC,CAAC,EAAE,GAAG,EAAE,MAAM,EAAE,EAAE,EAAE,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,CAAC,MAAM,CAAC;KAC9C,SAAS,CAAC,CAAC,EAAE,IAAI,EAAE,IAAI,EAAE,GAAG,EAAE,MAAM,EAAE,MAAM,EAAE,EAAuB,EAAE;IACtE,MAAM,GAAG,GAAsB;QAC7B,OAAO,EAAE,IAAI;QACb,OAAO,EAAE,IAAI;KACd,CAAC;IAEF,IAAI,GAAG,EAAE,CAAC;QACR,GAAG,CAAC,YAAY,GAAG,GAAG,CAAC;IACzB,CAAC;IAED,IAAI,MAAM,EAAE,CAAC;QACX,GAAG,CAAC,aAAa,GAAG,MAAM,CAAC;IAC7B,CAAC;IAED,MAAM,aAAa,GAAG,iBAAiB,CAAC,MAAM,CAAC,CAAC;IAChD,IAAI,aAAa,EAAE,CAAC;QAClB,GAAG,CAAC,WAAW,GAAG,aAAa,CAAC;QAChC,IAAI,GAAG,CAAC,YAAY,EAAE,CAAC;YACrB,GAAG,CAAC,UAAU,GAAG,0CAAwB,CAAC,EAAE,CAAC;QAC/C,CAAC;aAAM,CAAC;YACN,GAAG,CAAC,UAAU,GAAG,kCAAoB,CAAC,EAAE,CAAC;QAC3C,CAAC;IACH,CAAC;IAED,IAAI,CAAC,GAAG,CAAC,UAAU,EAAE,CAAC;QACpB,GAAG,CAAC,UAAU,GAAG,wBAAwB,CAAC;IAC5C,CAAC;IAED,OAAO,CAAC,GAAG,CAAC,CAAC;AACf,CAAC,CAAC,CAAC","sourcesContent":["import parseGithubUrl from 'github-url-from-git';\nimport { z } from 'zod';\nimport { logger } from '../../../../logger';\nimport { regEx } from '../../../../util/regex';\nimport { isHttpUrl } from '../../../../util/url';\nimport { GithubReleasesDatasource } from '../../../datasource/github-releases';\nimport { GithubTagsDatasource } from '../../../datasource/github-tags';\nimport type { PackageDependency } from '../../types';\n\nconst githubUrlRegex = regEx(\n  /^https:\\/\\/github\\.com\\/(?<packageName>[^/]+\\/[^/]+)/,\n);\n\nfunction githubPackageName(input: string): string | undefined {\n  // istanbul ignore if\n  if (!isHttpUrl(input)) {\n    logger.once.info({ url: input }, `Bazel: non-https git_repository URL`);\n  }\n  return parseGithubUrl(input)?.match(githubUrlRegex)?.groups?.packageName;\n}\n\nexport const gitRules = ['git_repository', '_git_repository'] as const;\n\nexport const GitTarget = z\n  .object({\n    rule: z.enum(gitRules),\n    name: z.string(),\n    tag: z.string().optional(),\n    commit: z.string().optional(),\n    remote: z.string(),\n  })\n  .refine(({ tag, commit }) => !!tag || !!commit)\n  .transform(({ rule, name, tag, commit, remote }): PackageDependency[] => {\n    const dep: PackageDependency = {\n      depType: rule,\n      depName: name,\n    };\n\n    if (tag) {\n      dep.currentValue = tag;\n    }\n\n    if (commit) {\n      dep.currentDigest = commit;\n    }\n\n    const githubPackage = githubPackageName(remote);\n    if (githubPackage) {\n      dep.packageName = githubPackage;\n      if (dep.currentValue) {\n        dep.datasource = GithubReleasesDatasource.id;\n      } else {\n        dep.datasource = GithubTagsDatasource.id;\n      }\n    }\n\n    if (!dep.datasource) {\n      dep.skipReason = 'unsupported-datasource';\n    }\n\n    return [dep];\n  });\n"]}