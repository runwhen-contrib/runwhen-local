{"version":3,"file":"extract.js","sourceRoot":"","sources":["../../../../lib/modules/manager/mise/extract.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { logger } from '../../../logger';\nimport type { ToolingConfig } from '../asdf/upgradeable-tooling';\nimport type { PackageDependency, PackageFileContent } from '../types';\nimport type { MiseToolSchema } from './schema';\nimport type { ToolingDefinition } from './upgradeable-tooling';\nimport { asdfTooling, miseTooling } from './upgradeable-tooling';\nimport { parseTomlFile } from './utils';\n\nexport function extractPackageFile(\n  content: string,\n  packageFile: string,\n): PackageFileContent | null {\n  logger.trace(`mise.extractPackageFile(${packageFile})`);\n\n  const misefile = parseTomlFile(content, packageFile);\n  if (!misefile) {\n    return null;\n  }\n\n  const deps: PackageDependency[] = [];\n  const tools = misefile.tools;\n\n  if (tools) {\n    for (const [name, toolData] of Object.entries(tools)) {\n      const version = parseVersion(toolData);\n      const depName = name.trim();\n      const toolConfig = getToolConfig(depName, version);\n      const dep = createDependency(depName, version, toolConfig);\n      deps.push(dep);\n    }\n  }\n\n  return deps.length ? { deps } : null;\n}\n\nfunction parseVersion(toolData: MiseToolSchema): string | null {\n  if (is.nonEmptyString(toolData)) {\n    // Handle the string case\n    // e.g. 'erlang = \"23.3\"'\n    return toolData;\n  }\n  if (is.array(toolData, is.string)) {\n    // Handle the array case\n    // e.g. 'erlang = [\"23.3\", \"24.0\"]'\n    return toolData.length ? toolData[0] : null; // Get the first version in the array\n  }\n  if (is.object(toolData) && is.nonEmptyString(toolData.version)) {\n    // Handle the object case with a string version\n    // e.g. 'python = { version = \"3.11.2\" }'\n    return toolData.version;\n  }\n  return null; // Return null if no version is found\n}\n\nfunction getToolConfig(\n  name: string,\n  version: string | null,\n): ToolingConfig | null {\n  if (version === null) {\n    return null; // Early return if version is null\n  }\n\n  // Try to get the config from miseTooling first, then asdfTooling\n  return (\n    getConfigFromTooling(miseTooling, name, version) ??\n    getConfigFromTooling(asdfTooling, name, version)\n  );\n}\n\nfunction getConfigFromTooling(\n  toolingSource: Record<string, ToolingDefinition>,\n  name: string,\n  version: string,\n): ToolingConfig | null {\n  const toolDefinition = toolingSource[name];\n  if (!toolDefinition) {\n    return null;\n  } // Return null if no toolDefinition is found\n\n  return (\n    (typeof toolDefinition.config === 'function'\n      ? toolDefinition.config(version)\n      : toolDefinition.config) ?? null\n  ); // Ensure null is returned instead of undefined\n}\n\nfunction createDependency(\n  name: string,\n  version: string | null,\n  config: ToolingConfig | null,\n): PackageDependency {\n  if (version === null) {\n    return { depName: name, skipReason: 'unspecified-version' };\n  }\n  if (config === null) {\n    return { depName: name, skipReason: 'unsupported-datasource' };\n  }\n  return {\n    depName: name,\n    currentValue: version,\n    ...config,\n  };\n}\n"]}