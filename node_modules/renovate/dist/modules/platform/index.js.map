{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../lib/modules/platform/index.ts"],"names":[],"mappings":"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","sourcesContent":["import URL from 'node:url';\nimport type { AllConfig } from '../../config/types';\nimport type { PlatformId } from '../../constants';\nimport { PLATFORM_NOT_FOUND } from '../../constants/error-messages';\nimport { logger } from '../../logger';\nimport type { HostRule } from '../../types';\nimport { setGitAuthor, setNoVerify, setPrivateKey } from '../../util/git';\nimport * as hostRules from '../../util/host-rules';\nimport platforms from './api';\nimport { setPlatformScmApi } from './scm';\nimport type { Platform } from './types';\n\nexport type * from './types';\n\nexport const getPlatformList = (): string[] => Array.from(platforms.keys());\n\nlet _platform: Platform | undefined;\n\nconst handler: ProxyHandler<Platform> = {\n  get(_target: Platform, prop: keyof Platform) {\n    if (!_platform) {\n      throw new Error(PLATFORM_NOT_FOUND);\n    }\n    return _platform[prop];\n  },\n};\n\nexport const platform = new Proxy<Platform>({} as any, handler);\n\nexport function setPlatformApi(name: PlatformId): void {\n  if (!platforms.has(name)) {\n    throw new Error(\n      `Init: Platform \"${name}\" not found. Must be one of: ${getPlatformList().join(\n        ', ',\n      )}`,\n    );\n  }\n  _platform = platforms.get(name);\n  setPlatformScmApi(name);\n}\n\nexport async function initPlatform(config: AllConfig): Promise<AllConfig> {\n  setPrivateKey(config.gitPrivateKey);\n  setNoVerify(config.gitNoVerify ?? []);\n  // TODO: `platform` (#22198)\n  setPlatformApi(config.platform!);\n  // TODO: types\n  const platformInfo = await platform.initPlatform(config);\n  const returnConfig: any = {\n    ...config,\n    ...platformInfo,\n    hostRules: [\n      ...(platformInfo?.hostRules ?? []),\n      ...(config.hostRules ?? []),\n    ],\n  };\n  if (config?.gitAuthor) {\n    logger.debug(`Using configured gitAuthor (${config.gitAuthor})`);\n    returnConfig.gitAuthor = config.gitAuthor;\n  } else if (platformInfo?.gitAuthor) {\n    logger.debug(`Using platform gitAuthor: ${String(platformInfo.gitAuthor)}`);\n    returnConfig.gitAuthor = platformInfo.gitAuthor;\n  }\n  // This is done for validation and will be overridden later once repo config is incorporated\n  setGitAuthor(returnConfig.gitAuthor);\n  const platformRule: HostRule = {\n    // TODO: null check (#22198)\n    matchHost: URL.parse(returnConfig.endpoint).hostname!,\n  };\n  // There might have been platform-specific modifications to the token\n  if (returnConfig.token) {\n    config.token = returnConfig.token;\n  }\n  (\n    ['token', 'username', 'password'] as ('token' | 'username' | 'password')[]\n  ).forEach((field) => {\n    if (config[field]) {\n      // TODO: types #22198\n      platformRule[field] = config[field] as string;\n      delete returnConfig[field];\n    }\n  });\n  const typedPlatformRule = {\n    ...platformRule,\n    hostType: returnConfig.platform,\n  };\n  returnConfig.hostRules.push(typedPlatformRule);\n  hostRules.add(typedPlatformRule);\n  return returnConfig;\n}\n"]}