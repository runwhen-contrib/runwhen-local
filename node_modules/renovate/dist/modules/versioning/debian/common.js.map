{"version":3,"file":"common.js","sourceRoot":"","sources":["../../../../lib/modules/versioning/debian/common.ts"],"names":[],"mappings":";;;AAAA,iCAAiC;AACjC,4CAAyC;AAGzC,MAAM,eAAe,GAAG,EAAE,IAAI,EAAE,CAAC,EAAE,CAAC;AAEpC,MAAa,mBAAmB;IACtB,QAAQ,GAAG,IAAI,GAAG,EAAuC,CAAC;IAC1D,QAAQ,GAAG,IAAI,GAAG,EAAuC,CAAC;IAC1D,SAAS,GAAG,gBAAQ,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,KAAK,EAAE,CAAC,CAAC,iBAAiB;IAC7D,UAAU,CAAa;IAE/B,YAAY,UAAsB;QAChC,IAAI,CAAC,UAAU,GAAG,UAAU,CAAC;IAC/B,CAAC;IAED,eAAe,CAAC,KAAa;QAC3B,IAAI,CAAC,KAAK,EAAE,CAAC;QACb,MAAM,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;QAC1C,IAAI,QAAQ,EAAE,CAAC;YACb,OAAO,QAAQ,CAAC,OAAO,CAAC;QAC1B,CAAC;QACD,OAAO,KAAK,CAAC;IACf,CAAC;IAED,eAAe,CAAC,KAAa;QAC3B,IAAI,CAAC,KAAK,EAAE,CAAC;QACb,MAAM,EAAE,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;QACpC,IAAI,EAAE,EAAE,CAAC;YACP,OAAO,EAAE,CAAC,MAAM,CAAC;QACnB,CAAC;QACD,OAAO,KAAK,CAAC;IACf,CAAC;IAED,GAAG,CAAC,OAAe;QACjB,IAAI,CAAC,KAAK,EAAE,CAAC;QACb,OAAO,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;IACpC,CAAC;IAED,QAAQ,CAAC,OAAe;QACtB,IAAI,CAAC,KAAK,EAAE,CAAC;QACb,IAAI,QAAQ,GAA4C,SAAS,CAAC;QAClE,IAAI,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,CAAC;YAC/B,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;QACxC,CAAC;QACD,IAAI,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,CAAC;YAC/B,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;QACxC,CAAC;QACD,OAAO,QAAQ,CAAC;IAClB,CAAC;IAEO,KAAK;QACX,MAAM,GAAG,GAAG,gBAAQ,CAAC,GAAG,EAAE,CAAC,KAAK,EAAE,CAAC;QACnC,IAAI,GAAG,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,eAAe,CAAC,EAAE,CAAC;YAC/C,OAAO;QACT,CAAC;QACD,eAAM,CAAC,KAAK,CAAC,oCAAoC,CAAC,CAAC;QACnD,IAAI,CAAC,SAAS,GAAG,GAAG,CAAC;QACrB,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC;YAC3B,MAAM,EAAE,GAAG,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC;YAEzC,0CAA0C;YAC1C,IAAI,CAAC,EAAE,EAAE,CAAC;gBACR,OAAO;YACT,CAAC;YAED,IAAI,MAAM,GAAG,EAAE,CAAC;YAChB,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC;gBAC3B,MAAM,IAAI,KAAK,CAAC;YAClB,CAAC;YACD,EAAE,CAAC,MAAM,GAAG,MAAM,GAAG,QAAQ,CAAC;YAE9B,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,CAAC,MAAM,EAAE,EAAE,CAAC,CAAC;YACjC,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC;QACpC,CAAC;IACH,CAAC;CACF;AAtED,kDAsEC","sourcesContent":["import { DateTime } from 'luxon';\nimport { logger } from '../../../logger';\nimport type { DistroInfo, DistroInfoRecordWithVersion } from '../distro';\n\nconst refreshInterval = { days: 1 };\n\nexport class RollingReleasesData {\n  private ltsToVer = new Map<string, DistroInfoRecordWithVersion>();\n  private verToLts = new Map<string, DistroInfoRecordWithVersion>();\n  private timestamp = DateTime.fromMillis(0).toUTC(); // start of epoch\n  private distroInfo: DistroInfo;\n\n  constructor(distroInfo: DistroInfo) {\n    this.distroInfo = distroInfo;\n  }\n\n  getVersionByLts(input: string): string {\n    this.build();\n    const schedule = this.ltsToVer.get(input);\n    if (schedule) {\n      return schedule.version;\n    }\n    return input;\n  }\n\n  getLtsByVersion(input: string): string {\n    this.build();\n    const di = this.verToLts.get(input);\n    if (di) {\n      return di.series;\n    }\n    return input;\n  }\n\n  has(version: string): boolean {\n    this.build();\n    return this.ltsToVer.has(version);\n  }\n\n  schedule(version: string): DistroInfoRecordWithVersion | undefined {\n    this.build();\n    let schedule: DistroInfoRecordWithVersion | undefined = undefined;\n    if (this.verToLts.has(version)) {\n      schedule = this.verToLts.get(version);\n    }\n    if (this.ltsToVer.has(version)) {\n      schedule = this.ltsToVer.get(version);\n    }\n    return schedule;\n  }\n\n  private build(): void {\n    const now = DateTime.now().toUTC();\n    if (now < this.timestamp.plus(refreshInterval)) {\n      return;\n    }\n    logger.debug('RollingReleasesData - data written');\n    this.timestamp = now;\n    for (let i = 0; i < 3; i++) {\n      const di = this.distroInfo.getNLatest(i);\n\n      // istanbul ignore if: should never happen\n      if (!di) {\n        return;\n      }\n\n      let prefix = '';\n      for (let j = 0; j < i; j++) {\n        prefix += 'old';\n      }\n      di.series = prefix + 'stable';\n\n      this.ltsToVer.set(di.series, di);\n      this.verToLts.set(di.version, di);\n    }\n  }\n}\n"]}