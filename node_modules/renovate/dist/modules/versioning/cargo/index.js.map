{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../lib/modules/versioning/cargo/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { logger } from '../../../logger';\nimport type { RangeStrategy } from '../../../types/versioning';\nimport { regEx } from '../../../util/regex';\nimport { api as npm } from '../npm';\nimport type { NewValueConfig, VersioningApi } from '../types';\n\nexport const id = 'cargo';\nexport const displayName = 'Cargo';\nexport const urls = [\n  'https://doc.rust-lang.org/cargo/reference/specifying-dependencies.html',\n];\nexport const supportsRanges = true;\nexport const supportedRangeStrategies: RangeStrategy[] = [\n  'bump',\n  'pin',\n  'replace',\n];\n\nconst isVersion = (input: string): boolean => npm.isVersion(input);\n\nfunction convertToCaret(item: string): string {\n  // In Cargo, caret versions are used by default, so \"1.2.3\" actually means ^1.2.3.\n  // Similarly, \"0.4\" actually means ^0.4.\n  // See: https://doc.rust-lang.org/stable/cargo/reference/specifying-dependencies.html#caret-requirements\n  if (isVersion(item) || isVersion(item + '.0') || isVersion(item + '.0.0')) {\n    return '^' + item.trim();\n  }\n  return item.trim();\n}\n\nfunction cargo2npm(input: string): string {\n  let versions = input.split(',');\n  versions = versions.map(convertToCaret);\n  return versions.join(' ');\n}\n\nfunction notEmpty(s: string): boolean {\n  return s !== '';\n}\n\nfunction npm2cargo(input: string): string {\n  // istanbul ignore if\n  if (!input) {\n    return input;\n  }\n  // Note: this doesn't remove the ^\n  const res = input\n    .split(regEx(/\\s+,?\\s*|\\s*,?\\s+/))\n    .map((str) => str.trim())\n    .filter(notEmpty);\n  const operators = ['^', '~', '=', '>', '<', '<=', '>='];\n  for (let i = 0; i < res.length - 1; i += 1) {\n    if (operators.includes(res[i])) {\n      const newValue = res[i] + ' ' + res[i + 1];\n      res.splice(i, 2, newValue);\n    }\n  }\n  return res.join(', ');\n}\n\nconst isLessThanRange = (version: string, range: string): boolean =>\n  !!npm.isLessThanRange?.(version, cargo2npm(range));\n\nexport const isValid = (input: string): boolean =>\n  npm.isValid(cargo2npm(input));\n\nconst matches = (version: string, range: string): boolean =>\n  npm.matches(version, cargo2npm(range));\n\nfunction getSatisfyingVersion(\n  versions: string[],\n  range: string,\n): string | null {\n  return npm.getSatisfyingVersion(versions, cargo2npm(range));\n}\n\nfunction minSatisfyingVersion(\n  versions: string[],\n  range: string,\n): string | null {\n  return npm.minSatisfyingVersion(versions, cargo2npm(range));\n}\n\nconst isSingleVersion = (constraint: string): boolean =>\n  constraint.trim().startsWith('=') &&\n  isVersion(constraint.trim().substring(1).trim());\n\nfunction getNewValue({\n  currentValue,\n  rangeStrategy,\n  currentVersion,\n  newVersion,\n}: NewValueConfig): string {\n  if (!currentValue || currentValue === '*') {\n    return rangeStrategy === 'pin' ? `=${newVersion}` : currentValue;\n  }\n  // If the current value is a simple version, bump to fully specified newVersion\n  if (rangeStrategy === 'bump' && regEx(/^\\d+(?:\\.\\d+)*$/).test(currentValue)) {\n    return newVersion;\n  }\n  if (rangeStrategy === 'pin' || isSingleVersion(currentValue)) {\n    let res = '=';\n    if (currentValue.startsWith('= ')) {\n      res += ' ';\n    }\n    res += newVersion;\n    return res;\n  }\n  if (rangeStrategy === 'replace' && matches(newVersion, currentValue)) {\n    return currentValue;\n  }\n  const newSemver = npm.getNewValue({\n    currentValue: cargo2npm(currentValue),\n    rangeStrategy,\n    currentVersion,\n    newVersion,\n  });\n  let newCargo = newSemver\n    ? npm2cargo(newSemver)\n    : /* istanbul ignore next: should never happen */ null;\n  // istanbul ignore if\n  if (!newCargo) {\n    logger.info(\n      { currentValue, newSemver },\n      'Could not get cargo version from semver',\n    );\n    return currentValue;\n  }\n  // Keep new range precision the same as current\n  if (\n    (currentValue.startsWith('~') || currentValue.startsWith('^')) &&\n    rangeStrategy === 'replace' &&\n    newCargo.split('.').length > currentValue.split('.').length\n  ) {\n    newCargo = newCargo\n      .split('.')\n      .slice(0, currentValue.split('.').length)\n      .join('.');\n  }\n  // Try to reverse any caret we added\n  if (newCargo.startsWith('^') && !currentValue.startsWith('^')) {\n    const withoutCaret = newCargo.substring(1);\n    // NOTE: We want the number of components in the new version to match the original.\n    // e.g. \"5.0\" should be updated to \"6.0\".\n    const components = currentValue.split('.').length;\n    newCargo = withoutCaret.split('.').slice(0, components).join('.');\n  }\n\n  return newCargo;\n}\n\nexport const api: VersioningApi = {\n  ...npm,\n  getNewValue,\n  isLessThanRange,\n  isSingleVersion,\n  isValid,\n  matches,\n  getSatisfyingVersion,\n  minSatisfyingVersion,\n};\nexport default api;\n"]}