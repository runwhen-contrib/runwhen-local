{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../lib/modules/datasource/unity3d/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { cache } from '../../../util/cache/package/decorator';\nimport { asTimestamp } from '../../../util/timestamp';\nimport * as Unity3dVersioning from '../../versioning/unity3d';\nimport { Datasource } from '../datasource';\nimport type { GetReleasesConfig, ReleaseResult } from '../types';\nimport { UnityReleasesJSON } from './schema';\n\nexport class Unity3dDatasource extends Datasource {\n  static readonly baseUrl =\n    'https://services.api.unity.com/unity/editor/release/v1/releases';\n  static readonly homepage = 'https://unity.com/';\n  static readonly streams: Record<string, string> = {\n    lts: `${Unity3dDatasource.baseUrl}?stream=LTS`,\n    tech: `${Unity3dDatasource.baseUrl}?stream=TECH`,\n    alpha: `${Unity3dDatasource.baseUrl}?stream=ALPHA`,\n    beta: `${Unity3dDatasource.baseUrl}?stream=BETA`,\n  };\n  static readonly legacyStreams: Record<string, string> = {\n    lts: `${Unity3dDatasource.homepage}releases/editor/lts-releases.xml`,\n    stable: `${Unity3dDatasource.homepage}releases/editor/releases.xml`,\n    beta: `${Unity3dDatasource.homepage}releases/editor/beta/latest.xml`,\n  };\n\n  static readonly id = 'unity3d';\n\n  override readonly defaultRegistryUrls = [Unity3dDatasource.streams.lts];\n\n  override readonly defaultVersioning = Unity3dVersioning.id;\n\n  override readonly registryStrategy = 'merge';\n\n  override readonly releaseTimestampSupport = true;\n  override readonly releaseTimestampNote =\n    'The release timestamp is determined from the `releaseDate` field in the results.';\n\n  constructor() {\n    super(Unity3dDatasource.id);\n  }\n\n  translateStream(registryUrl: string): string {\n    const legacyKey = Object.keys(Unity3dDatasource.legacyStreams).find(\n      (key) => Unity3dDatasource.legacyStreams[key] === registryUrl,\n    );\n\n    if (legacyKey) {\n      if (legacyKey === 'stable') {\n        return Unity3dDatasource.streams.lts;\n      }\n\n      return Unity3dDatasource.streams[legacyKey];\n    }\n\n    return registryUrl;\n  }\n\n  async getByStream(\n    registryUrl: string | undefined,\n    withHash: boolean,\n  ): Promise<ReleaseResult | null> {\n    const translatedRegistryUrl = this.translateStream(registryUrl!);\n\n    const response = await this.http.getJson(\n      translatedRegistryUrl,\n      UnityReleasesJSON,\n    );\n\n    const result: ReleaseResult = {\n      releases: [],\n      homepage: Unity3dDatasource.homepage,\n      registryUrl: translatedRegistryUrl,\n    };\n\n    for (const release of response.body.results) {\n      result.releases.push({\n        version: withHash\n          ? `${release.version} (${release.shortRevision})`\n          : release.version,\n        releaseTimestamp: asTimestamp(release.releaseDate),\n        changelogUrl: release.releaseNotes.url,\n        isStable: translatedRegistryUrl === Unity3dDatasource.streams.lts,\n      });\n    }\n\n    return result;\n  }\n\n  @cache({\n    namespace: `datasource-${Unity3dDatasource.id}`,\n    key: ({ registryUrl, packageName }: GetReleasesConfig) =>\n      `${registryUrl}:${packageName}`,\n  })\n  async getReleases({\n    packageName,\n    registryUrl,\n  }: GetReleasesConfig): Promise<ReleaseResult | null> {\n    return await this.getByStream(\n      registryUrl,\n      packageName === 'm_EditorVersionWithRevision',\n    );\n  }\n}\n"]}