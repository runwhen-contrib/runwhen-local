{"version":3,"file":"common.js","sourceRoot":"","sources":["../../../../lib/modules/datasource/docker/common.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { parse } from 'auth-header';\nimport {\n  HOST_DISABLED,\n  PAGE_NOT_FOUND_ERROR,\n} from '../../../constants/error-messages';\nimport { logger } from '../../../logger';\nimport type { HostRule } from '../../../types';\nimport { ExternalHostError } from '../../../types/errors/external-host-error';\nimport { coerceArray } from '../../../util/array';\nimport { detectPlatform } from '../../../util/common';\nimport { parseGitUrl } from '../../../util/git/url';\nimport { toSha256 } from '../../../util/hash';\nimport * as hostRules from '../../../util/host-rules';\nimport type { Http } from '../../../util/http';\nimport { memCacheProvider } from '../../../util/http/cache/memory-http-cache-provider';\nimport type {\n  HttpOptions,\n  HttpResponse,\n  OutgoingHttpHeaders,\n} from '../../../util/http/types';\nimport { regEx } from '../../../util/regex';\nimport { addSecretForSanitizing } from '../../../util/sanitize';\nimport {\n  ensureTrailingSlash,\n  parseUrl,\n  trimTrailingSlash,\n} from '../../../util/url';\nimport { api as dockerVersioning } from '../../versioning/docker';\nimport { getGoogleAuthToken } from '../util';\nimport { ecrRegex, getECRAuthToken } from './ecr';\nimport { googleRegex } from './google';\nimport type { OciHelmConfig } from './schema';\nimport type { RegistryRepository } from './types';\n\nexport const dockerDatasourceId = 'docker';\n\nexport const imageUrlLabel = 'org.opencontainers.image.url';\n\nexport const sourceLabel = 'org.opencontainers.image.source';\nexport const sourceLabels = [sourceLabel, 'org.label-schema.vcs-url'] as const;\n\nexport const gitRefLabel = 'org.opencontainers.image.revision';\n\nexport const DOCKER_HUB = 'https://index.docker.io';\n\nexport function isDockerHost(host: string): boolean {\n  const regex = regEx(/(?:^|\\.)docker\\.io$/);\n  return regex.test(host);\n}\n\nexport async function getAuthHeaders(\n  http: Http,\n  registryHost: string,\n  dockerRepository: string,\n  apiCheckUrl = `${registryHost}/v2/`,\n): Promise<OutgoingHttpHeaders | null> {\n  try {\n    const options = {\n      throwHttpErrors: false,\n      noAuth: true,\n      cacheProvider: memCacheProvider,\n    };\n    const apiCheckResponse = apiCheckUrl.endsWith('/v2/')\n      ? await http.get(apiCheckUrl, options)\n      : // use json request, as this will be cached for tags, so it returns json\n        // TODO: add cache test\n        await http.getJsonUnchecked(apiCheckUrl, options);\n\n    if (apiCheckResponse.statusCode === 200) {\n      logger.debug(`No registry auth required for ${apiCheckUrl}`);\n      return {};\n    }\n    if (apiCheckResponse.statusCode === 404) {\n      logger.debug(`Page Not Found ${apiCheckUrl}`);\n      // throw error up to be caught and potentially retried with library/ prefix\n      throw new Error(PAGE_NOT_FOUND_ERROR);\n    }\n    if (\n      apiCheckResponse.statusCode !== 401 ||\n      !is.nonEmptyString(apiCheckResponse.headers['www-authenticate'])\n    ) {\n      logger.warn(\n        { apiCheckUrl, res: apiCheckResponse },\n        'Invalid registry response',\n      );\n      return null;\n    }\n\n    const authenticateHeader = parse(\n      apiCheckResponse.headers['www-authenticate'],\n    );\n\n    const opts: HostRule & HttpOptions = hostRules.find({\n      hostType: dockerDatasourceId,\n      url: apiCheckUrl,\n    });\n    if (ecrRegex.test(registryHost)) {\n      logger.once.debug(`hostRules: ecr auth for ${registryHost}`);\n      logger.trace(\n        { registryHost, dockerRepository },\n        `Using ecr auth for Docker registry`,\n      );\n      const [, region] = coerceArray(ecrRegex.exec(registryHost));\n      const auth = await getECRAuthToken(region, opts);\n      if (auth) {\n        opts.headers = { authorization: `Basic ${auth}` };\n      }\n    } else if (\n      googleRegex.test(registryHost) &&\n      typeof opts.username === 'undefined' &&\n      typeof opts.password === 'undefined' &&\n      typeof opts.token === 'undefined'\n    ) {\n      logger.once.debug(`hostRules: google auth for ${registryHost}`);\n      logger.trace(\n        { registryHost, dockerRepository },\n        `Using google auth for Docker registry`,\n      );\n      const auth = await getGoogleAuthToken();\n      if (auth) {\n        opts.headers = { authorization: `Basic ${auth}` };\n      } else {\n        logger.once.debug(\n          { registryHost, dockerRepository },\n          'Could not get Google access token, using no auth',\n        );\n      }\n    } else if (opts.username && opts.password) {\n      logger.once.debug(`hostRules: basic auth for ${registryHost}`);\n      logger.trace(\n        { registryHost, dockerRepository },\n        `Using basic auth for Docker registry`,\n      );\n      const auth = Buffer.from(`${opts.username}:${opts.password}`).toString(\n        'base64',\n      );\n      opts.headers = { authorization: `Basic ${auth}` };\n    } else if (opts.token) {\n      const authType = opts.authType ?? 'Bearer';\n      logger.once.debug(\n        `hostRules: ${authType} token auth for ${registryHost}`,\n      );\n      logger.trace(\n        { registryHost, dockerRepository },\n        `Using ${authType} token for Docker registry`,\n      );\n      opts.headers = { authorization: `${authType} ${opts.token}` };\n    }\n    delete opts.username;\n    delete opts.password;\n    delete opts.token;\n\n    // If realm isn't an url, we should directly use auth header\n    // Can happen when we get a Basic auth or some other auth type\n    // * WWW-Authenticate: Basic realm=\"Artifactory Realm\"\n    // * Www-Authenticate: Basic realm=\"https://123456789.dkr.ecr.eu-central-1.amazonaws.com/\",service=\"ecr.amazonaws.com\"\n    // * www-authenticate: Bearer realm=\"https://ghcr.io/token\",service=\"ghcr.io\",scope=\"repository:user/image:pull\"\n    // * www-authenticate: Bearer realm=\"https://auth.docker.io/token\",service=\"registry.docker.io\"\n    if (\n      authenticateHeader.scheme.toUpperCase() !== 'BEARER' ||\n      !is.string(authenticateHeader.params.realm) ||\n      parseUrl(authenticateHeader.params.realm) === null\n    ) {\n      logger.once.debug(`hostRules: testing direct auth for ${registryHost}`);\n      logger.trace(\n        { registryHost, dockerRepository, authenticateHeader },\n        `Invalid realm, testing direct auth`,\n      );\n      return opts.headers ?? null;\n    }\n\n    const authUrl = new URL(`${authenticateHeader.params.realm}`);\n\n    // repo isn't known to server yet, so causing wrong scope `repository:user/image:pull`\n    if (\n      is.string(authenticateHeader.params.scope) &&\n      !apiCheckUrl.endsWith('/v2/')\n    ) {\n      authUrl.searchParams.append('scope', authenticateHeader.params.scope);\n    } else {\n      authUrl.searchParams.append(\n        'scope',\n        `repository:${dockerRepository}:pull`,\n      );\n    }\n\n    if (is.string(authenticateHeader.params.service)) {\n      authUrl.searchParams.append('service', authenticateHeader.params.service);\n    }\n\n    logger.trace(\n      { registryHost, dockerRepository, authUrl: authUrl.href },\n      `Obtaining docker registry token`,\n    );\n    opts.noAuth = true;\n    opts.cacheProvider = memCacheProvider;\n    const authResponse = (\n      await http.getJsonUnchecked<{ token?: string; access_token?: string }>(\n        authUrl.href,\n        opts,\n      )\n    ).body;\n\n    const token = authResponse.token ?? authResponse.access_token;\n    /* v8 ignore next 4 -- TODO: add test */\n    if (!token) {\n      logger.warn('Failed to obtain docker registry token');\n      return null;\n    }\n    // sanitize token\n    addSecretForSanitizing(token);\n    return {\n      authorization: `Bearer ${token}`,\n    };\n  } catch (err) /* istanbul ignore next */ {\n    if (err.host === 'quay.io') {\n      // TODO: debug why quay throws errors (#9604)\n      return null;\n    }\n    if (err.statusCode === 401) {\n      logger.debug(\n        { registryHost, dockerRepository },\n        'Unauthorized docker lookup',\n      );\n      logger.debug({ err });\n      return null;\n    }\n    if (err.statusCode === 403) {\n      logger.debug(\n        { registryHost, dockerRepository },\n        'Not allowed to access docker registry',\n      );\n      logger.debug({ err });\n      return null;\n    }\n    if (err.name === 'RequestError' && isDockerHost(registryHost)) {\n      throw new ExternalHostError(err);\n    }\n    if (err.statusCode === 429 && isDockerHost(registryHost)) {\n      throw new ExternalHostError(err);\n    }\n    if (err.statusCode >= 500 && err.statusCode < 600) {\n      throw new ExternalHostError(err);\n    }\n    if (err.message === PAGE_NOT_FOUND_ERROR) {\n      throw err;\n    }\n    if (err.message === HOST_DISABLED) {\n      logger.trace({ registryHost, dockerRepository, err }, 'Host disabled');\n      return null;\n    }\n    logger.warn(\n      { registryHost, dockerRepository, err },\n      'Error obtaining docker token',\n    );\n    return null;\n  }\n}\n\nexport function getRegistryRepository(\n  packageName: string,\n  registryUrl: string,\n): RegistryRepository {\n  if (registryUrl !== DOCKER_HUB) {\n    const registryEndingWithSlash = ensureTrailingSlash(\n      registryUrl.replace(regEx(/^https?:\\/\\//), ''),\n    );\n    if (packageName.startsWith(registryEndingWithSlash)) {\n      let registryHost = trimTrailingSlash(registryUrl);\n      if (!regEx(/^https?:\\/\\//).test(registryHost)) {\n        registryHost = `https://${registryHost}`;\n      }\n      let dockerRepository = packageName.replace(registryEndingWithSlash, '');\n      const fullUrl = `${registryHost}/${dockerRepository}`;\n      const { origin, pathname } = parseUrl(fullUrl)!;\n      registryHost = origin;\n      dockerRepository = pathname.substring(1);\n      return {\n        registryHost,\n        dockerRepository,\n      };\n    }\n  }\n  let registryHost = registryUrl;\n  const split = packageName.split('/');\n  if (split.length > 1 && (split[0].includes('.') || split[0].includes(':'))) {\n    [registryHost] = split;\n    split.shift();\n  }\n  let dockerRepository = split.join('/');\n\n  if (!regEx(/^https?:\\/\\//).test(registryHost)) {\n    registryHost = `https://${registryHost}`;\n  }\n\n  const { path, base } =\n    regEx(/^(?<base>https:\\/\\/[^/]+)\\/(?<path>.+)$/).exec(registryHost)\n      ?.groups ?? {};\n  if (base && path) {\n    registryHost = base;\n    dockerRepository = `${trimTrailingSlash(path)}/${dockerRepository}`;\n  }\n\n  registryHost = registryHost\n    .replace('https://docker.io', 'https://index.docker.io')\n    .replace('https://registry-1.docker.io', 'https://index.docker.io');\n\n  const opts = hostRules.find({\n    hostType: dockerDatasourceId,\n    url: registryHost,\n  });\n  if (opts?.insecureRegistry) {\n    registryHost = registryHost.replace('https', 'http');\n  }\n  if (registryHost.endsWith('.docker.io') && !dockerRepository.includes('/')) {\n    dockerRepository = 'library/' + dockerRepository;\n  }\n  return {\n    registryHost,\n    dockerRepository,\n  };\n}\n\nexport function extractDigestFromResponseBody(\n  manifestResponse: HttpResponse,\n): string {\n  return 'sha256:' + toSha256(manifestResponse.body);\n}\n\nexport function findLatestStable(tags: string[]): string | null {\n  let stable: string | null = null;\n\n  for (const tag of tags) {\n    if (!dockerVersioning.isValid(tag) || !dockerVersioning.isStable(tag)) {\n      continue;\n    }\n\n    if (!stable || dockerVersioning.isGreaterThan(tag, stable)) {\n      stable = tag;\n    }\n  }\n\n  return stable;\n}\n\nconst chartRepo = regEx(/charts?|helm|helm-charts?/i);\n\nfunction isPossibleChartRepo(url: string): boolean {\n  if (detectPlatform(url) === null) {\n    return false;\n  }\n\n  const parsed = parseGitUrl(url);\n  return chartRepo.test(parsed.name);\n}\n\nexport function findHelmSourceUrl(release: OciHelmConfig): string | null {\n  if (release.home && isPossibleChartRepo(release.home)) {\n    return release.home;\n  }\n\n  if (!release.sources?.length) {\n    return null;\n  }\n\n  for (const url of release.sources) {\n    if (isPossibleChartRepo(url)) {\n      return url;\n    }\n  }\n\n  // fallback\n  return release.sources[0];\n}\n"]}