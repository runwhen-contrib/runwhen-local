{"version":3,"file":"ecr.js","sourceRoot":"","sources":["../../../../lib/modules/datasource/docker/ecr.ts"],"names":[],"mappings":";;;AAcA,0CAsCC;AAED,oDAUC;AA/DD,oDAA0C;AAC1C,4CAAyC;AAIzC,+CAA4C;AAC5C,qDAAgE;AAEnD,QAAA,QAAQ,GAAG,IAAA,aAAK,EAC3B,uDAAuD,CACxD,CAAC;AACW,QAAA,cAAc,GAAG,IAAA,aAAK,EAAC,kBAAkB,CAAC,CAAC;AAEjD,KAAK,UAAU,eAAe,CACnC,MAAc,EACd,IAAc;IAEd,MAAM,MAAM,GAAoB,EAAE,MAAM,EAAE,CAAC;IAC3C,IAAI,IAAI,CAAC,QAAQ,KAAK,KAAK,IAAI,IAAI,CAAC,QAAQ,EAAE,CAAC;QAC7C,eAAM,CAAC,KAAK,CACV,sEAAsE,CACvE,CAAC;QACF,OAAO,MAAM,CAAC,IAAI,CAAC,OAAO,IAAI,CAAC,QAAQ,EAAE,CAAC,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;IAChE,CAAC;SAAM,IAAI,IAAI,CAAC,QAAQ,IAAI,IAAI,CAAC,QAAQ,EAAE,CAAC;QAC1C,eAAM,CAAC,KAAK,CACV,iEAAiE,CAClE,CAAC;QACF,MAAM,CAAC,WAAW,GAAG;YACnB,WAAW,EAAE,IAAI,CAAC,QAAQ;YAC1B,eAAe,EAAE,IAAI,CAAC,QAAQ;YAC9B,GAAG,CAAC,IAAI,CAAC,KAAK,IAAI,EAAE,YAAY,EAAE,IAAI,CAAC,KAAK,EAAE,CAAC;SAChD,CAAC;IACJ,CAAC;IAED,MAAM,GAAG,GAAG,IAAI,gBAAG,CAAC,MAAM,CAAC,CAAC;IAC5B,IAAI,CAAC;QACH,MAAM,IAAI,GAAG,MAAM,GAAG,CAAC,qBAAqB,CAAC,EAAE,CAAC,CAAC;QACjD,MAAM,kBAAkB,GAAG,IAAI,EAAE,iBAAiB,EAAE,CAAC,CAAC,CAAC,EAAE,kBAAkB,CAAC;QAC5E,IAAI,kBAAkB,EAAE,CAAC;YACvB,iBAAiB;YACjB,IAAA,iCAAsB,EAAC,kBAAkB,CAAC,CAAC;YAC3C,OAAO,kBAAkB,CAAC;QAC5B,CAAC;QACD,eAAM,CAAC,IAAI,CACT,8EAA8E,CAC/E,CAAC;IACJ,CAAC;IAAC,OAAO,GAAG,EAAE,CAAC;QACb,eAAM,CAAC,KAAK,CAAC,EAAE,GAAG,EAAE,EAAE,KAAK,CAAC,CAAC;QAC7B,eAAM,CAAC,IAAI,CAAC,iCAAiC,CAAC,CAAC;IACjD,CAAC;IACD,OAAO,IAAI,CAAC;AACd,CAAC;AAED,SAAgB,oBAAoB,CAAC,GAAc;IACjD,MAAM,IAAI,GAAG,GAAG,CAAC,QAAyC,CAAC;IAC3D,OAAO,CAAC,CAAC,CACP,IAAI,EAAE,UAAU,KAAK,GAAG;QACxB,IAAI,CAAC,OAAO,EAAE,CAAC,iCAAiC,CAAC;QACjD,sIAAsI;QACtI,IAAI,CAAC,IAAI,EAAE,MAAM,EAAE,CAAC,CAAC,CAAC,EAAE,OAAO,EAAE,QAAQ,CACvC,mDAAmD,CACpD,CACF,CAAC;AACJ,CAAC","sourcesContent":["import type { ECRClientConfig } from '@aws-sdk/client-ecr';\nimport { ECR } from '@aws-sdk/client-ecr';\nimport { logger } from '../../../logger';\nimport type { HostRule } from '../../../types';\nimport type { HttpError } from '../../../util/http';\nimport type { HttpResponse } from '../../../util/http/types';\nimport { regEx } from '../../../util/regex';\nimport { addSecretForSanitizing } from '../../../util/sanitize';\n\nexport const ecrRegex = regEx(\n  /\\d+\\.dkr\\.ecr(?:-fips)?\\.([-a-z0-9]+)\\.amazonaws\\.com/,\n);\nexport const ecrPublicRegex = regEx(/public\\.ecr\\.aws/);\n\nexport async function getECRAuthToken(\n  region: string,\n  opts: HostRule,\n): Promise<string | null> {\n  const config: ECRClientConfig = { region };\n  if (opts.username === `AWS` && opts.password) {\n    logger.trace(\n      `AWS user specified, encoding basic auth credentials for ECR registry`,\n    );\n    return Buffer.from(`AWS:${opts.password}`).toString('base64');\n  } else if (opts.username && opts.password) {\n    logger.trace(\n      `Using AWS accessKey to get Authorization token for ECR registry`,\n    );\n    config.credentials = {\n      accessKeyId: opts.username,\n      secretAccessKey: opts.password,\n      ...(opts.token && { sessionToken: opts.token }),\n    };\n  }\n\n  const ecr = new ECR(config);\n  try {\n    const data = await ecr.getAuthorizationToken({});\n    const authorizationToken = data?.authorizationData?.[0]?.authorizationToken;\n    if (authorizationToken) {\n      // sanitize token\n      addSecretForSanitizing(authorizationToken);\n      return authorizationToken;\n    }\n    logger.warn(\n      'Could not extract authorizationToken from ECR getAuthorizationToken response',\n    );\n  } catch (err) {\n    logger.trace({ err }, 'err');\n    logger.warn('ECR getAuthorizationToken error');\n  }\n  return null;\n}\n\nexport function isECRMaxResultsError(err: HttpError): boolean {\n  const resp = err.response as HttpResponse<any> | undefined;\n  return !!(\n    resp?.statusCode === 405 &&\n    resp.headers?.['docker-distribution-api-version'] &&\n    // https://docs.aws.amazon.com/AmazonECR/latest/APIReference/API_DescribeRepositories.html#ECR-DescribeRepositories-request-maxResults\n    resp.body?.errors?.[0]?.message?.includes(\n      'Member must have value less than or equal to 1000',\n    )\n  );\n}\n"]}