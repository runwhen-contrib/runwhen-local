{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../lib/modules/datasource/pod/index.ts"],"names":[],"mappings":";;;;AAAA,sEAAiC;AACjC,sEAAkE;AAClE,4CAAyC;AACzC,mFAA8E;AAC9E,qEAA8D;AAE9D,sDAAuD;AACvD,+CAA0D;AAC1D,8CAA2C;AAC3C,0CAA+C;AAS/C,SAAS,UAAU,CAAC,WAAmB;IACrC,OAAO,qBAAM;SACV,UAAU,CAAC,KAAK,CAAC;SACjB,MAAM,CAAC,WAAW,CAAC;SACnB,MAAM,CAAC,KAAK,CAAC;SACb,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC;SACX,KAAK,CAAC,EAAE,CAAC,CAAC;AACf,CAAC;AAED,MAAM,WAAW,GAAG,IAAA,aAAK,EACvB,2FAA2F,CAC5F,CAAC;AAEF,SAAS,iBAAiB,CACxB,WAAmB,EACnB,IAMC;IAED,MAAM,EAAE,OAAO,EAAE,OAAO,EAAE,IAAI,EAAE,QAAQ,EAAE,QAAQ,EAAE,GAAG,IAAI,CAAC;IAC5D,MAAM,MAAM,GACV,OAAO,IAAI,OAAO,KAAK,oBAAoB;QACzC,CAAC,CAAC,GAAG,OAAO,eAAe;QAC3B,CAAC,CAAC,8BAA8B,CAAC;IACrC,MAAM,KAAK,GAAG,UAAU,CAAC,WAAW,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;IAChD,+GAA+G;IAC/G,MAAM,eAAe,GAAG,QAAQ,CAAC,CAAC,CAAC,SAAS,WAAW,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC;IACxE,MAAM,SAAS,GAAG,QAAQ;QACxB,CAAC,CAAC,SAAS,KAAK,IAAI,WAAW,EAAE;QACjC,CAAC,CAAC,GAAG,KAAK,IAAI,WAAW,EAAE,CAAC;IAC9B,MAAM,MAAM,GAAG,QAAQ,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,eAAe,CAAC;IACtD,OAAO,GAAG,MAAM,IAAI,OAAO,IAAI,IAAI,aAAa,MAAM,EAAE,CAAC;AAC3D,CAAC;AAED,SAAS,WAAW,CAAC,WAAmB,EAAE,GAAc;IACtD,MAAM,SAAS,GAAG,EAAE,WAAW,EAAE,GAAG,EAAE,CAAC;IAEvC,MAAM,UAAU,GAAG,GAAG,CAAC,QAAQ,EAAE,UAAU,IAAI,CAAC,CAAC;IACjD,IAAI,UAAU,KAAK,GAAG,IAAI,CAAC,UAAU,IAAI,GAAG,IAAI,UAAU,GAAG,GAAG,CAAC,EAAE,CAAC;QAClE,eAAM,CAAC,IAAI,CAAC,EAAE,WAAW,EAAE,GAAG,EAAE,EAAE,4BAA4B,CAAC,CAAC;QAChE,MAAM,IAAI,uCAAiB,CAAC,GAAG,CAAC,CAAC;IACnC,CAAC;IAED,IAAI,UAAU,KAAK,GAAG,EAAE,CAAC;QACvB,eAAM,CAAC,KAAK,CAAC,SAAS,EAAE,qBAAqB,CAAC,CAAC;IACjD,CAAC;SAAM,IAAI,UAAU,KAAK,GAAG,EAAE,CAAC;QAC9B,eAAM,CAAC,KAAK,CAAC,SAAS,EAAE,sBAAsB,CAAC,CAAC;IAClD,CAAC;SAAM,IAAI,GAAG,CAAC,OAAO,KAAK,8BAAa,EAAE,CAAC;QACzC,eAAM,CAAC,KAAK,CAAC,SAAS,EAAE,eAAe,CAAC,CAAC;IAC3C,CAAC;SAAM,CAAC;QACN,eAAM,CAAC,IAAI,CAAC,SAAS,EAAE,yCAAyC,CAAC,CAAC;IACpE,CAAC;AACH,CAAC;AAED,SAAS,aAAa,CAAC,GAAW;IAChC,MAAM,KAAK,GAAG,WAAW,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;IACpC,IAAI,KAAK,EAAE,MAAM,EAAE,CAAC;QAClB,MAAM,EAAE,OAAO,EAAE,IAAI,EAAE,GAAG,KAAK,CAAC,MAAM,CAAC;QACvC,OAAO,CACL,OAAO,CAAC,WAAW,EAAE,KAAK,WAAW,IAAI,IAAI,CAAC,WAAW,EAAE,KAAK,OAAO,CACxE,CAAC,CAAC,yCAAyC;IAC9C,CAAC;IACD,OAAO,KAAK,CAAC;AACf,CAAC;AAED,SAAS,cAAc,CAAC,WAAmB,EAAE,WAAmB;IAC9D,MAAM,KAAK,GAAG,UAAU,CAAC,WAAW,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;IAChD,OAAO,GAAG,WAAW,sBAAsB,KAAK,MAAM,CAAC;AACzD,CAAC;AAED,MAAa,aAAc,SAAQ,uBAAU;IAC3C,MAAM,CAAU,EAAE,GAAG,KAAK,CAAC;IAET,mBAAmB,GAAG,CAAC,2BAA2B,CAAC,CAAC;IAEpD,gBAAgB,GAAG,MAAM,CAAC;IAE5C,UAAU,CAAa;IAEvB;QACE,KAAK,CAAC,aAAa,CAAC,EAAE,CAAC,CAAC;QACxB,IAAI,CAAC,UAAU,GAAG,IAAI,mBAAU,CAAC,aAAa,CAAC,EAAE,CAAC,CAAC;IACrD,CAAC;IAEO,KAAK,CAAC,UAAU,CACtB,GAAW,EACX,WAAmB;QAEnB,IAAI,CAAC;YACH,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;YAC1C,IAAI,IAAI,EAAE,IAAI,EAAE,CAAC;gBACf,OAAO,IAAI,CAAC,IAAI,CAAC;YACnB,CAAC;QACH,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACb,WAAW,CAAC,WAAW,EAAE,GAAG,CAAC,CAAC;QAChC,CAAC;QAED,OAAO,IAAI,CAAC;IACd,CAAC;IAEO,KAAK,CAAC,aAAa,CACzB,GAAW,EACX,WAAmB;QAEnB,IAAI,CAAC;YACH,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,UAAU,CAAC,gBAAgB,CAAI,GAAG,CAAC,CAAC;YAC5D,IAAI,IAAI,EAAE,IAAI,EAAE,CAAC;gBACf,OAAO,IAAI,CAAC,IAAI,CAAC;YACnB,CAAC;QACH,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACb,WAAW,CAAC,WAAW,EAAE,GAAG,CAAC,CAAC;QAChC,CAAC;QAED,OAAO,IAAI,CAAC;IACd,CAAC;IAEO,KAAK,CAAC,qBAAqB,CACjC,WAAmB,EACnB,IAAwD,EACxD,QAAQ,GAAG,IAAI,EACf,QAAQ,GAAG,IAAI,EACf,mBAAqC,mBAAmB;QAExD,MAAM,GAAG,GAAG,iBAAiB,CAAC,WAAW,EAAE,EAAE,GAAG,IAAI,EAAE,QAAQ,EAAE,QAAQ,EAAE,CAAC,CAAC;QAC5E,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,aAAa,CAAqB,GAAG,EAAE,WAAW,CAAC,CAAC;QAC5E,IAAI,IAAI,EAAE,CAAC;YACT,MAAM,QAAQ,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,IAAI,EAAE,EAAE,EAAE,CAAC,CAAC,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC;YAC7D,OAAO,EAAE,QAAQ,EAAE,CAAC;QACtB,CAAC;QAED,gCAAgC;QAChC,QAAQ,gBAAgB,EAAE,CAAC;YACzB,KAAK,mBAAmB;gBACtB,OAAO,IAAI,CAAC,qBAAqB,CAC/B,WAAW,EACX,IAAI,EACJ,IAAI,EACJ,KAAK,EACL,sBAAsB,CACvB,CAAC;YACJ,KAAK,sBAAsB;gBACzB,OAAO,IAAI,CAAC,qBAAqB,CAC/B,WAAW,EACX,IAAI,EACJ,KAAK,EACL,IAAI,EACJ,uBAAuB,CACxB,CAAC;YACJ,KAAK,uBAAuB;gBAC1B,OAAO,IAAI,CAAC,qBAAqB,CAC/B,WAAW,EACX,IAAI,EACJ,KAAK,EACL,KAAK,EACL,0BAA0B,CAC3B,CAAC;YACJ,KAAK,0BAA0B,CAAC;YAChC;gBACE,OAAO,IAAI,CAAC;QAChB,CAAC;IACH,CAAC;IAEO,KAAK,CAAC,kBAAkB,CAC9B,WAAmB,EACnB,WAAmB;QAEnB,MAAM,GAAG,GAAG,cAAc,CAAC,WAAW,EAAE,WAAW,CAAC,CAAC;QACrD,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,UAAU,CAAC,GAAG,EAAE,WAAW,CAAC,CAAC;QACrD,IAAI,IAAI,EAAE,CAAC;YACT,MAAM,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,oBAAY,CAAC,CAAC;YACvC,KAAK,MAAM,IAAI,IAAI,KAAK,EAAE,CAAC;gBACzB,MAAM,CAAC,IAAI,EAAE,GAAG,QAAQ,CAAC,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;gBAC5C,IAAI,IAAI,KAAK,WAAW,CAAC,OAAO,CAAC,IAAA,aAAK,EAAC,OAAO,CAAC,EAAE,EAAE,CAAC,EAAE,CAAC;oBACrD,MAAM,QAAQ,GAAG,QAAQ,CAAC,GAAG,CAAC,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC,EAAE,OAAO,EAAE,CAAC,CAAC,CAAC;oBAC1D,OAAO,EAAE,QAAQ,EAAE,CAAC;gBACtB,CAAC;YACH,CAAC;QACH,CAAC;QACD,OAAO,IAAI,CAAC;IACd,CAAC;IASK,AAAN,KAAK,CAAC,WAAW,CAAC,EAChB,WAAW,EACX,WAAW,GACO;QAClB,6CAA6C;QAC7C,IAAI,CAAC,WAAW,EAAE,CAAC;YACjB,OAAO,IAAI,CAAC;QACd,CAAC;QAED,MAAM,OAAO,GAAG,WAAW,CAAC,OAAO,CAAC,IAAA,aAAK,EAAC,OAAO,CAAC,EAAE,EAAE,CAAC,CAAC;QACxD,IAAI,OAAO,GAAG,WAAW,CAAC,OAAO,CAAC,IAAA,aAAK,EAAC,MAAM,CAAC,EAAE,EAAE,CAAC,CAAC;QACrD,6DAA6D;QAC7D,IAAI,aAAa,CAAC,OAAO,CAAC,EAAE,CAAC;YAC3B,CAAC,OAAO,CAAC,GAAG,IAAI,CAAC,mBAAmB,CAAC;QACvC,CAAC;QAED,IAAI,MAAM,GAAyB,IAAI,CAAC;QACxC,MAAM,KAAK,GAAG,WAAW,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QACxC,IAAI,KAAK,EAAE,MAAM,EAAE,CAAC;YAClB,OAAO,GAAG,IAAA,2BAAgB,EAAC,OAAO,CAAC,CAAC;YACpC,MAAM,EAAE,OAAO,EAAE,OAAO,EAAE,IAAI,EAAE,GAAG,KAAK,CAAC,MAAM,CAAC;YAChD,MAAM,IAAI,GAAG,EAAE,OAAO,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC;YACxC,MAAM,GAAG,MAAM,IAAI,CAAC,qBAAqB,CAAC,OAAO,EAAE,IAAI,CAAC,CAAC;QAC3D,CAAC;aAAM,CAAC;YACN,MAAM,GAAG,MAAM,IAAI,CAAC,kBAAkB,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;QAC3D,CAAC;QAED,OAAO,MAAM,CAAC;IAChB,CAAC;;AAlJH,sCAmJC;AA7BO;IAPL,IAAA,iBAAK,EAAC;QACL,UAAU,EAAE,EAAE;QACd,SAAS,EAAE,cAAc,aAAa,CAAC,EAAE,EAAE;QAC3C,GAAG,EAAE,CAAC,EAAE,WAAW,EAAE,WAAW,EAAqB,EAAE,EAAE;QACvD,uBAAuB;QACvB,GAAG,WAAW,IAAI,WAAW,EAAE;KAClC,CAAC;gDA6BD","sourcesContent":["import crypto from 'node:crypto';\nimport { HOST_DISABLED } from '../../../constants/error-messages';\nimport { logger } from '../../../logger';\nimport { ExternalHostError } from '../../../types/errors/external-host-error';\nimport { cache } from '../../../util/cache/package/decorator';\nimport type { HttpError } from '../../../util/http';\nimport { GithubHttp } from '../../../util/http/github';\nimport { newlineRegex, regEx } from '../../../util/regex';\nimport { Datasource } from '../datasource';\nimport { massageGithubUrl } from '../metadata';\nimport type { GetReleasesConfig, ReleaseResult } from '../types';\n\ntype URLFormatOptions =\n  | 'withShardWithSpec'\n  | 'withShardWithoutSpec'\n  | 'withSpecsWithoutShard'\n  | 'withoutSpecsWithoutShard';\n\nfunction shardParts(packageName: string): string[] {\n  return crypto\n    .createHash('md5')\n    .update(packageName)\n    .digest('hex')\n    .slice(0, 3)\n    .split('');\n}\n\nconst githubRegex = regEx(\n  /(?<hostURL>^https:\\/\\/[a-zA-Z0-9-.]+)\\/(?<account>[^/]+)\\/(?<repo>[^/]+?)(?:\\.git|\\/.*)?$/,\n);\n\nfunction releasesGithubUrl(\n  packageName: string,\n  opts: {\n    hostURL: string;\n    account: string;\n    repo: string;\n    useShard: boolean;\n    useSpecs: boolean;\n  },\n): string {\n  const { hostURL, account, repo, useShard, useSpecs } = opts;\n  const prefix =\n    hostURL && hostURL !== 'https://github.com'\n      ? `${hostURL}/api/v3/repos`\n      : 'https://api.github.com/repos';\n  const shard = shardParts(packageName).join('/');\n  // `Specs` in the pods repo URL is a new requirement for legacy support also allow pod repo URL without `Specs`\n  const packageNamePath = useSpecs ? `Specs/${packageName}` : packageName;\n  const shardPath = useSpecs\n    ? `Specs/${shard}/${packageName}`\n    : `${shard}/${packageName}`;\n  const suffix = useShard ? shardPath : packageNamePath;\n  return `${prefix}/${account}/${repo}/contents/${suffix}`;\n}\n\nfunction handleError(packageName: string, err: HttpError): void {\n  const errorData = { packageName, err };\n\n  const statusCode = err.response?.statusCode ?? 0;\n  if (statusCode === 429 || (statusCode >= 500 && statusCode < 600)) {\n    logger.warn({ packageName, err }, `CocoaPods registry failure`);\n    throw new ExternalHostError(err);\n  }\n\n  if (statusCode === 401) {\n    logger.debug(errorData, 'Authorization error');\n  } else if (statusCode === 404) {\n    logger.debug(errorData, 'Package lookup error');\n  } else if (err.message === HOST_DISABLED) {\n    logger.trace(errorData, 'Host disabled');\n  } else {\n    logger.warn(errorData, 'CocoaPods lookup failure: Unknown error');\n  }\n}\n\nfunction isDefaultRepo(url: string): boolean {\n  const match = githubRegex.exec(url);\n  if (match?.groups) {\n    const { account, repo } = match.groups;\n    return (\n      account.toLowerCase() === 'cocoapods' && repo.toLowerCase() === 'specs'\n    ); // https://github.com/CocoaPods/Specs.git\n  }\n  return false;\n}\n\nfunction releasesCDNUrl(packageName: string, registryUrl: string): string {\n  const shard = shardParts(packageName).join('_');\n  return `${registryUrl}/all_pods_versions_${shard}.txt`;\n}\n\nexport class PodDatasource extends Datasource {\n  static readonly id = 'pod';\n\n  override readonly defaultRegistryUrls = ['https://cdn.cocoapods.org'];\n\n  override readonly registryStrategy = 'hunt';\n\n  githubHttp: GithubHttp;\n\n  constructor() {\n    super(PodDatasource.id);\n    this.githubHttp = new GithubHttp(PodDatasource.id);\n  }\n\n  private async requestCDN(\n    url: string,\n    packageName: string,\n  ): Promise<string | null> {\n    try {\n      const resp = await this.http.getText(url);\n      if (resp?.body) {\n        return resp.body;\n      }\n    } catch (err) {\n      handleError(packageName, err);\n    }\n\n    return null;\n  }\n\n  private async requestGithub<T = unknown>(\n    url: string,\n    packageName: string,\n  ): Promise<T | null> {\n    try {\n      const resp = await this.githubHttp.getJsonUnchecked<T>(url);\n      if (resp?.body) {\n        return resp.body;\n      }\n    } catch (err) {\n      handleError(packageName, err);\n    }\n\n    return null;\n  }\n\n  private async getReleasesFromGithub(\n    packageName: string,\n    opts: { hostURL: string; account: string; repo: string },\n    useShard = true,\n    useSpecs = true,\n    urlFormatOptions: URLFormatOptions = 'withShardWithSpec',\n  ): Promise<ReleaseResult | null> {\n    const url = releasesGithubUrl(packageName, { ...opts, useShard, useSpecs });\n    const resp = await this.requestGithub<{ name: string }[]>(url, packageName);\n    if (resp) {\n      const releases = resp.map(({ name }) => ({ version: name }));\n      return { releases };\n    }\n\n    // support different url formats\n    switch (urlFormatOptions) {\n      case 'withShardWithSpec':\n        return this.getReleasesFromGithub(\n          packageName,\n          opts,\n          true,\n          false,\n          'withShardWithoutSpec',\n        );\n      case 'withShardWithoutSpec':\n        return this.getReleasesFromGithub(\n          packageName,\n          opts,\n          false,\n          true,\n          'withSpecsWithoutShard',\n        );\n      case 'withSpecsWithoutShard':\n        return this.getReleasesFromGithub(\n          packageName,\n          opts,\n          false,\n          false,\n          'withoutSpecsWithoutShard',\n        );\n      case 'withoutSpecsWithoutShard':\n      default:\n        return null;\n    }\n  }\n\n  private async getReleasesFromCDN(\n    packageName: string,\n    registryUrl: string,\n  ): Promise<ReleaseResult | null> {\n    const url = releasesCDNUrl(packageName, registryUrl);\n    const resp = await this.requestCDN(url, packageName);\n    if (resp) {\n      const lines = resp.split(newlineRegex);\n      for (const line of lines) {\n        const [name, ...versions] = line.split('/');\n        if (name === packageName.replace(regEx(/\\/.*$/), '')) {\n          const releases = versions.map((version) => ({ version }));\n          return { releases };\n        }\n      }\n    }\n    return null;\n  }\n\n  @cache({\n    ttlMinutes: 30,\n    namespace: `datasource-${PodDatasource.id}`,\n    key: ({ packageName, registryUrl }: GetReleasesConfig) =>\n      // TODO: types (#22198)\n      `${registryUrl}:${packageName}`,\n  })\n  async getReleases({\n    packageName,\n    registryUrl,\n  }: GetReleasesConfig): Promise<ReleaseResult | null> {\n    /* v8 ignore next 3 -- should never happen */\n    if (!registryUrl) {\n      return null;\n    }\n\n    const podName = packageName.replace(regEx(/\\/.*$/), '');\n    let baseUrl = registryUrl.replace(regEx(/\\/+$/), '');\n    // In order to not abuse github API limits, query CDN instead\n    if (isDefaultRepo(baseUrl)) {\n      [baseUrl] = this.defaultRegistryUrls;\n    }\n\n    let result: ReleaseResult | null = null;\n    const match = githubRegex.exec(baseUrl);\n    if (match?.groups) {\n      baseUrl = massageGithubUrl(baseUrl);\n      const { hostURL, account, repo } = match.groups;\n      const opts = { hostURL, account, repo };\n      result = await this.getReleasesFromGithub(podName, opts);\n    } else {\n      result = await this.getReleasesFromCDN(podName, baseUrl);\n    }\n\n    return result;\n  }\n}\n"]}