{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../lib/modules/datasource/flutter-version/index.ts"],"names":[],"mappings":";;;AAAA,+CAA4C;AAC5C,uDAAsD;AACtD,oDAAyD;AACzD,8CAA2C;AAI9B,QAAA,kBAAkB,GAAG,IAAA,aAAK,EAAC,iBAAiB,CAAC,CAAC;AAE3D,MAAa,wBAAyB,SAAQ,uBAAU;IACtD,MAAM,CAAU,EAAE,GAAG,iBAAiB,CAAC;IAEvC;QACE,KAAK,CAAC,wBAAwB,CAAC,EAAE,CAAC,CAAC;IACrC,CAAC;IAEiB,qBAAqB,GAAG,KAAK,CAAC;IAE9B,mBAAmB,GAAG,CAAC,gCAAgC,CAAC,CAAC;IAEzD,OAAO,GAAG,IAAI,CAAC;IAEf,iBAAiB,GAAG,WAAQ,CAAC;IAE7B,uBAAuB,GAAG,IAAI,CAAC;IAC/B,oBAAoB,GACpC,mFAAmF,CAAC;IACpE,gBAAgB,GAAG,SAAS,CAAC;IAC7B,aAAa,GAC7B,qDAAqD,CAAC;IAExD,KAAK,CAAC,WAAW,CAAC,EAChB,WAAW,GACO;QAClB,6CAA6C;QAC7C,IAAI,CAAC,WAAW,EAAE,CAAC;YACjB,OAAO,IAAI,CAAC;QACd,CAAC;QACD,MAAM,MAAM,GAAkB;YAC5B,QAAQ,EAAE,qBAAqB;YAC/B,SAAS,EAAE,oCAAoC;YAC/C,WAAW;YACX,QAAQ,EAAE,EAAE;SACb,CAAC;QACF,IAAI,CAAC;YACH,MAAM,IAAI,GAAG,CACX,MAAM,IAAI,CAAC,IAAI,CAAC,gBAAgB,CAC9B,GAAG,WAAW,qDAAqD,CACpE,CACF,CAAC,IAAI,CAAC;YACP,MAAM,CAAC,QAAQ,GAAG,IAAI,CAAC,QAAQ;gBAC7B,4EAA4E;gBAC5E,qDAAqD;iBACpD,MAAM,CAAC,CAAC,EAAE,OAAO,EAAE,OAAO,EAAE,EAAE,EAAE;gBAC/B,IAAI,0BAAkB,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC;oBACrC,OAAO,OAAO,KAAK,QAAQ,CAAC;gBAC9B,CAAC;gBACD,OAAO,IAAI,CAAC;YACd,CAAC,CAAC;iBACD,GAAG,CAAC,CAAC,EAAE,OAAO,EAAE,YAAY,EAAE,OAAO,EAAE,EAAE,EAAE,CAAC,CAAC;gBAC5C,OAAO;gBACP,gBAAgB,EAAE,IAAA,uBAAW,EAAC,YAAY,CAAC;gBAC3C,QAAQ,EAAE,OAAO,KAAK,QAAQ;aAC/B,CAAC,CAAC,CAAC;YACN,OAAO,MAAM,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,IAAI,CAAC;QAChD,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACb,IAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,CAAC;QAChC,CAAC;IACH,CAAC;;AA3DH,4DA4DC","sourcesContent":["import { regEx } from '../../../util/regex';\nimport { asTimestamp } from '../../../util/timestamp';\nimport { id as semverId } from '../../versioning/semver';\nimport { Datasource } from '../datasource';\nimport type { GetReleasesConfig, ReleaseResult } from '../types';\nimport type { FlutterResponse } from './types';\n\nexport const stableVersionRegex = regEx(/^\\d+\\.\\d+\\.\\d+$/);\n\nexport class FlutterVersionDatasource extends Datasource {\n  static readonly id = 'flutter-version';\n\n  constructor() {\n    super(FlutterVersionDatasource.id);\n  }\n\n  override readonly customRegistrySupport = false;\n\n  override readonly defaultRegistryUrls = ['https://storage.googleapis.com'];\n\n  override readonly caching = true;\n\n  override readonly defaultVersioning = semverId;\n\n  override readonly releaseTimestampSupport = true;\n  override readonly releaseTimestampNote =\n    'The release timestamp is determined from the `release_date` field in the results.';\n  override readonly sourceUrlSupport = 'package';\n  override readonly sourceUrlNote =\n    'We use the URL: https://github.com/flutter/flutter.';\n\n  async getReleases({\n    registryUrl,\n  }: GetReleasesConfig): Promise<ReleaseResult | null> {\n    /* v8 ignore next 3 -- should never happen */\n    if (!registryUrl) {\n      return null;\n    }\n    const result: ReleaseResult = {\n      homepage: 'https://flutter.dev',\n      sourceUrl: 'https://github.com/flutter/flutter',\n      registryUrl,\n      releases: [],\n    };\n    try {\n      const resp = (\n        await this.http.getJsonUnchecked<FlutterResponse>(\n          `${registryUrl}/flutter_infra_release/releases/releases_linux.json`,\n        )\n      ).body;\n      result.releases = resp.releases\n        // The API response contains a stable version being released as a non-stable\n        // release. And so we filter out these releases here.\n        .filter(({ version, channel }) => {\n          if (stableVersionRegex.test(version)) {\n            return channel === 'stable';\n          }\n          return true;\n        })\n        .map(({ version, release_date, channel }) => ({\n          version,\n          releaseTimestamp: asTimestamp(release_date),\n          isStable: channel === 'stable',\n        }));\n      return result.releases.length ? result : null;\n    } catch (err) {\n      this.handleGenericErrors(err);\n    }\n  }\n}\n"]}