{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../lib/modules/datasource/puppet-forge/index.ts"],"names":[],"mappings":";;;AAAA,uDAAsD;AACtD,8CAA2C;AAE3C,qCAAwC;AAGxC,MAAa,qBAAsB,SAAQ,uBAAU;IACnD,MAAM,CAAC,EAAE,GAAG,cAAc,CAAC;IAE3B;QACE,KAAK,CAAC,qBAAqB,CAAC,EAAE,CAAC,CAAC;IAClC,CAAC;IAEiB,mBAAmB,GAAG,CAAC,qBAAY,CAAC,CAAC;IAErC,uBAAuB,GAAG,IAAI,CAAC;IAC/B,oBAAoB,GACpC,oFAAoF,CAAC;IAEvF,KAAK,CAAC,WAAW,CAAC,EAChB,WAAW,EACX,WAAW,GACO;QAClB,8BAA8B;QAC9B,MAAM,UAAU,GAAG,WAAW,CAAC,OAAO,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC;QACjD,uBAAuB;QACvB,MAAM,GAAG,GAAG,GAAG,WAAW,eAAe,UAAU,iCAAiC,CAAC;QAErF,IAAI,MAAoB,CAAC;QAEzB,IAAI,CAAC;YACH,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,IAAI,CAAC,gBAAgB,CAAe,GAAG,CAAC,CAAC;YACrE,MAAM,GAAG,QAAQ,CAAC,IAAI,CAAC;QACzB,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACb,IAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,CAAC;QAChC,CAAC;QAED,MAAM,QAAQ,GAAc,MAAM,EAAE,QAAQ,EAAE,GAAG,CAAC,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC;YAC9D,OAAO,EAAE,OAAO,CAAC,OAAO;YACxB,WAAW,EAAE,OAAO,CAAC,QAAQ;YAC7B,gBAAgB,EAAE,IAAA,uBAAW,EAAC,OAAO,CAAC,UAAU,CAAC;YACjD,WAAW;SACZ,CAAC,CAAC,CAAC;QAEJ,IAAI,CAAC,QAAQ,EAAE,MAAM,EAAE,CAAC;YACtB,OAAO,IAAI,CAAC;QACd,CAAC;QAED,OAAO,qBAAqB,CAAC,mBAAmB,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;IACrE,CAAC;IAED,MAAM,CAAC,mBAAmB,CACxB,QAAmB,EACnB,MAAoB;QAEpB,MAAM,MAAM,GAAkB;YAC5B,QAAQ;YACR,kFAAkF;YAClF,QAAQ,EAAE,MAAM,CAAC,YAAY;SAC9B,CAAC;QAEF,IAAI,MAAM,CAAC,cAAc,EAAE,CAAC;YAC1B,MAAM,CAAC,kBAAkB,GAAG,MAAM,CAAC,cAAc,CAAC;QACpD,CAAC;QAED,OAAO,MAAM,CAAC;IAChB,CAAC;;AA5DH,sDA6DC","sourcesContent":["import { asTimestamp } from '../../../util/timestamp';\nimport { Datasource } from '../datasource';\nimport type { GetReleasesConfig, Release, ReleaseResult } from '../types';\nimport { PUPPET_FORGE } from './common';\nimport type { PuppetModule } from './types';\n\nexport class PuppetForgeDatasource extends Datasource {\n  static id = 'puppet-forge';\n\n  constructor() {\n    super(PuppetForgeDatasource.id);\n  }\n\n  override readonly defaultRegistryUrls = [PUPPET_FORGE];\n\n  override readonly releaseTimestampSupport = true;\n  override readonly releaseTimestampNote =\n    'The release timestamp is determined from the `created_at` field from the response.';\n\n  async getReleases({\n    packageName,\n    registryUrl,\n  }: GetReleasesConfig): Promise<ReleaseResult | null> {\n    // https://forgeapi.puppet.com\n    const moduleSlug = packageName.replace('/', '-');\n    // TODO: types (#22198)\n    const url = `${registryUrl}/v3/modules/${moduleSlug}?exclude_fields=current_release`;\n\n    let module: PuppetModule;\n\n    try {\n      const response = await this.http.getJsonUnchecked<PuppetModule>(url);\n      module = response.body;\n    } catch (err) {\n      this.handleGenericErrors(err);\n    }\n\n    const releases: Release[] = module?.releases?.map((release) => ({\n      version: release.version,\n      downloadUrl: release.file_uri,\n      releaseTimestamp: asTimestamp(release.created_at),\n      registryUrl,\n    }));\n\n    if (!releases?.length) {\n      return null;\n    }\n\n    return PuppetForgeDatasource.createReleaseResult(releases, module);\n  }\n\n  static createReleaseResult(\n    releases: Release[],\n    module: PuppetModule,\n  ): ReleaseResult {\n    const result: ReleaseResult = {\n      releases,\n      // the homepage url in the fixtures is a github repo, we can use this as sourceUrl\n      homepage: module.homepage_url,\n    };\n\n    if (module.deprecated_for) {\n      result.deprecationMessage = module.deprecated_for;\n    }\n\n    return result;\n  }\n}\n"]}