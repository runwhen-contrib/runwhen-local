{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../lib/modules/datasource/conan/index.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { logger } from '../../../logger';\nimport { cache } from '../../../util/cache/package/decorator';\nimport { GithubHttp } from '../../../util/http/github';\nimport { ensureTrailingSlash, joinUrlParts } from '../../../util/url';\nimport * as allVersioning from '../../versioning';\nimport { Datasource } from '../datasource';\nimport type {\n  DigestConfig,\n  GetReleasesConfig,\n  Release,\n  ReleaseResult,\n} from '../types';\nimport { isArtifactoryServer } from '../util';\nimport { datasource, defaultRegistryUrl, getConanPackage } from './common';\nimport {\n  ConanCenterReleases,\n  ConanJSON,\n  ConanLatestRevision,\n  ConanProperties,\n  ConanRevisionJSON,\n} from './schema';\n\nexport class ConanDatasource extends Datasource {\n  static readonly id = datasource;\n\n  override readonly defaultRegistryUrls = [defaultRegistryUrl];\n\n  override readonly caching = true;\n\n  override readonly registryStrategy = 'merge';\n\n  githubHttp: GithubHttp;\n\n  override readonly sourceUrlSupport = 'package';\n  override readonly sourceUrlNote =\n    'The source URL is supported only if the package is served from the Artifactory servers. In which case we determine it from the `properties[conan.package.url]` field in the results.';\n\n  constructor(id = ConanDatasource.id) {\n    super(id);\n    this.githubHttp = new GithubHttp(id);\n  }\n\n  async getConanCenterReleases(\n    conanName: string,\n    userAndChannel: string,\n  ): Promise<ReleaseResult | null> {\n    if (userAndChannel && userAndChannel !== '@_/_') {\n      logger.debug(\n        { conanName, userAndChannel },\n        'User/channel not supported for Conan Center lookups',\n      );\n      return null;\n    }\n    const url = `https://api.github.com/repos/conan-io/conan-center-index/contents/recipes/${conanName}/config.yml`;\n    const { body: result } = await this.githubHttp.getYaml(\n      url,\n      { headers: { accept: 'application/vnd.github.v3.raw' } },\n      ConanCenterReleases,\n    );\n    return result;\n  }\n\n  @cache({\n    namespace: `datasource-${datasource}`,\n    key: ({ registryUrl, packageName }: DigestConfig, newValue?: string) =>\n      // TODO: types (#22198)\n      `getDigest:${registryUrl!}:${packageName}:${newValue!}`,\n  })\n  override async getDigest(\n    { registryUrl, packageName }: DigestConfig,\n    newValue?: string,\n  ): Promise<string | null> {\n    if (is.undefined(newValue) || is.undefined(registryUrl)) {\n      return null;\n    }\n    const url = ensureTrailingSlash(registryUrl);\n    const conanPackage = getConanPackage(packageName);\n    const revisionLookUp = joinUrlParts(\n      url,\n      'v2/conans/',\n      conanPackage.conanName,\n      newValue,\n      conanPackage.userAndChannel,\n      '/revisions',\n    );\n    const { body: digest } = await this.http.getJson(\n      revisionLookUp,\n      ConanLatestRevision,\n    );\n    return digest;\n  }\n\n  @cache({\n    namespace: `datasource-${datasource}`,\n    key: ({ registryUrl, packageName }: GetReleasesConfig) =>\n      // TODO: types (#22198)\n      `getReleases:${registryUrl}:${packageName}`,\n  })\n  async getReleases({\n    registryUrl,\n    packageName,\n  }: GetReleasesConfig): Promise<ReleaseResult | null> {\n    const conanPackage = getConanPackage(packageName);\n    const userAndChannel = '@' + conanPackage.userAndChannel;\n    if (\n      is.string(registryUrl) &&\n      ensureTrailingSlash(registryUrl) === defaultRegistryUrl\n    ) {\n      return this.getConanCenterReleases(\n        conanPackage.conanName,\n        userAndChannel,\n      );\n    }\n\n    logger.trace(\n      { packageName, registryUrl },\n      'Looking up conan api dependency',\n    );\n\n    if (registryUrl) {\n      const url = ensureTrailingSlash(registryUrl);\n      const lookupUrl = joinUrlParts(\n        url,\n        `v2/conans/search?q=${conanPackage.conanName}`,\n      );\n\n      try {\n        const rep = await this.http.getJsonUnchecked(lookupUrl);\n        const conanJson = ConanJSON.parse(rep.body);\n        if (conanJson) {\n          logger.trace({ lookupUrl }, 'Got conan api result');\n          const dep: ReleaseResult = { releases: [] };\n\n          const conanJsonReleases: Release[] = conanJson\n            .filter(({ userChannel }) => userChannel === userAndChannel)\n            .map(({ version }) => ({ version }));\n          dep.releases.push(...conanJsonReleases);\n\n          try {\n            if (isArtifactoryServer(rep)) {\n              const conanApiRegexp =\n                /(?<host>.*)\\/artifactory\\/api\\/conan\\/(?<repo>[^/]+)/;\n              const groups = conanApiRegexp.exec(url)?.groups;\n              if (!groups) {\n                return dep;\n              }\n              const semver = allVersioning.get('semver');\n\n              const sortedReleases = dep.releases\n                .filter((release) => semver.isVersion(release.version))\n                .sort((a, b) => semver.sortVersions(a.version, b.version));\n\n              const latestVersion = sortedReleases.at(-1)?.version;\n\n              if (!latestVersion) {\n                return dep;\n              }\n              logger.debug(\n                `Conan package ${packageName} has latest version ${latestVersion}`,\n              );\n\n              const latestRevisionUrl = joinUrlParts(\n                url,\n                `v2/conans/${conanPackage.conanName}/${latestVersion}/${conanPackage.userAndChannel}/latest`,\n              );\n              const {\n                body: { revision: packageRev },\n              } = await this.http.getJson(latestRevisionUrl, ConanRevisionJSON);\n\n              const [user, channel] = conanPackage.userAndChannel.split('/');\n              const packageUrl = joinUrlParts(\n                `${groups.host}/artifactory/api/storage/${groups.repo}`,\n                `${user}/${conanPackage.conanName}/${latestVersion}/${channel}/${packageRev}/export/conanfile.py?properties=conan.package.url`,\n              );\n              const { body: conanProperties } = await this.http.getJson(\n                packageUrl,\n                ConanProperties,\n              );\n              const { sourceUrl } = conanProperties;\n              if (sourceUrl) {\n                dep.sourceUrl = sourceUrl;\n              }\n            }\n          } catch (err) {\n            logger.debug({ err }, \"Couldn't determine Conan package url\");\n          }\n          return dep;\n        }\n      } catch (err) {\n        this.handleGenericErrors(err);\n      }\n    }\n\n    return null;\n  }\n}\n"]}