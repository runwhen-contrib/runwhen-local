{"version":3,"file":"migrations-service.js","sourceRoot":"","sources":["../../../lib/config/migrations/migrations-service.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { dequal } from 'dequal';\nimport type { RenovateConfig } from '../types';\nimport { RemovePropertyMigration } from './base/remove-property-migration';\nimport { RenamePropertyMigration } from './base/rename-property-migration';\nimport { AutomergeMajorMigration } from './custom/automerge-major-migration';\nimport { AutomergeMigration } from './custom/automerge-migration';\nimport { AutomergeMinorMigration } from './custom/automerge-minor-migration';\nimport { AutomergePatchMigration } from './custom/automerge-patch-migration';\nimport { AutomergeTypeMigration } from './custom/automerge-type-migration';\nimport { AzureGitLabAutomergeMigration } from './custom/azure-gitlab-automerge-migration';\nimport { BaseBranchMigration } from './custom/base-branch-migration';\nimport { BinarySourceMigration } from './custom/binary-source-migration';\nimport { BranchNameMigration } from './custom/branch-name-migration';\nimport { BranchPrefixMigration } from './custom/branch-prefix-migration';\nimport { CompatibilityMigration } from './custom/compatibility-migration';\nimport { ComposerIgnorePlatformReqsMigration } from './custom/composer-ignore-platform-reqs-migration';\nimport { CustomManagersMigration } from './custom/custom-managers-migration';\nimport { DatasourceMigration } from './custom/datasource-migration';\nimport { DepTypesMigration } from './custom/dep-types-migration';\nimport { DryRunMigration } from './custom/dry-run-migration';\nimport { EnabledManagersMigration } from './custom/enabled-managers-migration';\nimport { ExtendsMigration } from './custom/extends-migration';\nimport { FetchReleaseNotesMigration } from './custom/fetch-release-notes-migration';\nimport { GoModTidyMigration } from './custom/go-mod-tidy-migration';\nimport { HostRulesMigration } from './custom/host-rules-migration';\nimport { IgnoreNodeModulesMigration } from './custom/ignore-node-modules-migration';\nimport { IgnoreNpmrcFileMigration } from './custom/ignore-npmrc-file-migration';\nimport { IncludeForksMigration } from './custom/include-forks-migration';\nimport { MatchDatasourcesMigration } from './custom/match-datasources-migration';\nimport { MatchManagersMigration } from './custom/match-managers-migration';\nimport { MatchStringsMigration } from './custom/match-strings-migration';\nimport { NodeMigration } from './custom/node-migration';\nimport { PackageFilesMigration } from './custom/package-files-migration';\nimport { PackageNameMigration } from './custom/package-name-migration';\nimport { PackagePatternMigration } from './custom/package-pattern-migration';\nimport { PackageRulesMigration } from './custom/package-rules-migration';\nimport { PackagesMigration } from './custom/packages-migration';\nimport { PathRulesMigration } from './custom/path-rules-migration';\nimport { PinVersionsMigration } from './custom/pin-versions-migration';\nimport { PlatformCommitMigration } from './custom/platform-commit-migration';\nimport { PostUpdateOptionsMigration } from './custom/post-update-options-migration';\nimport { RebaseConflictedPrs } from './custom/rebase-conflicted-prs-migration';\nimport { RebaseStalePrsMigration } from './custom/rebase-stale-prs-migration';\nimport { RecreateClosedMigration } from './custom/recreate-closed-migration';\nimport { RenovateForkMigration } from './custom/renovate-fork-migration';\nimport { RequireConfigMigration } from './custom/require-config-migration';\nimport { RequiredStatusChecksMigration } from './custom/required-status-checks-migration';\nimport { ScheduleMigration } from './custom/schedule-migration';\nimport { SemanticCommitsMigration } from './custom/semantic-commits-migration';\nimport { SemanticPrefixMigration } from './custom/semantic-prefix-migration';\nimport { SeparateMajorReleasesMigration } from './custom/separate-major-release-migration';\nimport { SeparateMultipleMajorMigration } from './custom/separate-multiple-major-migration';\nimport { StabilityDaysMigration } from './custom/stability-days-migration';\nimport { SuppressNotificationsMigration } from './custom/suppress-notifications-migration';\nimport { TrustLevelMigration } from './custom/trust-level-migration';\nimport { UnpublishSafeMigration } from './custom/unpublish-safe-migration';\nimport { UpgradeInRangeMigration } from './custom/upgrade-in-range-migration';\nimport { VersionStrategyMigration } from './custom/version-strategy-migration';\nimport type { Migration, MigrationConstructor } from './types';\n\nexport class MigrationsService {\n  static readonly removedProperties: ReadonlySet<string> = new Set([\n    'deepExtract',\n    'gitFs',\n    'groupBranchName',\n    'groupCommitMessage',\n    'groupPrBody',\n    'groupPrTitle',\n    'lazyGrouping',\n    'maintainYarnLock',\n    'statusCheckVerify',\n    'supportPolicy',\n    'transitiveRemediation',\n    'yarnCacheFolder',\n    'yarnMaintenanceBranchName',\n    'yarnMaintenanceCommitMessage',\n    'yarnMaintenancePrBody',\n    'yarnMaintenancePrTitle',\n    'raiseDeprecationWarnings',\n  ]);\n\n  static readonly renamedProperties: ReadonlyMap<string, string> = new Map([\n    ['adoptium-java', 'java-version'],\n    ['allowPostUpgradeCommandTemplating', 'allowCommandTemplating'],\n    ['allowedPostUpgradeCommands', 'allowedCommands'],\n    ['azureAutoApprove', 'autoApprove'],\n    ['customChangelogUrl', 'changelogUrl'],\n    ['endpoints', 'hostRules'],\n    ['excludedPackageNames', 'excludePackageNames'],\n    ['exposeEnv', 'exposeAllEnv'],\n    ['keepalive', 'keepAlive'],\n    ['managerBranchPrefix', 'additionalBranchPrefix'],\n    ['multipleMajorPrs', 'separateMultipleMajor'],\n    ['separatePatchReleases', 'separateMinorPatch'],\n    ['versionScheme', 'versioning'],\n    ['lookupNameTemplate', 'packageNameTemplate'],\n    ['aliases', 'registryAliases'],\n    ['masterIssue', 'dependencyDashboard'],\n    ['masterIssueApproval', 'dependencyDashboardApproval'],\n    ['masterIssueAutoclose', 'dependencyDashboardAutoclose'],\n    ['masterIssueHeader', 'dependencyDashboardHeader'],\n    ['masterIssueFooter', 'dependencyDashboardFooter'],\n    ['masterIssueTitle', 'dependencyDashboardTitle'],\n    ['masterIssueLabels', 'dependencyDashboardLabels'],\n    ['regexManagers', 'customManagers'],\n  ]);\n\n  static readonly customMigrations: readonly MigrationConstructor[] = [\n    AutomergeMajorMigration,\n    AutomergeMigration,\n    AutomergeMinorMigration,\n    AutomergePatchMigration,\n    AutomergeTypeMigration,\n    AzureGitLabAutomergeMigration,\n    BaseBranchMigration,\n    BinarySourceMigration,\n    BranchNameMigration,\n    BranchPrefixMigration,\n    CompatibilityMigration,\n    ComposerIgnorePlatformReqsMigration,\n    EnabledManagersMigration,\n    ExtendsMigration,\n    GoModTidyMigration,\n    HostRulesMigration,\n    IgnoreNodeModulesMigration,\n    IgnoreNpmrcFileMigration,\n    IncludeForksMigration,\n    MatchStringsMigration,\n    PackageNameMigration,\n    PackagePatternMigration,\n    PackagesMigration,\n    PathRulesMigration,\n    PinVersionsMigration,\n    PostUpdateOptionsMigration,\n    RebaseConflictedPrs,\n    RebaseStalePrsMigration,\n    RenovateForkMigration,\n    RequiredStatusChecksMigration,\n    ScheduleMigration,\n    SemanticCommitsMigration,\n    SeparateMajorReleasesMigration,\n    SeparateMultipleMajorMigration,\n    SuppressNotificationsMigration,\n    TrustLevelMigration,\n    UnpublishSafeMigration,\n    UpgradeInRangeMigration,\n    VersionStrategyMigration,\n    DryRunMigration,\n    RequireConfigMigration,\n    PackageFilesMigration,\n    DepTypesMigration,\n    PackageRulesMigration,\n    NodeMigration,\n    SemanticPrefixMigration,\n    MatchDatasourcesMigration,\n    DatasourceMigration,\n    RecreateClosedMigration,\n    StabilityDaysMigration,\n    FetchReleaseNotesMigration,\n    MatchManagersMigration,\n    CustomManagersMigration,\n    PlatformCommitMigration,\n  ];\n\n  static run(\n    originalConfig: RenovateConfig,\n    parentKey?: string,\n  ): RenovateConfig {\n    const migratedConfig: RenovateConfig = {};\n    const migrations = this.getMigrations(originalConfig, migratedConfig);\n\n    for (const [key, value] of Object.entries(originalConfig)) {\n      migratedConfig[key] ??= value;\n      const migration = MigrationsService.getMigration(migrations, key);\n\n      if (migration) {\n        migration.run(value, key, parentKey);\n\n        if (migration.deprecated) {\n          delete migratedConfig[key];\n        }\n      }\n    }\n\n    return migratedConfig;\n  }\n\n  static isMigrated(\n    originalConfig: RenovateConfig,\n    migratedConfig: RenovateConfig,\n  ): boolean {\n    return !dequal(originalConfig, migratedConfig);\n  }\n\n  public static getMigrations(\n    originalConfig: RenovateConfig,\n    migratedConfig: RenovateConfig,\n  ): readonly Migration[] {\n    const migrations: Migration[] = [];\n\n    for (const propertyName of MigrationsService.removedProperties) {\n      migrations.push(\n        new RemovePropertyMigration(\n          propertyName,\n          originalConfig,\n          migratedConfig,\n        ),\n      );\n    }\n\n    for (const [\n      oldPropertyName,\n      newPropertyName,\n    ] of MigrationsService.renamedProperties.entries()) {\n      migrations.push(\n        new RenamePropertyMigration(\n          oldPropertyName,\n          newPropertyName,\n          originalConfig,\n          migratedConfig,\n        ),\n      );\n    }\n\n    for (const CustomMigration of this.customMigrations) {\n      migrations.push(new CustomMigration(originalConfig, migratedConfig));\n    }\n\n    return migrations;\n  }\n\n  private static getMigration(\n    migrations: readonly Migration[],\n    key: string,\n  ): Migration | undefined {\n    return migrations.find((migration) => {\n      if (is.regExp(migration.propertyName)) {\n        return migration.propertyName.test(key);\n      }\n\n      return migration.propertyName === key;\n    });\n  }\n}\n"]}