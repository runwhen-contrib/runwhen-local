{"version":3,"file":"base.js","sourceRoot":"","sources":["../../../../../lib/util/cache/repository/impl/base.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { GlobalConfig } from '../../../../config/global';\nimport { logger } from '../../../../logger';\nimport { compressToBase64, decompressFromBase64 } from '../../../compress';\nimport { hash } from '../../../hash';\nimport { safeStringify } from '../../../stringify';\nimport { CACHE_REVISION } from '../common';\nimport { cleanupHttpCache } from '../http-cache';\nimport type { RepoCacheRecord } from '../schema';\nimport { RepoCacheV13 } from '../schema';\nimport type { RepoCache, RepoCacheData } from '../types';\n\nexport abstract class RepoCacheBase implements RepoCache {\n  protected platform = GlobalConfig.get('platform')!;\n  private oldHash: string | null = null;\n  private data: RepoCacheData = {};\n\n  protected constructor(\n    protected readonly repository: string,\n    protected readonly fingerprint: string,\n  ) {}\n\n  protected abstract read(): Promise<string | null>;\n\n  protected abstract write(data: RepoCacheRecord): Promise<void>;\n\n  private static parseData(input: string): RepoCacheData {\n    const data: RepoCacheData = JSON.parse(input);\n    // istanbul ignore next\n    if (data.branches) {\n      for (const branch of data.branches) {\n        if (branch.branchFingerprint) {\n          branch.commitFingerprint = branch.branchFingerprint;\n          delete branch.branchFingerprint;\n        }\n      }\n    }\n    return data;\n  }\n\n  private async restore(oldCache: RepoCacheRecord): Promise<void> {\n    if (oldCache.fingerprint !== this.fingerprint) {\n      logger.debug('Repository cache fingerprint is invalid');\n      return;\n    }\n    const jsonStr = await decompressFromBase64(oldCache.payload);\n    this.data = RepoCacheBase.parseData(jsonStr);\n    this.oldHash = oldCache.hash;\n  }\n\n  async load(): Promise<void> {\n    try {\n      const oldCache = await this.read();\n      if (!is.string(oldCache)) {\n        logger.debug(\n          `RepoCacheBase.load() - expecting data of type 'string' received '${typeof oldCache}' instead - skipping`,\n        );\n        return;\n      }\n\n      if (!is.nonEmptyString(oldCache)) {\n        logger.debug('RepoCacheBase.load() - cache file is empty - skipping');\n        return;\n      }\n\n      const cacheV13 = RepoCacheV13.safeParse(oldCache);\n      if (cacheV13.success) {\n        await this.restore(cacheV13.data);\n        logger.debug('Repository cache is restored from revision 13');\n        return;\n      }\n\n      logger.warn({ err: cacheV13.error }, 'Repository cache is invalid');\n    } catch (err) /* istanbul ignore next: not easily testable */ {\n      logger.debug({ err }, 'Error reading repository cache');\n    }\n  }\n\n  async save(): Promise<void> {\n    cleanupHttpCache(this.data);\n    const jsonStr = safeStringify(this.data);\n    const hashedJsonStr = hash(jsonStr);\n    if (hashedJsonStr === this.oldHash) {\n      return;\n    }\n\n    const revision = CACHE_REVISION;\n    const repository = this.repository;\n    const fingerprint = this.fingerprint;\n\n    const payload = await compressToBase64(jsonStr);\n\n    await this.write({\n      revision,\n      repository,\n      fingerprint,\n      payload,\n      hash: hashedJsonStr,\n    });\n  }\n\n  getData(): RepoCacheData {\n    return this.data;\n  }\n\n  isModified(): boolean | undefined {\n    if (!this.oldHash) {\n      return undefined;\n    }\n    const jsonStr = safeStringify(this.data);\n    return hash(jsonStr) !== this.oldHash;\n  }\n}\n"]}