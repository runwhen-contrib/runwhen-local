{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../../lib/workers/repository/config-migration/pr/index.ts"],"names":[],"mappings":";;AAmBA,0DAoHC;;AAvID,kEAAkC;AAClC,sDAAyD;AAEzD,+CAA4C;AAE5C,2DAAwD;AACxD,kEAAgE;AAChE,0DAAuD;AACvD,kDAAiD;AACjD,oDAAuD;AACvD,4EAAsD;AACtD,8CAAoD;AACpD,wCAAuD;AACvD,mDAAuD;AACvD,+DAA+D;AAC/D,6DAA+E;AAE/E,sCAAmD;AAE5C,KAAK,UAAU,uBAAuB,CAC3C,MAAsB,EACtB,kBAAgC;IAEhC,eAAM,CAAC,KAAK,CAAC,2BAA2B,CAAC,CAAC;IAC1C,MAAM,QAAQ,GAAG,IAAA,kBAAY,EAC3B,IAAA,qBAAY,EAAC,MAAM,CAAC,YAAY,EAAE,aAAa,CAAC,EAChD,wCAAwC,CACzC,CAAC;IACF,MAAM,UAAU,GAAG,IAAA,+BAAsB,EAAC,MAAM,CAAC,CAAC;IAClD,MAAM,oBAAoB,GAAG,IAAI,oDAAmC,CAClE,MAAM,EACN,kBAAkB,CAAC,QAAQ,CAC5B,CAAC;IAEF,MAAM,OAAO,GAAG,oBAAoB,CAAC,UAAU,EAAE,CAAC;IAClD,MAAM,UAAU,GAAG,MAAM,mBAAQ,CAAC,WAAW,CAAC,UAAU,EAAE,MAAM,CAAC,UAAU,CAAC,CAAC;IAC7E,MAAM,QAAQ,GAAG,kBAAkB,CAAC,QAAQ,CAAC;IAC7C,eAAM,CAAC,KAAK,CAAC,yCAAyC,CAAC,CAAC;IACxD,IAAI,MAAM,GAAG;;gRAEiQ,CAAC;IAC/Q,MAAM,IAAI,IAAA,eAAO,EACf;;EAGF,QAAQ,CAAC,QAAQ,CAAC,QAAQ,CAAC;QACzB,CAAC,CAAC,sBAAsB,QAAQ,KAAK;YACnC,0EAA0E;QAC5E,CAAC,CAAC,EACN;;;;2GAKM,MAAM,CAAC,YAAY,EAAE,IACvB,QAAQ,CACT,CAAC;IAEF,IAAI,YAAE,CAAC,MAAM,CAAC,MAAM,CAAC,QAAQ,CAAC,EAAE,CAAC;QAC/B,MAAM,GAAG,GAAG,QAAQ,CAAC,OAAO,CAAC,MAAM,CAAC,QAAQ,EAAE,MAAM,CAAC,OAAO,MAAM,EAAE,CAAC;IACvE,CAAC;IACD,IAAI,YAAE,CAAC,MAAM,CAAC,MAAM,CAAC,QAAQ,CAAC,EAAE,CAAC;QAC/B,MAAM,GAAG,GAAG,MAAM,YAAY,QAAQ,CAAC,OAAO,CAAC,MAAM,CAAC,QAAQ,EAAE,MAAM,CAAC,IAAI,CAAC;IAC9E,CAAC;IACD,eAAM,CAAC,KAAK,CAAC,EAAE,MAAM,EAAE,EAAE,QAAQ,CAAC,CAAC;IAEnC,MAAM,GAAG,mBAAQ,CAAC,eAAe,CAAC,MAAM,CAAC,CAAC;IAE1C,IAAI,UAAU,EAAE,CAAC;QACf,eAAM,CAAC,KAAK,CAAC,yBAAyB,CAAC,CAAC;QACxC,sCAAsC;QACtC,MAAM,UAAU,GAAG,IAAA,kBAAQ,EAAC,MAAM,CAAC,CAAC;QACpC,IACE,UAAU,CAAC,UAAU,EAAE,IAAI,KAAK,UAAU;YAC1C,UAAU,CAAC,KAAK,KAAK,OAAO,EAC5B,CAAC;YACD,eAAM,CAAC,KAAK,CAAC,oCAAoC,UAAU,CAAC,MAAM,EAAE,CAAC,CAAC;YACtE,OAAO,UAAU,CAAC;QACpB,CAAC;QACD,wBAAwB;QACxB,IAAI,qBAAY,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE,CAAC;YAC/B,eAAM,CAAC,IAAI,CAAC,oCAAoC,CAAC,CAAC;QACpD,CAAC;aAAM,CAAC;YACN,MAAM,mBAAQ,CAAC,QAAQ,CAAC;gBACtB,MAAM,EAAE,UAAU,CAAC,MAAM;gBACzB,OAAO;gBACP,MAAM;aACP,CAAC,CAAC;YACH,eAAM,CAAC,IAAI,CAAC,EAAE,EAAE,EAAE,UAAU,CAAC,MAAM,EAAE,EAAE,sBAAsB,CAAC,CAAC;QACjE,CAAC;QACD,OAAO,UAAU,CAAC;IACpB,CAAC;IACD,eAAM,CAAC,KAAK,CAAC,uBAAuB,CAAC,CAAC;IACtC,MAAM,MAAM,GAAG,IAAA,sBAAa,EAAC,MAAM,CAAC,CAAC;IACrC,IAAI,CAAC;QACH,IAAI,qBAAY,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE,CAAC;YAC/B,eAAM,CAAC,IAAI,CAAC,oCAAoC,CAAC,CAAC;QACpD,CAAC;aAAM,CAAC;YACN,MAAM,EAAE,GAAG,MAAM,mBAAQ,CAAC,QAAQ,CAAC;gBACjC,YAAY,EAAE,UAAU;gBACxB,cAAc;gBACd,YAAY,EAAE,MAAM,CAAC,aAAc;gBACnC,OAAO;gBACP,MAAM;gBACN,MAAM;gBACN,iBAAiB,EAAE,IAAA,yBAAoB,EAAC;oBACtC,GAAG,MAAM;oBACT,SAAS,EAAE,KAAK;iBACjB,CAAC;aACH,CAAC,CAAC;YACH,eAAM,CAAC,IAAI,CAAC,EAAE,EAAE,EAAE,EAAE,EAAE,MAAM,EAAE,EAAE,sBAAsB,CAAC,CAAC;YACxD,IAAI,EAAE,EAAE,CAAC;gBACP,MAAM,IAAA,8BAAe,EAAC,MAAM,EAAE,EAAE,CAAC,CAAC;YACpC,CAAC;YAED,OAAO,EAAE,CAAC;QACZ,CAAC;IACH,CAAC;IAAC,OAAO,GAAG,EAAE,CAAC;QACb,IACE,GAAG,CAAC,QAAQ,EAAE,UAAU,KAAK,GAAG;YAChC,GAAG,CAAC,QAAQ,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC,CAAC,CAAC,EAAE,OAAO,EAAE,UAAU,CAClD,+BAA+B,CAChC,EACD,CAAC;YACD,eAAM,CAAC,IAAI,CACT,EAAE,GAAG,EAAE,EACP,8FAA8F,CAC/F,CAAC;YACF,MAAM,SAAG,CAAC,YAAY,CAAC,UAAU,CAAC,CAAC;YACnC,OAAO,IAAI,CAAC;QACd,CAAC;QACD,MAAM,GAAG,CAAC;IACZ,CAAC;IAED,OAAO,IAAI,CAAC;AACd,CAAC","sourcesContent":["import is from '@sindresorhus/is';\nimport { GlobalConfig } from '../../../../config/global';\nimport type { RenovateConfig } from '../../../../config/types';\nimport { logger } from '../../../../logger';\nimport type { Pr } from '../../../../modules/platform';\nimport { platform } from '../../../../modules/platform';\nimport { hashBody } from '../../../../modules/platform/pr-body';\nimport { scm } from '../../../../modules/platform/scm';\nimport { emojify } from '../../../../util/emoji';\nimport { coerceString } from '../../../../util/string';\nimport * as template from '../../../../util/template';\nimport { joinUrlParts } from '../../../../util/url';\nimport { getPlatformPrOptions } from '../../update/pr';\nimport { prepareLabels } from '../../update/pr/labels';\nimport { addParticipants } from '../../update/pr/participants';\nimport { ConfigMigrationCommitMessageFactory } from '../branch/commit-message';\nimport type { MigratedData } from '../branch/migrated-data';\nimport { getMigrationBranchName } from '../common';\n\nexport async function ensureConfigMigrationPr(\n  config: RenovateConfig,\n  migratedConfigData: MigratedData,\n): Promise<Pr | null> {\n  logger.debug('ensureConfigMigrationPr()');\n  const docsLink = joinUrlParts(\n    coerceString(config.productLinks?.documentation),\n    'configuration-options/#configmigration',\n  );\n  const branchName = getMigrationBranchName(config);\n  const commitMessageFactory = new ConfigMigrationCommitMessageFactory(\n    config,\n    migratedConfigData.filename,\n  );\n\n  const prTitle = commitMessageFactory.getPrTitle();\n  const existingPr = await platform.getBranchPr(branchName, config.baseBranch);\n  const filename = migratedConfigData.filename;\n  logger.debug('Filling in config migration PR template');\n  let prBody = `The Renovate config in this repository needs migrating. Typically this is because one or more configuration options you are using have been renamed.\n\n  You don't need to merge this PR right away, because Renovate will continue to migrate these fields internally each time it runs. But later some of these fields may be fully deprecated and the migrations removed. So it's a good idea to merge this migration PR soon. \\n\\n`;\n  prBody += emojify(\n    `\n\n${\n  filename.endsWith('.json5')\n    ? `#### [PLEASE NOTE](${docsLink}): ` +\n      `JSON5 config file migrated! All comments & trailing commas were removed.`\n    : ''\n}\n\n:no_bell: **Ignore**: Close this PR and you won't be reminded about config migration again, but one day your current config may no longer be valid.\n\n:question: Got questions? Does something look wrong to you? Please don't hesitate to [request help here](${\n      config.productLinks?.help\n    }).\\n\\n`,\n  );\n\n  if (is.string(config.prHeader)) {\n    prBody = `${template.compile(config.prHeader, config)}\\n\\n${prBody}`;\n  }\n  if (is.string(config.prFooter)) {\n    prBody = `${prBody}\\n---\\n\\n${template.compile(config.prFooter, config)}\\n`;\n  }\n  logger.trace({ prBody }, 'prBody');\n\n  prBody = platform.massageMarkdown(prBody);\n\n  if (existingPr) {\n    logger.debug('Found open migration PR');\n    // Check if existing PR needs updating\n    const prBodyHash = hashBody(prBody);\n    if (\n      existingPr.bodyStruct?.hash === prBodyHash &&\n      existingPr.title === prTitle\n    ) {\n      logger.debug(`Pr does not need updating, PrNo: ${existingPr.number}`);\n      return existingPr;\n    }\n    // PR must need updating\n    if (GlobalConfig.get('dryRun')) {\n      logger.info('DRY-RUN: Would update migration PR');\n    } else {\n      await platform.updatePr({\n        number: existingPr.number,\n        prTitle,\n        prBody,\n      });\n      logger.info({ pr: existingPr.number }, 'Migration PR updated');\n    }\n    return existingPr;\n  }\n  logger.debug('Creating migration PR');\n  const labels = prepareLabels(config);\n  try {\n    if (GlobalConfig.get('dryRun')) {\n      logger.info('DRY-RUN: Would create migration PR');\n    } else {\n      const pr = await platform.createPr({\n        sourceBranch: branchName,\n        // TODO #22198\n        targetBranch: config.defaultBranch!,\n        prTitle,\n        prBody,\n        labels,\n        platformPrOptions: getPlatformPrOptions({\n          ...config,\n          automerge: false,\n        }),\n      });\n      logger.info({ pr: pr?.number }, 'Migration PR created');\n      if (pr) {\n        await addParticipants(config, pr);\n      }\n\n      return pr;\n    }\n  } catch (err) {\n    if (\n      err.response?.statusCode === 422 &&\n      err.response?.body?.errors?.[0]?.message?.startsWith(\n        'A pull request already exists',\n      )\n    ) {\n      logger.warn(\n        { err },\n        'Migration PR already exists but cannot find it. It was probably created by a different user.',\n      );\n      await scm.deleteBranch(branchName);\n      return null;\n    }\n    throw err;\n  }\n\n  return null;\n}\n"]}