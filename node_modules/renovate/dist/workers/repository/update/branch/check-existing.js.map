{"version":3,"file":"check-existing.js","sourceRoot":"","sources":["../../../../../lib/workers/repository/update/branch/check-existing.ts"],"names":[],"mappings":";;AAOA,4CA8CC;AArDD,cAAc;AACd,yEAA0E;AAC1E,+CAA4C;AAE5C,2DAAwD;AAGjD,KAAK,UAAU,gBAAgB,CACpC,MAAoB;IAEpB,eAAM,CAAC,KAAK,CAAC,EAAE,MAAM,EAAE,EAAE,kBAAkB,CAAC,CAAC;IAC7C,IAAI,MAAM,CAAC,cAAc,EAAE,CAAC;QAC1B,eAAM,CAAC,KAAK,CAAC,yDAAyD,CAAC,CAAC;QACxE,OAAO,IAAI,CAAC;IACd,CAAC;IACD,eAAM,CAAC,KAAK,CACV,gEAAgE,CACjE,CAAC;IACF,oCAAoC;IACpC,IAAI,EAAE,GAAG,MAAM,mBAAQ,CAAC,MAAM,CAAC;QAC7B,UAAU,EAAE,MAAM,CAAC,UAAU;QAC7B,OAAO,EAAE,MAAM,CAAC,OAAO;QACvB,KAAK,EAAE,OAAO;QACd,YAAY,EAAE,MAAM,CAAC,UAAU;KAChC,CAAC,CAAC;IAEH,IAAI,CAAC,EAAE,IAAI,MAAM,CAAC,YAAY,KAAK,MAAM,CAAC,eAAe,EAAE,CAAC;QAC1D,EAAE,GAAG,MAAM,mBAAQ,CAAC,MAAM,CAAC;YACzB,UAAU,EAAE,MAAM,CAAC,UAAU,CAAC,OAAO,CACnC,MAAM,CAAC,YAAa,EACpB,MAAM,CAAC,eAAgB,CACxB;YACD,OAAO,EAAE,MAAM,CAAC,OAAO;YACvB,KAAK,EAAE,OAAO;YACd,YAAY,EAAE,MAAM,CAAC,UAAU;SAChC,CAAC,CAAC;QACH,IAAI,EAAE,EAAE,CAAC;YACP,eAAM,CAAC,KAAK,CAAC,sCAAsC,CAAC,CAAC;QACvD,CAAC;IACH,CAAC;IAED,IAAI,EAAE,EAAE,CAAC;QACP,eAAM,CAAC,KAAK,CAAC,oCAAoC,CAAC,CAAC;QACnD,MAAM,SAAS,GAAG,MAAM,mBAAQ,CAAC,KAAK,CAAC,EAAE,CAAC,MAAM,CAAC,CAAC;QAClD,qBAAqB;QACrB,IAAI,SAAU,CAAC,KAAK,KAAK,MAAM,EAAE,CAAC;YAChC,eAAM,CAAC,KAAK,CAAC,4BAA4B,CAAC,CAAC;YAC3C,MAAM,IAAI,KAAK,CAAC,mCAAkB,CAAC,CAAC;QACtC,CAAC;QACD,OAAO,EAAE,CAAC;IACZ,CAAC;IACD,eAAM,CAAC,KAAK,CAAC,wBAAwB,CAAC,CAAC;IACvC,OAAO,IAAI,CAAC;AACd,CAAC","sourcesContent":["// TODO #22198\nimport { REPOSITORY_CHANGED } from '../../../../constants/error-messages';\nimport { logger } from '../../../../logger';\nimport type { Pr } from '../../../../modules/platform';\nimport { platform } from '../../../../modules/platform';\nimport type { BranchConfig } from '../../../types';\n\nexport async function prAlreadyExisted(\n  config: BranchConfig,\n): Promise<Pr | null> {\n  logger.trace({ config }, 'prAlreadyExisted');\n  if (config.recreateClosed) {\n    logger.debug('recreateClosed is true. No need to check for closed PR.');\n    return null;\n  }\n  logger.debug(\n    'Check for closed PR because recreating closed PRs is disabled.',\n  );\n  // Return if same PR already existed\n  let pr = await platform.findPr({\n    branchName: config.branchName,\n    prTitle: config.prTitle,\n    state: '!open',\n    targetBranch: config.baseBranch,\n  });\n\n  if (!pr && config.branchPrefix !== config.branchPrefixOld) {\n    pr = await platform.findPr({\n      branchName: config.branchName.replace(\n        config.branchPrefix!,\n        config.branchPrefixOld!,\n      ),\n      prTitle: config.prTitle,\n      state: '!open',\n      targetBranch: config.baseBranch,\n    });\n    if (pr) {\n      logger.debug('Found closed PR with branchPrefixOld');\n    }\n  }\n\n  if (pr) {\n    logger.debug('Found closed PR with current title');\n    const prDetails = await platform.getPr(pr.number);\n    // istanbul ignore if\n    if (prDetails!.state === 'open') {\n      logger.debug('PR reopened - aborting run');\n      throw new Error(REPOSITORY_CHANGED);\n    }\n    return pr;\n  }\n  logger.debug('prAlreadyExisted=false');\n  return null;\n}\n"]}