{"version":3,"file":"status-checks.js","sourceRoot":"","sources":["../../../../../lib/workers/repository/update/branch/status-checks.ts"],"names":[],"mappings":"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","sourcesContent":["import type { RenovateConfig } from '../../../../config/types';\nimport { logger } from '../../../../logger';\nimport { platform } from '../../../../modules/platform';\nimport type { BranchStatus } from '../../../../types';\nimport { isActiveConfidenceLevel } from '../../../../util/merge-confidence';\nimport type { MergeConfidence } from '../../../../util/merge-confidence/types';\nimport { coerceString } from '../../../../util/string';\nimport { joinUrlParts } from '../../../../util/url';\n\nexport async function resolveBranchStatus(\n  branchName: string,\n  internalChecksAsSuccess: boolean,\n  ignoreTests = false,\n): Promise<BranchStatus> {\n  logger.debug(\n    `resolveBranchStatus(branchName=${branchName}, ignoreTests=${ignoreTests})`,\n  );\n\n  if (ignoreTests) {\n    logger.debug('Ignore tests. Return green');\n    return 'green';\n  }\n\n  const status = await platform.getBranchStatus(\n    branchName,\n    internalChecksAsSuccess,\n  );\n  logger.debug(`Branch status ${status}`);\n\n  return status;\n}\n\nasync function setStatusCheck(\n  branchName: string,\n  context: string,\n  description: string,\n  state: BranchStatus,\n  url?: string,\n): Promise<void> {\n  const existingState = await platform.getBranchStatusCheck(\n    branchName,\n    context,\n  );\n  if (existingState === state) {\n    logger.debug(`Status check ${context} is already up-to-date`);\n  } else {\n    logger.debug(`Updating ${context} status check state to ${state}`);\n    await platform.setBranchStatus({\n      branchName,\n      context,\n      description,\n      state,\n      url,\n    });\n  }\n}\n\nexport interface StabilityConfig extends RenovateConfig {\n  stabilityStatus?: BranchStatus;\n  branchName: string;\n}\n\nexport async function setStability(config: StabilityConfig): Promise<void> {\n  if (!config.stabilityStatus) {\n    return;\n  }\n\n  const context = config.statusCheckNames?.minimumReleaseAge;\n  if (!context) {\n    logger.debug(\n      'Status check is null or an empty string, skipping status check addition.',\n    );\n    return;\n  }\n\n  const description =\n    config.stabilityStatus === 'green'\n      ? 'Updates have met minimum release age requirement'\n      : 'Updates have not met minimum release age requirement';\n\n  const docsLink = joinUrlParts(\n    coerceString(config.productLinks?.documentation),\n    'configuration-options/#minimumreleaseage',\n  );\n\n  await setStatusCheck(\n    config.branchName,\n    context,\n    description,\n    config.stabilityStatus,\n    docsLink,\n  );\n}\n\nexport interface ConfidenceConfig extends RenovateConfig {\n  confidenceStatus?: BranchStatus;\n  minimumConfidence?: MergeConfidence | undefined;\n}\n\nexport async function setConfidence(config: ConfidenceConfig): Promise<void> {\n  if (\n    !config.branchName ||\n    !config.confidenceStatus ||\n    (config.minimumConfidence &&\n      !isActiveConfidenceLevel(config.minimumConfidence))\n  ) {\n    return;\n  }\n  const context = config.statusCheckNames?.mergeConfidence;\n  if (!context) {\n    logger.debug(\n      'Status check is null or an empty string, skipping status check addition.',\n    );\n    return;\n  }\n\n  const description =\n    config.confidenceStatus === 'green'\n      ? 'Updates have met Merge Confidence requirement'\n      : 'Updates have not met Merge Confidence requirement';\n\n  const docsLink = joinUrlParts(\n    coerceString(config.productLinks?.documentation),\n    'merge-confidence',\n  );\n\n  await setStatusCheck(\n    config.branchName,\n    context,\n    description,\n    config.confidenceStatus,\n    docsLink,\n  );\n}\n"]}