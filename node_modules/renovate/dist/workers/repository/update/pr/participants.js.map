{"version":3,"file":"participants.js","sourceRoot":"","sources":["../../../../../lib/workers/repository/update/pr/participants.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { GlobalConfig } from '../../../../config/global';\nimport type { RenovateConfig } from '../../../../config/types';\nimport { logger } from '../../../../logger';\nimport type { Pr } from '../../../../modules/platform';\nimport { platform } from '../../../../modules/platform';\nimport { noLeadingAtSymbol } from '../../../../util/common';\nimport { sampleSize } from '../../../../util/sample';\nimport { codeOwnersForPr } from './code-owners';\n\nasync function addCodeOwners(\n  config: RenovateConfig,\n  assigneesOrReviewers: string[],\n  pr: Pr,\n): Promise<string[]> {\n  const codeOwners = await codeOwnersForPr(pr);\n\n  const assignees =\n    config.expandCodeOwnersGroups && platform.expandGroupMembers\n      ? await platform.expandGroupMembers(codeOwners)\n      : codeOwners;\n\n  return [...new Set(assigneesOrReviewers.concat(assignees))];\n}\n\nfunction filterUnavailableUsers(\n  config: RenovateConfig,\n  users: string[],\n): Promise<string[]> {\n  return config.filterUnavailableUsers && platform.filterUnavailableUsers\n    ? platform.filterUnavailableUsers(users)\n    : Promise.resolve(users);\n}\n\nfunction prepareParticipants(\n  config: RenovateConfig,\n  usernames: string[],\n): Promise<string[]> {\n  const normalizedUsernames = [...new Set(usernames.map(noLeadingAtSymbol))];\n  return filterUnavailableUsers(config, normalizedUsernames);\n}\n\nexport async function addParticipants(\n  config: RenovateConfig,\n  pr: Pr,\n): Promise<void> {\n  let assignees = config.assignees ?? [];\n  logger.debug(`addParticipants(pr=${pr?.number})`);\n  if (config.assigneesFromCodeOwners) {\n    assignees = await addCodeOwners(config, assignees, pr);\n  }\n  if (assignees.length > 0) {\n    try {\n      assignees = await prepareParticipants(config, assignees);\n      if (is.number(config.assigneesSampleSize)) {\n        assignees = sampleSize(assignees, config.assigneesSampleSize);\n      }\n      if (assignees.length > 0) {\n        if (GlobalConfig.get('dryRun')) {\n          logger.info(`DRY-RUN: Would add assignees to PR #${pr.number}`);\n        } else {\n          await platform.addAssignees(pr.number, assignees);\n          logger.debug({ assignees }, 'Added assignees');\n        }\n      }\n    } catch (err) {\n      logger.debug(\n        { assignees: config.assignees, err },\n        'Failed to add assignees',\n      );\n    }\n  }\n\n  let reviewers = config.reviewers ?? [];\n  if (config.reviewersFromCodeOwners) {\n    reviewers = await addCodeOwners(config, reviewers, pr);\n    logger.debug(\n      `Reviewers from code owners: ${reviewers.map((reviewer) => `\"${reviewer}\"`).join(', ')}`,\n    );\n  }\n  if (\n    is.array(config.additionalReviewers) &&\n    config.additionalReviewers.length > 0\n  ) {\n    logger.debug(\n      `Additional reviewers: ${config.additionalReviewers.map((reviewer) => `\"${reviewer}\"`).join(', ')}`,\n    );\n    reviewers = reviewers.concat(config.additionalReviewers);\n  }\n  if (reviewers.length > 0) {\n    try {\n      reviewers = await prepareParticipants(config, reviewers);\n      if (is.number(config.reviewersSampleSize)) {\n        logger.debug(\n          `Sampling reviewersSampleSize=${config.reviewersSampleSize} reviewers`,\n        );\n        reviewers = sampleSize(reviewers, config.reviewersSampleSize);\n      }\n      if (reviewers.length > 0) {\n        if (GlobalConfig.get('dryRun')) {\n          logger.info(`DRY-RUN: Would add reviewers to PR #${pr.number}`);\n        } else {\n          await platform.addReviewers(pr.number, reviewers);\n          logger.debug({ reviewers }, 'Added reviewers');\n        }\n      }\n    } catch (err) {\n      logger.debug(\n        { reviewers: config.reviewers, err },\n        'Failed to add reviewers',\n      );\n    }\n  }\n}\n"]}