{"version":3,"file":"autodiscover.js","sourceRoot":"","sources":["../../../lib/workers/global/autodiscover.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport type { AllConfig } from '../../config/types';\nimport { logger } from '../../logger';\nimport { platform } from '../../modules/platform';\nimport { minimatchFilter } from '../../util/minimatch';\nimport { getRegexPredicate, isRegexMatch } from '../../util/string-match';\n\n// istanbul ignore next\nfunction repoName(value: string | { repository: string }): string {\n  return String(is.string(value) ? value : value.repository).toLowerCase();\n}\n\nexport async function autodiscoverRepositories(\n  config: AllConfig,\n): Promise<AllConfig> {\n  const { autodiscoverFilter } = config;\n  if (config.platform === 'local') {\n    if (config.repositories?.length) {\n      logger.debug(\n        { repositories: config.repositories },\n        'Found repositories when in local mode',\n      );\n      throw new Error(\n        'Invalid configuration: repositories list not supported when platform=local',\n      );\n    }\n    config.repositories = ['local'];\n    return config;\n  }\n  if (!config.autodiscover) {\n    if (!config.repositories?.length) {\n      logger.warn(\n        'No repositories found - did you want to run with flag --autodiscover?',\n      );\n    }\n    return config;\n  }\n  // Autodiscover list of repositories\n  let discovered = await platform.getRepos({\n    topics: config.autodiscoverTopics,\n    sort: config.autodiscoverRepoSort,\n    order: config.autodiscoverRepoOrder,\n    includeMirrors: config.includeMirrors,\n    namespaces: config.autodiscoverNamespaces,\n    projects: config.autodiscoverProjects,\n  });\n  if (!discovered?.length) {\n    // Soft fail (no error thrown) if no accessible repositories\n    logger.debug('No repositories were autodiscovered');\n    return config;\n  }\n\n  logger.debug(`Autodiscovered ${discovered.length} repositories`);\n  logger.trace(\n    { length: discovered.length, repositories: discovered },\n    `Autodiscovered repositories`,\n  );\n\n  if (autodiscoverFilter) {\n    logger.debug({ autodiscoverFilter }, 'Applying autodiscoverFilter');\n    discovered = applyFilters(\n      discovered,\n      is.string(autodiscoverFilter) ? [autodiscoverFilter] : autodiscoverFilter,\n    );\n\n    if (!discovered.length) {\n      // Soft fail (no error thrown) if no accessible repositories match the filter\n      logger.debug('None of the discovered repositories matched the filter');\n      return config;\n    }\n  }\n\n  logger.info(\n    { length: discovered.length, repositories: discovered },\n    `Autodiscovered repositories`,\n  );\n\n  // istanbul ignore if\n  if (config.repositories?.length) {\n    logger.debug(\n      'Checking autodiscovered repositories against configured repositories',\n    );\n    for (const configuredRepo of config.repositories) {\n      const repository = repoName(configuredRepo);\n      let found = false;\n      for (let i = discovered.length - 1; i > -1; i -= 1) {\n        if (repository === repoName(discovered[i])) {\n          found = true;\n          logger.debug({ repository }, 'Using configured repository settings');\n          // TODO: fix typings\n          discovered[i] = configuredRepo as never;\n        }\n      }\n      if (!found) {\n        logger.warn(\n          { repository },\n          'Configured repository is in not in autodiscover list',\n        );\n      }\n    }\n  }\n  return { ...config, repositories: discovered };\n}\n\nexport function applyFilters(repos: string[], filters: string[]): string[] {\n  const matched = new Set<string>();\n\n  for (const filter of filters) {\n    let res: string[];\n    if (isRegexMatch(filter)) {\n      const autodiscoveryPred = getRegexPredicate(filter);\n      if (!autodiscoveryPred) {\n        throw new Error(`Failed to parse regex pattern \"${filter}\"`);\n      }\n      res = repos.filter(autodiscoveryPred);\n    } else {\n      res = repos.filter(minimatchFilter(filter, { dot: true, nocase: true }));\n    }\n    for (const repository of res) {\n      matched.add(repository);\n    }\n  }\n  return repos.filter((repository) => matched.has(repository));\n}\n"]}