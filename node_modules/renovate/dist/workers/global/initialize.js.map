{"version":3,"file":"initialize.js","sourceRoot":"","sources":["../../../lib/workers/global/initialize.ts"],"names":[],"mappings":"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","sourcesContent":["import os from 'node:os';\nimport fs from 'fs-extra';\nimport upath from 'upath';\nimport { applySecretsToConfig } from '../../config/secrets';\nimport type { AllConfig, RenovateConfig } from '../../config/types';\nimport { logger } from '../../logger';\nimport { resetGlobalLogLevelRemaps } from '../../logger/remap';\nimport { initPlatform } from '../../modules/platform';\nimport * as packageCache from '../../util/cache/package';\nimport { setEmojiConfig } from '../../util/emoji';\nimport { validateGitVersion } from '../../util/git';\nimport * as hostRules from '../../util/host-rules';\nimport { setHttpRateLimits } from '../../util/http/rate-limits';\nimport { initMergeConfidence } from '../../util/merge-confidence';\nimport { setMaxLimit } from './limits';\n\nasync function setDirectories(input: AllConfig): Promise<AllConfig> {\n  const config: AllConfig = { ...input };\n  process.env.TMPDIR = process.env.RENOVATE_TMPDIR ?? os.tmpdir();\n  if (config.baseDir) {\n    logger.debug('Using configured baseDir: ' + config.baseDir);\n  } else {\n    config.baseDir = upath.join(process.env.TMPDIR, 'renovate');\n    logger.debug('Using baseDir: ' + config.baseDir);\n  }\n  await fs.ensureDir(config.baseDir);\n  if (config.cacheDir) {\n    logger.debug('Using configured cacheDir: ' + config.cacheDir);\n  } else {\n    config.cacheDir = upath.join(config.baseDir, 'cache');\n    logger.debug('Using cacheDir: ' + config.cacheDir);\n  }\n  await fs.ensureDir(config.cacheDir);\n  if (config.binarySource === 'docker' || config.binarySource === 'install') {\n    if (config.containerbaseDir) {\n      logger.debug(\n        'Using configured containerbaseDir: ' + config.containerbaseDir,\n      );\n    } else {\n      config.containerbaseDir = upath.join(config.cacheDir, 'containerbase');\n      logger.debug('Using containerbaseDir: ' + config.containerbaseDir);\n    }\n    await fs.ensureDir(config.containerbaseDir);\n  }\n  return config;\n}\n\nfunction limitCommitsPerRun(config: RenovateConfig): void {\n  let limit = config.prCommitsPerRunLimit;\n  limit = typeof limit === 'number' && limit > 0 ? limit : null;\n  setMaxLimit('Commits', limit);\n}\n\nasync function checkVersions(): Promise<void> {\n  const validGitVersion = await validateGitVersion();\n  if (!validGitVersion) {\n    throw new Error('Init: git version needs upgrading');\n  }\n}\n\nfunction setGlobalHostRules(config: RenovateConfig): void {\n  if (config.hostRules) {\n    logger.debug('Setting global hostRules');\n    applySecretsToConfig(config, undefined, false);\n    config.hostRules.forEach((rule) => hostRules.add(rule));\n  }\n}\n\nfunction configureThirdPartyLibraries(config: AllConfig): void {\n  // Not using early return style to make clear what's the criterion to set the variables,\n  // especially when there is more stuff added here in the future.\n  if (!config.useCloudMetadataServices) {\n    logger.debug('Disabling the use of cloud metadata services');\n    process.env.AWS_EC2_METADATA_DISABLED = 'true'; // See https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-envvars.html#envvars-list\n    process.env.METADATA_SERVER_DETECTION = 'none'; // See https://cloud.google.com/nodejs/docs/reference/gcp-metadata/latest#environment-variables\n  }\n}\n\nexport async function globalInitialize(\n  config_: AllConfig,\n): Promise<RenovateConfig> {\n  let config = config_;\n  setHttpRateLimits();\n  await checkVersions();\n  setGlobalHostRules(config);\n  config = await initPlatform(config);\n  config = await setDirectories(config);\n  await packageCache.init(config);\n  limitCommitsPerRun(config);\n  setEmojiConfig(config);\n  setGlobalHostRules(config);\n  configureThirdPartyLibraries(config);\n  await initMergeConfidence(config);\n  return config;\n}\n\nexport async function globalFinalize(config: RenovateConfig): Promise<void> {\n  await packageCache.cleanup(config);\n  resetGlobalLogLevelRemaps();\n}\n"]}