# Build the RunWhen Local image
name: Discovery Test

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "src/**"
      - ".github/workflows/test.yaml"

permissions:
  contents: "read"
  id-token: "write"
  security-events: "write"
  actions: "read"

env:
  PROJECT_ID: runwhen-nonprod-shared
  DEFAULT_BRANCH: "origin/${{ github.event.repository.default_branch }}"


# jobs:
#   k8s-basic-test:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Install Task
#         uses: arduino/setup-task@v2
#         with:
#           version: 3.x

#       - uses: actions/checkout@v2
#         name: Checkout

#       - name: Build Image
#         run: |-
#           cd .test/k8s/basic
#           docker buildx create --use --name=mybuilder
#           docker buildx inspect --bootstrap
#           task build-rwl

#       - name: Run k8s/basic ci-test-1
#         env:
#           KUBECONFIG_SECRET: ${{secrets.SANDBOX_KUBECONFIG}}
#         run: |-
#           cd .test/k8s/basic
#           echo "$KUBECONFIG_SECRET" > kubeconfig.secret
#           task ci-test-1


#       - name: Run k8s/basic ci-test-2
#         env:
#           KUBECONFIG_SECRET: ${{secrets.SANDBOX_KUBECONFIG}}
#         run: |-
#           cd .test/k8s/basic
#           echo "$KUBECONFIG_SECRET" > kubeconfig.secret
#           task ci-test-2
          
jobs:
  build-image:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ github.sha }}
    steps:
      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x

      - uses: actions/checkout@v2
        name: Checkout

      - name: Build Image
        run: |-
          cd .test/k8s/basic
          docker buildx create --use --name=mybuilder
          docker buildx inspect --bootstrap
          task build-rwl
          docker save -o image.tar runwhen-local:test || (echo "Image not found!" && exit 1)


      - name: Upload Image as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: container-image
          path: .test/k8s/basic/image.tar
          retention-days: 1

  k8s-basic-test:
    needs: build-image
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test: [ci-test-1, ci-test-2]  # Define multiple tests
    steps:
      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x

      - uses: actions/checkout@v2
        name: Checkout

      - name: Download Image Artifact
        uses: actions/download-artifact@v4
        with:
          name: container-image
          path: .test/k8s/basic

      - name: Load Docker Image
        run: |
          docker load -i .test/k8s/basic/image.tar

      - name: Run Test - ${{ matrix.test }}
        env:
          KUBECONFIG_SECRET: ${{ secrets.SANDBOX_KUBECONFIG }}
        run: |-
          cd .test/k8s/basic
          echo "$KUBECONFIG_SECRET" > kubeconfig.secret
          task ${{ matrix.test }}