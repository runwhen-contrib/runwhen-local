# RunWhen Platform Upload
The Workspace Builder component of RunWhen Local generates all necessary configuration files to bootstrap a workspace within the RunWhen Platform with provides: 

- Collaborative maps
- Collaborative troubleshooting
- Troubleshooting Digital Assistants
- Automated workflows

Workspace Builder generated a total of: **{{ slx_count }} SLXs**

## 1. Setting Up a Workspace

- <a href="https://app.beta.runwhen.com/" target="_blank">Login to RunWhen Platform Beta Instance</a>
- <a href="https://app.beta.runwhen.com/?addWorkspace=true" target="_blank">Create a workspace</a>
- Put that cool workspace name that you created in this box: <br>
<input type="text" id="workspaceName"><a href="javascript:void(0)" onclick="updateLink()"><br>Submit</a>

## 2. Preparing for Upload

- <a href="#" id="dynamicUploadInfoLink" target="_blank">Download workspace tethering configuration file</a>
- Add this file to the RunWhen Local container with **one of the following options**: 

    ??? "Direct Upload (Recommended for first time users)"
        Upload the `uploadInfo.yaml` for one-time use. This file may be removed when the container restarts.
        <br><input type="file" id="fileInput">
        <div class="card">
            <img class="card-icon" src="https://storage.googleapis.com/runwhen-nonprod-shared-images/icons/cloud_upload.svg" alt="Icon" />
            <h6 class="card-title">
            <a href="javascript:void(0)" onclick="uploadFile()">Upload to Container</a>
        </div>

    ??? "Use the Built-In Terminal"
        If the in-browser terminal is available: 

        - copy the contents of `uploadInfo.yaml` into your clipboard
        - open the terminal (top right corner)
        - using `cat` or `vi`, paste the contents into `/shared/uploadInfo.yaml`
        <img src="../assets/uploadInfo.gif" />

    ??? "Use Your Terminal (Running Locally)"
        From your own terminal, cp the `uploadInfo.yaml` file into `$workdir/shared/uploadInfo.yaml`:
        <div class="code-block-container">
        <pre class="code-block"><code>
        cp /path/to/uploadInfo.yaml $workdir/shared/uploadInfo.yaml 
        </code></pre>
        </div>

    ??? "Update Helm (Running in Kubernetes)"
        If using Helm, add the `uploadInfo.yaml` details as part of your values.yaml specification. The following example demonstrates a Helm configuration for use with FluxCD: 
        <div class="code-block-container">
        <pre class="code-block"><code>
        apiVersion: helm.toolkit.fluxcd.io/v2beta1
        kind: HelmRelease
        metadata:
            name: runwhen-local
            namespace: runwhen-local
        spec:
          releaseName: runwhen-local
          chart:
            spec:
              chart: runwhen-local
              # https://github.com/runwhen-contrib/helm-charts/blob/main/charts/runwhen-local/values.yaml
              version: 0.0.21
              sourceRef:
                kind: HelmRepository
                name: runwhen-contrib
                namespace: flux-system
              interval: 5m
              values:
                image: 
                  repository: ghcr.io/runwhen-contrib/runwhen-local
                  tag: latest
                uploadInfo:
                  defaultLocation: location-01-us-west1
                  papiURL: https://papi.beta.runwhen.com
                  token: [token]
                  workspaceName: b-sandbox
                  workspaceOwnerEmail: workspace-user@tester.com
        </code></pre>
        </div>
        See the [full values.yaml](https://github.com/runwhen-contrib/helm-charts/blob/main/charts/runwhen-local/values.yaml) for reference. 
        > Note: When updating your Helm values, this can trigger a redeployment of the container and a new discovery will take place. 

    ??? warning "Permission Issues"
        If you experience permission issues, ensure that `$workdir/shared` has open permissions. The `runwhen` user in the container needs to read & write from this directory. If running locally in Docker/Podman, this directory is shared with your own filesystem and often owned by your local user. `chmod 777 $workdir/shared` may be required. 



## 3. Upload Workspace Configuration
- Browse the configuration data to review the content that will be uploaded
    - From your local filesystem (if running locally) - `tree $workdir/shared/output/workspaces`
    - From the in-browser terminal - `tree /shared/output/workspaces`
  
  

-  Upload the configuration data with **one of the following options**:

<button id="runUploadPreserveButton" class="md-button">Upload (Preserve Existing Configurations)</button>
<button id="runUploadOverwriteButton" class="md-button">Upload (Overwrite Existing Configurations)</button>

## 4. Creating Secrets
In order for the RunWhen Platform to connect with your cluster(s) and cloud resources, **secrets** are required in your workspace. 

{% if 'kubernetes' in auth_details %}
??? info "Kubeconfig Secret"
    In order for RunWhen Platform to connect to your Kubernetes based clusters, a **secret** must be created in the form of a KUBECONFIG.

    {% if 'user-provided' in auth_details['kubernetes']['type'] %}
    Your Kubernetes auth type has been detected as: `{{ auth_details["kubernetes"]["type"] }}`
    Kubeconfig content:  

    - Context Count: `{{ auth_details["kubernetes"]['kubeconfig_details']['contexts']|length }}`
    - Context Name(s):
    {% for context in auth_details["kubernetes"]['kubeconfig_details']['contexts'] %}
        - `{{ context.name }}`
    {% endfor %}

    - The **Secret Key** should be set to: `{{ workspace_info["custom"]["kubeconfig_secret_name"] | default('kubeconfig') }}`

    If the kubeconfig that you provided utilized short-lived tokens (such as those generaged from gcloud, az, and aws cli auth plugins), then a long-lived service account and token is required for every cluster context. 

    - The **Secret Value** should be set to: 

    {% elif 'in-cluster' in auth_details['kubernetes']['type'] %}

    {% else %}
    Could not determine Kubernetes auth type. 
    Your Kubernetes auth type has been detected as: `{{ auth_details["kubernetes"]["type"] }}`
    {% endif %}

    To create the secret, please:

    - Click <a href="#" id="dynamicSecretLink" target="_blank">this link</a>
    - Select **+ ADD SECRET**
    - Set the **Secret Key**
    - Set the **Secret Value**
    - Select **ADD AND SAVE**
    
{% endif %}

<script>
function updateLink() {
    let workspaceName = document.getElementById('workspaceName').value;
    if (workspaceName) {
        let uploadInfolink = document.getElementById('dynamicUploadInfoLink');
        uploadInfolink.href = "https://app.beta.runwhen.com/workspace/" +workspaceName + "/configuration/workspace#" 
        let secretlink = document.getElementById('dynamicSecretLink');
        secretlink.href = "https://app.beta.runwhen.com/workspace/" +workspaceName + "/configuration/secrets#" 
    }
}
function uploadFile() {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a file first.');
        return;
    }

    const formData = new FormData();
    formData.append('file', file);

    // Send the file to the server using Fetch API
    fetch('/store-uploadinfo', {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(data => {
        alert(data);
    })
    .catch(error => {
        alert('Error uploading the file.');
        console.error(error);
    });
}
document.getElementById('runUploadPreserveButton').addEventListener('click', function() {
    event.preventDefault();
    // Call the /run-discovery endpoint using the fetch API
    fetch('/run-upload-to-runwhenplatform-keep-existing')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.text();
        })
        .then(data => {
            // Call the showCommandOutput function to display the data in the styled popup
            showCommandOutput(data);
        })
        .catch(error => {
            console.error('There was a problem with the upload operation:', error.message);
        });
});
document.getElementById('runUploadOverwriteButton').addEventListener('click', function() {
    event.preventDefault();
    // Call the /run-discovery endpoint using the fetch API
    fetch('/run-upload-to-runwhenplatform-keep-uploaded')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.text();
        })
        .then(data => {
            // Call the showCommandOutput function to display the data in the styled popup
            showCommandOutput(data);
        })
        .catch(error => {
            console.error('There was a problem with the upload operation:', error.message);
        });
});

function showCommandOutput(data) {
    const popupContainer = document.createElement("div"); 
    const popup = document.createElement("div");
    popup.classList.add("popup");

    const closeButton = document.createElement("span");
    closeButton.classList.add("close");
    closeButton.innerHTML = "&times;";
    closeButton.style.fontSize = "24px"; 
    closeButton.style.position = "absolute";
    closeButton.style.top = "10px";
    closeButton.style.right = "10px";

    const title = document.createElement("p");
    title.innerText = "Command Output";

    const codeBlock = document.createElement("pre");
    codeBlock.classList.add("code-block");
    codeBlock.innerText = data;

    popup.appendChild(closeButton);
    popup.appendChild(title);
    popup.appendChild(codeBlock);
    popupContainer.appendChild(popup);
    document.body.appendChild(popupContainer);

    // Event delegation for close button click
    popupContainer.addEventListener("click", (event) => {
        const target = event.target;
        if (target.classList.contains("close")) {
            event.stopPropagation();
            document.body.removeChild(popupContainer);
        }
    });
}
</script>
