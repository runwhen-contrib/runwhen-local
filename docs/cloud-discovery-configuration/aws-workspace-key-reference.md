# AWS WorkspaceKey Reference

This document enumerates all possible AWS `workspaceKey` patterns generated by RunWhen Local for use in codebundles and other integrations.

## Overview

WorkspaceKeys follow the pattern: `{provider}:{method}@{type}[:{parameters}]`

- **provider**: `aws` or `k8s`
- **method**: Authentication method (e.g., `irsa`, `access_key`, `assume_role`, `cli`)
- **type**: Resource type (e.g., `cli`, `kubeconfig`, `secret`)
- **parameters**: Optional context-specific parameters

---

## 1. AWS CLI Credentials (Non-EKS Resources)

Used for accessing AWS resources like S3, EC2, RDS, etc.

### 1.1 IRSA (Workload Identity)

**Pattern:** `aws:irsa@cli`

**Auth Type:** `aws_workload_identity`

**Example:**
```yaml
secretsProvided:
  - name: aws_credentials
    workspaceKey: aws:irsa@cli
```

**Description:** Uses EKS IRSA (IAM Roles for Service Accounts). No additional credentials needed - uses projected service account token.

**Environment Variables Used:**
- `AWS_WEB_IDENTITY_TOKEN_FILE`
- `AWS_ROLE_ARN`
- `AWS_ROLE_SESSION_NAME`

---

### 1.2 Pod Identity

**Pattern:** `aws:pod-identity@cli`

**Auth Type:** `aws_pod_identity`

**Example:**
```yaml
secretsProvided:
  - name: aws_credentials
    workspaceKey: aws:pod-identity@cli
```

**Description:** Uses EKS Pod Identity (newer alternative to IRSA). No additional credentials needed - credentials provided via EKS Pod Identity Agent.

**Environment Variables Used:**
- `AWS_CONTAINER_CREDENTIALS_FULL_URI`
- `AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE`

**Requirements:**
- EKS 1.24+ with Pod Identity Agent addon enabled
- PodIdentityAssociation linking service account to IAM role

---

### 1.3 Explicit Access Keys

**Pattern:** `aws:access_key@cli`

**Auth Type:** `aws_explicit` or `aws_secret`

**Example (with custom secret):**
```yaml
secretsProvided:
  - name: aws_credentials
    workspaceKey: aws:access_key@cli
  - name: AWS_ACCESS_KEY_ID
    workspaceKey: k8s:file@secret/my-aws-credentials:awsAccessKeyId
  - name: AWS_SECRET_ACCESS_KEY
    workspaceKey: k8s:file@secret/my-aws-credentials:awsSecretAccessKey
```

**Example (with auth_secret):**
```yaml
secretsProvided:
  - name: aws_credentials
    workspaceKey: aws:access_key@cli
  - name: AWS_ACCESS_KEY_ID
    workspaceKey: k8s:file@secret/team-a-aws-creds:awsAccessKeyId
  - name: AWS_SECRET_ACCESS_KEY
    workspaceKey: k8s:file@secret/team-a-aws-creds:awsSecretAccessKey
```

**Description:** Uses explicit AWS access keys stored in a Kubernetes secret.

**Secret Keys:**
- `awsAccessKeyId` - AWS Access Key ID
- `awsSecretAccessKey` - AWS Secret Access Key

---

### 1.4 Assume Role

**Pattern:** `aws:assume_role@cli`

**Auth Type:** `aws_assume_role`

**Example:**
```yaml
secretsProvided:
  - name: aws_credentials
    workspaceKey: aws:assume_role@cli
  - name: aws_role_arn
    value: "arn:aws:iam::123456789012:role/MyRole"
```

**Description:** Uses default credential chain to assume an IAM role. The role ARN is provided as a value.

---

### 1.4 Explicit Access Keys + Assume Role

**Pattern:** `aws:assume_role@cli`

**Auth Type:** `aws_explicit_assume_role` or `aws_secret_assume_role`

**Example (with custom secret):**
```yaml
secretsProvided:
  - name: aws_credentials
    workspaceKey: aws:assume_role@cli
  - name: AWS_ACCESS_KEY_ID
    workspaceKey: k8s:file@secret/base-credentials:awsAccessKeyId
  - name: AWS_SECRET_ACCESS_KEY
    workspaceKey: k8s:file@secret/base-credentials:awsSecretAccessKey
  - name: AWS_ROLE_ARN
    value: "arn:aws:iam::987654321098:role/CrossAccountRole"
```

**Example (with auth_secret):**
```yaml
secretsProvided:
  - name: aws_credentials
    workspaceKey: aws:assume_role@cli
  - name: AWS_ACCESS_KEY_ID
    workspaceKey: k8s:file@secret/my-base-creds:awsAccessKeyId
  - name: AWS_SECRET_ACCESS_KEY
    workspaceKey: k8s:file@secret/my-base-creds:awsSecretAccessKey
  - name: AWS_ROLE_ARN
    value: "arn:aws:iam::111111111111:role/TargetRole"
```

**Description:** Uses explicit access keys as base credentials to assume a target role.

---

### 1.6 IRSA + Assume Role

**Pattern:** `aws:irsa@cli`

**Auth Type:** `aws_workload_identity_assume_role`

**Example:**
```yaml
secretsProvided:
  - name: aws_credentials
    workspaceKey: aws:irsa@cli
  - name: AWS_ROLE_ARN
    value: "arn:aws:iam::222222222222:role/CrossAccountRole"
```

**Description:** Uses IRSA as base credentials to assume a target role (cross-account access).

---

### 1.7 Pod Identity + Assume Role

**Pattern:** `aws:pod-identity@cli` + `AWS_ROLE_ARN`

**Auth Type:** `aws_pod_identity_assume_role`

**Example:**
```yaml
secretsProvided:
  - name: aws_credentials
    workspaceKey: aws:pod-identity@cli
  - name: AWS_ROLE_ARN
    value: "arn:aws:iam::123456789012:role/my-cross-account-role"
```

**Description:** Uses EKS Pod Identity as base credentials, then assumes an additional IAM role. Useful for cross-account access or additional privilege escalation.

---

### 1.8 Default Credential Chain

**Pattern:** `aws:default@cli`

**Auth Type:** `aws_default_chain`

**Example:**
```yaml
secretsProvided:
  - name: aws_credentials
    workspaceKey: aws:default@cli
```

**Description:** Uses boto3's default credential provider chain (environment variables, ~/.aws/credentials, IAM roles, etc.).

---

## 2. EKS Kubeconfig Credentials

Used for accessing EKS clusters for Kubernetes operations.

### 2.1 IRSA (Workload Identity)

**Pattern:** `aws:irsa@eks:{cluster_name}:{region}`

**Auth Type:** `aws_workload_identity`

**Example:**
```yaml
secretsProvided:
  - name: aws_credentials
    workspaceKey: aws:irsa@eks:my-eks-cluster:us-west-2
```

**Description:** Uses IRSA for EKS cluster authentication. Automatically generates kubeconfig.

---

### 2.2 Pod Identity

**Pattern:** `aws:pod-identity@eks:{cluster_name}:{region}`

**Auth Type:** `aws_pod_identity`

**Example:**
```yaml
secretsProvided:
  - name: aws_credentials
    workspaceKey: aws:pod-identity@eks:my-eks-cluster:us-west-2
```

**Description:** Uses Pod Identity for EKS cluster authentication. Automatically generates kubeconfig.

---

**Pattern:** `aws:workload_identity@kubeconfig:{region}/{cluster_name}`

**Auth Type:** `aws_workload_identity`

**Example:**
```yaml
secretsProvided:
  - name: kubeconfig
    workspaceKey: aws:workload_identity@kubeconfig:us-east-1/my-eks-cluster
```

**Description:** Generates kubeconfig using IRSA credentials for EKS cluster authentication.

**Parameters:**
- `region`: AWS region (e.g., `us-east-1`, `us-west-2`)
- `cluster_name`: EKS cluster name

---

### 2.3 Explicit Access Keys (EKS)

**Pattern:** `aws:cli@kubeconfig:{region}/{cluster_name}`

**Auth Type:** `aws_explicit`

**Example:**
```yaml
secretsProvided:
  - name: kubeconfig
    workspaceKey: aws:cli@kubeconfig:us-west-2/prod-cluster
  - name: AWS_ACCESS_KEY_ID
    workspaceKey: k8s:file@secret/eks-credentials:AWS_ACCESS_KEY_ID
  - name: AWS_SECRET_ACCESS_KEY
    workspaceKey: k8s:file@secret/eks-credentials:AWS_SECRET_ACCESS_KEY
```

**Description:** Generates kubeconfig using explicit AWS credentials for EKS authentication.

**Secret Keys:**
- `AWS_ACCESS_KEY_ID` - AWS Access Key ID
- `AWS_SECRET_ACCESS_KEY` - AWS Secret Access Key

---

### 2.4 Kubernetes Secret (EKS)

**Pattern:** `aws:cli@kubeconfig:{region}/{cluster_name}`

**Auth Type:** `aws_secret`

**Example:**
```yaml
secretsProvided:
  - name: kubeconfig
    workspaceKey: aws:cli@kubeconfig:eu-west-1/staging-cluster
  - name: AWS_ACCESS_KEY_ID
    workspaceKey: k8s:file@secret/team-b-eks-auth:AWS_ACCESS_KEY_ID
  - name: AWS_SECRET_ACCESS_KEY
    workspaceKey: k8s:file@secret/team-b-eks-auth:AWS_SECRET_ACCESS_KEY
```

**Description:** Generates kubeconfig using credentials from a Kubernetes secret specified by `auth_secret`.

---

### 2.5 Generic EKS (Fallback)

**Pattern:** `aws:cli@kubeconfig:{region}/{cluster_name}`

**Auth Type:** Any other EKS auth type

**Example:**
```yaml
secretsProvided:
  - name: kubeconfig
    workspaceKey: aws:cli@kubeconfig:ap-southeast-1/default-cluster
```

**Description:** Generic kubeconfig generation using AWS CLI for any other auth type.

---

## 3. Kubernetes Secret References

Used to reference keys within Kubernetes secrets.

### 3.1 Pattern

**Format:** `k8s:file@secret/{secret_name}:{key}`

**Components:**
- `secret_name`: Name of the Kubernetes secret
- `key`: Key within the secret data

### 3.2 AWS Credential Keys

**For AWS CLI operations:**
```yaml
k8s:file@secret/my-secret:awsAccessKeyId
k8s:file@secret/my-secret:awsSecretAccessKey
k8s:file@secret/my-secret:awsSessionToken  # Optional, for temporary credentials
```

**For EKS operations:**
```yaml
k8s:file@secret/my-secret:AWS_ACCESS_KEY_ID
k8s:file@secret/my-secret:AWS_SECRET_ACCESS_KEY
k8s:file@secret/my-secret:AWS_SESSION_TOKEN  # Optional
```

### 3.3 Examples

**Custom credentials secret (from workspaceInfo.yaml):**
```yaml
# In workspaceInfo.yaml
custom:
  aws_credentials_secret_name: prod-aws-creds

# Generated workspaceKey
k8s:file@secret/prod-aws-creds:awsAccessKeyId
```

**Auth secret (discovered during indexing):**
```yaml
# In cloudConfig
cloudConfig:
  aws:
    awsSecretName: dev-credentials

# Generated workspaceKey
k8s:file@secret/dev-credentials:awsAccessKeyId
```

---

## 4. Custom and Legacy Patterns

### 4.1 Custom Credential Key Override

**Pattern:** User-defined

**Configuration:**
```yaml
custom:
  aws_credentials_key: "my:custom@pattern"
```

**Example:**
```yaml
secretsProvided:
  - name: aws_credentials
    workspaceKey: "my:custom@pattern"
```

**Description:** Allows users to completely override the credential pattern.

---

### 4.2 Legacy Secrets Configuration

**Pattern:** User-defined

**Configuration:**
```yaml
secrets:
  aws_credentials: "legacy:format@secret"
```

**Example:**
```yaml
secretsProvided:
  - name: aws_credentials
    workspaceKey: "legacy:format@secret"
```

**Description:** Backwards compatibility for older configurations.

---

## 5. Complete Examples by Scenario

### Scenario 1: EKS Pod with IRSA (Recommended)

**Context:** RunWhen Local pod running in EKS with IRSA

**For AWS resources (S3, EC2, etc.):**
```yaml
secretsProvided:
  - name: aws_credentials
    workspaceKey: aws:irsa@cli
```

**For Kubernetes resources (same EKS cluster):**
```yaml
secretsProvided:
  - name: kubeconfig
    workspaceKey: aws:workload_identity@kubeconfig:us-east-1/my-cluster
```

---

### Scenario 2: Cross-Account Access with IRSA

**Context:** Access resources in a different AWS account

**Configuration:**
```yaml
secretsProvided:
  - name: aws_credentials
    workspaceKey: aws:irsa@cli
  - name: AWS_ROLE_ARN
    value: "arn:aws:iam::999999999999:role/CrossAccountRole"
```

---

### Scenario 3: Explicit Credentials from Secret

**Context:** Using static credentials stored in K8s secret

**For AWS resources:**
```yaml
secretsProvided:
  - name: aws_credentials
    workspaceKey: aws:access_key@cli
  - name: AWS_ACCESS_KEY_ID
    workspaceKey: k8s:file@secret/aws-creds:awsAccessKeyId
  - name: AWS_SECRET_ACCESS_KEY
    workspaceKey: k8s:file@secret/aws-creds:awsSecretAccessKey
```

**For EKS cluster:**
```yaml
secretsProvided:
  - name: kubeconfig
    workspaceKey: aws:cli@kubeconfig:us-east-1/prod-cluster
  - name: AWS_ACCESS_KEY_ID
    workspaceKey: k8s:file@secret/eks-creds:AWS_ACCESS_KEY_ID
  - name: AWS_SECRET_ACCESS_KEY
    workspaceKey: k8s:file@secret/eks-creds:AWS_SECRET_ACCESS_KEY
```

---

### Scenario 4: Base Credentials + Assume Role

**Context:** Use one set of credentials to assume a role

**Configuration:**
```yaml
secretsProvided:
  - name: aws_credentials
    workspaceKey: aws:assume_role@cli
  - name: AWS_ACCESS_KEY_ID
    workspaceKey: k8s:file@secret/base-creds:awsAccessKeyId
  - name: AWS_SECRET_ACCESS_KEY
    workspaceKey: k8s:file@secret/base-creds:awsSecretAccessKey
  - name: AWS_ROLE_ARN
    value: "arn:aws:iam::123456789012:role/TargetRole"
```

---

## 6. Implementation Guide for Codebundles

### Handling aws:irsa@cli

```python
# IRSA - Use boto3 default session (will automatically use IRSA)
import boto3
session = boto3.Session()
s3 = session.client('s3')
```

### Handling aws:access_key@cli

```python
# Explicit credentials from environment
import os
import boto3

session = boto3.Session(
    aws_access_key_id=os.environ['AWS_ACCESS_KEY_ID'],
    aws_secret_access_key=os.environ['AWS_SECRET_ACCESS_KEY']
)
s3 = session.client('s3')
```

### Handling aws:assume_role@cli

```python
# Assume role with base credentials
import os
import boto3

# Base session (could be IRSA, explicit, or default)
base_session = boto3.Session()
sts = base_session.client('sts')

# Assume target role
response = sts.assume_role(
    RoleArn=os.environ['AWS_ROLE_ARN'],
    RoleSessionName='codebundle-session'
)

# Create session with assumed role credentials
session = boto3.Session(
    aws_access_key_id=response['Credentials']['AccessKeyId'],
    aws_secret_access_key=response['Credentials']['SecretAccessKey'],
    aws_session_token=response['Credentials']['SessionToken']
)
```

### Handling aws:workload_identity@kubeconfig

```bash
# Generate EKS kubeconfig using IRSA
REGION="us-east-1"
CLUSTER="my-cluster"

# The aws CLI will use IRSA automatically
aws eks update-kubeconfig --name "$CLUSTER" --region "$REGION" --kubeconfig /tmp/kubeconfig

# Use the kubeconfig
export KUBECONFIG=/tmp/kubeconfig
kubectl get pods
```

### Handling aws:cli@kubeconfig

```bash
# Generate EKS kubeconfig using explicit credentials
REGION="us-east-1"
CLUSTER="my-cluster"

# Export credentials from secrets
export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}"
export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}"

# Generate kubeconfig
aws eks update-kubeconfig --name "$CLUSTER" --region "$REGION" --kubeconfig /tmp/kubeconfig

# Use the kubeconfig
export KUBECONFIG=/tmp/kubeconfig
kubectl get pods
```

---

## 7. Secret Key Naming Conventions

### AWS CLI Secrets (camelCase)

Used with `aws:access_key@cli`:
```yaml
awsAccessKeyId: "AKIA..."
awsSecretAccessKey: "..."
awsSessionToken: "..."  # Optional
```

### EKS Kubeconfig Secrets (UPPER_SNAKE_CASE)

Used with `aws:cli@kubeconfig`:
```yaml
AWS_ACCESS_KEY_ID: "AKIA..."
AWS_SECRET_ACCESS_KEY: "..."
AWS_SESSION_TOKEN: "..."  # Optional
```

### Why Different?

- **CLI secrets** follow boto3/Python conventions (camelCase)
- **Kubeconfig secrets** follow AWS CLI environment variable conventions (UPPER_SNAKE_CASE)
- Both are supported for maximum compatibility

---

## 8. Quick Reference Table

| Auth Type | AWS Resources | EKS Kubeconfig | Additional Secrets |
|-----------|--------------|----------------|-------------------|
| `aws_workload_identity` | `aws:irsa@cli` | `aws:workload_identity@kubeconfig:{region}/{cluster}` | None |
| `aws_explicit` | `aws:access_key@cli` | `aws:cli@kubeconfig:{region}/{cluster}` | `k8s:file@secret/{name}:awsAccessKeyId`<br>`k8s:file@secret/{name}:awsSecretAccessKey` |
| `aws_secret` | `aws:access_key@cli` | `aws:cli@kubeconfig:{region}/{cluster}` | `k8s:file@secret/{auth_secret}:awsAccessKeyId`<br>`k8s:file@secret/{auth_secret}:awsSecretAccessKey` |
| `aws_assume_role` | `aws:assume_role@cli` | N/A | `aws_role_arn` (value) |
| `aws_explicit_assume_role` | `aws:assume_role@cli` | N/A | `k8s:file@secret/{name}:awsAccessKeyId`<br>`k8s:file@secret/{name}:awsSecretAccessKey`<br>`AWS_ROLE_ARN` (value) |
| `aws_secret_assume_role` | `aws:assume_role@cli` | N/A | `k8s:file@secret/{auth_secret}:awsAccessKeyId`<br>`k8s:file@secret/{auth_secret}:awsSecretAccessKey`<br>`AWS_ROLE_ARN` (value) |
| `aws_workload_identity_assume_role` | `aws:irsa@cli` | N/A | `AWS_ROLE_ARN` (value) |
| `aws_default_chain` | `aws:default@cli` | N/A | None |

---

## 9. Variable Substitution Patterns

When implementing workspaceKey handlers, watch for these template variables:

```yaml
# Custom secret name (from workspaceInfo.yaml custom section)
{{ custom.aws_credentials_secret_name }}

# Auth secret name (from discovery/indexing)
{{ cluster.auth_secret }}
{{ match_resource.auth_secret }}

# Cluster metadata
{{ cluster.region }}
{{ cluster.cluster_name }}

# Assume role ARN
{{ cluster.assume_role_arn }}
{{ match_resource.assume_role_arn }}
```

---

## Summary

All AWS workspaceKey patterns follow these conventions:

1. **Provider prefix**: `aws:` for AWS auth, `k8s:` for Kubernetes secrets
2. **Method**: Describes auth mechanism (`irsa`, `access_key`, `assume_role`, `cli`, `workload_identity`, `default`)
3. **Type**: Resource type (`cli` for AWS APIs, `kubeconfig` for EKS clusters, `secret` for K8s secrets)
4. **Parameters**: Optional context (region/cluster for EKS, secret name/key for K8s secrets)

This design allows codebundles to parse the workspaceKey and determine exactly how to authenticate to AWS services.
